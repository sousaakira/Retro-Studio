0001   0000             ; eXtended Genesis Music (XGM) Z80 driver - Stï¿½phane Dallongeville @2014-2016
0002   0000             ;
0003   0000             ; XGM is a music format dedicated to the Sega Megadrive/Genesis system.
0004   0000             ; It has been designed to minimize CPU decoding resource and keep reasonable data size (should be smaller than VGM file).
0005   0000             ; It supports both FM and PSG chip and allow up to 4 PCM channels (8 bits signed at 14 Khz) to be played at once.
0006   0000             ; These 4 PCM channels are obtained by software mixing in the FM DAC in replacement of the 6th FM channel (so at best you can have 5FM + 4PCM + 4PSG = 13 channels)
0007   0000             ;
0008   0000             ; The driver supports playing SFX in PCM format with 16 priority levels.
0009   0000             ; PCM samples can be >32KB but with the restriction of having their address and size aligned on 256 bytes.
0010   0000             ;
0011   0000             ; we have to do 254 cycles per sample output which consist of :
0012   0000             ; - bufferize 4 PCM samples from the rom and mix them in write buffer
0013   0000             ; - read 1 sample from read buffer and output it to the DAC
0014   0000             ; - handle loop
0015   0000             ; - bufferize XGM data / parse and apply XGM command / handle extern command
0016   0000             ;
0017   0000             ; register usage :
0018   0000             ; HL  = sample source (in ROM)
0019   0000             ; DE  = write buffer / XGM buffer
0020   0000             ; BC  = counter
0021   0000             ; C = $80 (used for overflow and sample unsign)
0022   0000             ; IYH = temp value
0023   0000             ; HL' = YMPORT1
0024   0000             ; BC' = read buffer
0025   0000             
0026   0000             ; ###########################      define      ##############################
0027   0000             
0028   0000                         INCLUDE "z80_def.i80"   ; basic definitions
0001+  0000             ; ############################ define ##############################
0002+  0000             
0003+  0000             YMPORT0     EQU     $4000           ; YM2612 port 0
0004+  0000             YMPORT1     EQU     $4001           ; YM2612 port 1
0005+  0000             YMPORT2     EQU     $4002           ; YM2612 port 2
0006+  0000             YMPORT3     EQU     $4003           ; YM2612 port 3
0007+  0000             VDPSTATUS_H EQU     $7F04           ; VDP status port high
0008+  0000             VDPSTATUS_L EQU     $7F05           ; VDP status port low
0009+  0000             VCOUNTER    EQU     $7F08           ; V counter
0010+  0000             HCOUNTER    EQU     $7F09           ; H counter
0011+  0000             PSGPORT     EQU     $7F11           ; PSG port
0012+  0000             BANKREG     EQU     $6000           ; bank register
0013+  0000             
0014+  0000             COMPLAY_SFT EQU     0               ; start play command
0015+  0000             COMSTOP_SFT EQU     4               ; stop play command
0016+  0000             
0017+  0000             STATPLAY_SFT  EQU   0               ; playing status
0018+  0000             STATREADY_SFT EQU   7               ; driver ready status
0019+  0000             
0020+  0000             CH0_SFT     EQU     0               ; channel 0
0021+  0000             CH1_SFT     EQU     1               ; channel 1
0022+  0000             CH2_SFT     EQU     2               ; channel 2
0023+  0000             CH3_SFT     EQU     3               ; channel 3
0024+  0000             
0025+  0000             COMPLAY     EQU     1<<COMPLAY_SFT
0026+  0000             COMSTOP     EQU     1<<COMSTOP_SFT
0027+  0000             
0028+  0000             STATPLAY    EQU     1<<STATPLAY_SFT
0029+  0000             STATREADY   EQU     1<<STATREADY_SFT
0030+  0000             
0031+  0000             CH0         EQU     1<<CH0_SFT
0032+  0000             CH1         EQU     1<<CH1_SFT
0033+  0000             CH2         EQU     1<<CH2_SFT
0034+  0000             CH3         EQU     1<<CH3_SFT
0035+  0000             
0036+  0000             
0037+  0000             ; ########################### variable #############################
0038+  0000             
0039+  0000             COMMAND     EQU     $0100           ; command from 68K
0040+  0000             STATUS      EQU     $0102           ; status from Z80
0041+  0000             PARAMS      EQU     $0104           ; parameters (68K and Z80)
0029   0000             
0030   0000             
0031   0000             ; ###########################       var        ##############################
0032   0000             
0033   0000             XGM_PLAY_SFT    EQU     6           ; XGM music play command bit
0034   0000             XGM_RESUME_SFT  EQU     5           ; XGM music resume command bit
0035   0000             XGM_PAUSE_SFT   EQU     4           ; XGM music pause command bit
0036   0000             
0037   0000                                                 ; COMMAND b0 = play PCM0   STATUS b0 = PCM0 playing
0038   0000                                                 ; COMMAND b1 = play PCM1   STATUS b1 = PCM1 playing
0039   0000                                                 ; COMMAND b2 = play PCM2   STATUS b2 = PCM2 playing
0040   0000                                                 ; COMMAND b3 = play PCM3   STATUS b3 = PCM3 playing
0041   0000                                                 ; COMMAND b4 = stop XGM
0042   0000                                                 ; COMMAND b5 = resume XGM
0043   0000                                                 ; COMMAND b6 = play XGM    STATUS b6 = XGM playing
0044   0000             
0045   0000             XGM_ARG_A   EQU     PARAMS+$00      ; XGM address (bit 0 --> bit 23)
0046   0000             
0047   0000             PCM0_ARG_P  EQU     PARAMS+$04      ; priority (0 to 15)
0048   0000             PCM0_ARG_ID EQU     PARAMS+$05      ; PCM id (0 to 255)
0049   0000             PCM1_ARG_P  EQU     PARAMS+$06      ; priority (0 to 15)
0050   0000             PCM1_ARG_ID EQU     PARAMS+$07      ; PCM id (0 to 255)
0051   0000             PCM2_ARG_P  EQU     PARAMS+$08      ; priority (0 to 15)
0052   0000             PCM2_ARG_ID EQU     PARAMS+$09      ; PCM id (0 to 255)
0053   0000             PCM3_ARG_P  EQU     PARAMS+$0A      ; priority (0 to 15)
0054   0000             PCM3_ARG_ID EQU     PARAMS+$0B      ; PCM id (0 to 255)
0055   0000             
0056   0000             PCM_ARG_P   EQU     PCM0_ARG_P
0057   0000             PCM_ARG_ID  EQU     PCM0_ARG_ID
0058   0000             
0059   0000             LOOP_ARG    EQU     PARAMS+$0C      ; number of loop (0 = 255 loop)
0060   0000             PROTECT_ARG EQU     PARAMS+$0D      ; set to 1 from 68k during DMA (in vblank period)
0061   0000                                                 ; to prevent Z80 accessing 68k BUS
0062   0000             
0063   0000             MODIFYING_F EQU     PARAMS+$0E      ; Z80 is modifying the 'PENDING_FRM' variable
0064   0000             PENDING_FRM EQU     PARAMS+$0F      ; contains number of XGM frame to process
0065   0000             
0066   0000             PCM0_PRIO   EQU     PARAMS+$10      ; PCM0 internal priority
0067   0000             PCM0_ADDR   EQU     PARAMS+$12      ; PCM0 internal addr (bit8 --> bit23)
0068   0000             PCM0_LEN    EQU     PARAMS+$14      ; PCM0 internal len (bit8 --> bit23)
0069   0000             PCM1_PRIO   EQU     PARAMS+$18      ; PCM1 internal priority
0070   0000             PCM1_ADDR   EQU     PARAMS+$1A      ; PCM1 internal addr (bit8 --> bit23)
0071   0000             PCM1_LEN    EQU     PARAMS+$1C      ; PCM1 internal len (bit8 --> bit23)
0072   0000             PCM2_PRIO   EQU     PARAMS+$20      ; PCM2 internal priority
0073   0000             PCM2_ADDR   EQU     PARAMS+$22      ; PCM2 internal addr (bit8 --> bit23)
0074   0000             PCM2_LEN    EQU     PARAMS+$24      ; PCM2 internal len (bit8 --> bit23)
0075   0000             PCM3_PRIO   EQU     PARAMS+$28      ; PCM3 internal priority
0076   0000             PCM3_ADDR   EQU     PARAMS+$2A      ; PCM3 internal addr (bit8 --> bit23)
0077   0000             PCM3_LEN    EQU     PARAMS+$2C      ; PCM3 internal len (bit8 --> bit23)
0078   0000             
0079   0000             PCM_PRIO    EQU     PCM0_PRIO
0080   0000             PCM_ADDR    EQU     PCM0_ADDR
0081   0000             PCM_LEN     EQU     PCM0_LEN
0082   0000             
0083   0000             XGM_ADDR    EQU     PARAMS+$30      ; XGM internal addr (bit0 --> bit23)
0084   0000             
0085   0000             WRITEBUF    EQU     PARAMS+$34      ; PCM write buffer pointer (bit8 --> bit9)
0086   0000             READBUF     EQU     PARAMS+$36      ; PCM read buffer pointer (bit8 --> bit9)
0087   0000             
0088   0000             REM_LOOP    EQU     PARAMS+$38      ; remaining loop (0 = 255)
0089   0000             
0090   0000             YM_RR_SAV   EQU     PARAMS+$40      ; YM RR save (4 slots * 6 channels)
0091   0000             PSG_ENV_SAV EQU     PARAMS+$58      ; PSG env save (4 channels)
0092   0000             YM_RR_OFF   EQU     PARAMS+$60      ; YM RR off (4 slots * 6 channels)
0093   0000             PSG_ENV_OFF EQU     PARAMS+$78      ; PSG env off (4 channels)
0094   0000             
0095   0000             YM_2B_SAV   EQU     PARAMS+$5C      ; YM register $2B last write save
0096   0000             YM_2B_CNT   EQU     PARAMS+$5D      ; YM register $2B ON expiration
0097   0000             
0098   0000             IDLE_LOOP   EQU     PARAMS+$7C      ; idle loop counter (XGM frame wait)
0099   0000             WAIT_LOOP   EQU     PARAMS+$7E      ; wait loop counter (DMA contention wait)
0100   0000             
0101   0000             DEBUG_1     EQU     PARAMS+$80      ; debug
0102   0000             DEBUG_2     EQU     PARAMS+$81      ; debug
0103   0000             DEBUG_3     EQU     PARAMS+$82      ; debug
0104   0000             DEBUG_4     EQU     PARAMS+$83      ; debug
0105   0000             DEBUG_5     EQU     PARAMS+$84      ; debug
0106   0000             DEBUG_6     EQU     PARAMS+$85      ; debug
0107   0000             DEBUG_7     EQU     PARAMS+$86      ; debug
0108   0000             DEBUG_8     EQU     PARAMS+$87      ; debug
0109   0000             DEBUG_9     EQU     PARAMS+$88      ; debug
0110   0000             DEBUG_A     EQU     PARAMS+$89      ; debug
0111   0000             DEBUG_B     EQU     PARAMS+$8A      ; debug
0112   0000             
0113   0000             ELAPSED     EQU     PARAMS+$90      ; elapsed frame since beginning of music (in frames), encoded on 24 bit
0114   0000             
0115   0000             JUMP_TABLE  EQU     $1600           ; XGM command jump table (size = $100)
0116   0000             XGM_BUFFER  EQU     $1700           ; XGM music data buffer (size = $100)
0117   0000             
0118   0000             PCM_BUFFER0 EQU     $1800           ; PCM buffer 0
0119   0000             PCM_BUFFER1 EQU     $1900           ; PCM buffer 1
0120   0000             PCM_BUFFER2 EQU     $1A00           ; PCM buffer 2
0121   0000             PCM_BUFFER3 EQU     $1B00           ; PCM buffer 3
0122   0000             
0123   0000             PCM_BUFFER  EQU     PCM_BUFFER0     ; PCM buffer
0124   0000             
0125   0000             
0126   0000             ID_TABLE    EQU     $1C00           ; sample id table (size = $400)
0127   0000             
0128   0000             STACK       EQU     JUMP_TABLE      ; stack pointer above buffer region ($1600 --> $15XX)
0129   0000             
0130   0000             
0131   0000             ; ###########################      macro       ##############################
0132   0000             
0133   0000                         INCLUDE "z80_mac.i80"  ; basic macros
0001+  0000             ; ############################     macro     ##############################
0002+  0000             
0003+  0000             
0004+  0000             ; setBank
0005+  0000             ; -------
0006+  0000             ; A    -> bit 22-15 of rom address to set in the bank register
0007+  0000             ; HL  <-  BANKREG
0008+  0000             ;
0009+  0000             ; set the bank register for ROM area
0010+  0000             ; = 101 cycles
0011+  0000             
0012+  0000                         macro   setBank
0013+  0000~            
0014+  0000~                        LD  HL, BANKREG         ; HL = BANKREG              ' 10
0015+  0000~                        LD  (HL), A             ; #1 (bit 15)               ' 7
0016+  0000~                        RRCA                     ;                          ' 4
0017+  0000~                        LD  (HL), A             ; #2 (bit 16)               ' 7
0018+  0000~                        RRCA                     ;                          ' 4
0019+  0000~                        LD  (HL), A             ; #3 (bit 17)               ' 7
0020+  0000~                        RRCA                     ;                          ' 4
0021+  0000~                        LD  (HL), A             ; #4 (bit 18)               ' 7
0022+  0000~                        RRCA                     ;                          ' 4
0023+  0000~                        LD  (HL), A             ; #5 (bit 19)               ' 7
0024+  0000~                        RRCA                     ;                          ' 4
0025+  0000~                        LD  (HL), A             ; #6 (bit 20)               ' 7
0026+  0000~                        RRCA                     ;                          ' 4
0027+  0000~                        LD  (HL), A             ; #7 (bit 21)               ' 7
0028+  0000~                        RRCA                     ;                          ' 4
0029+  0000~                        LD  (HL), A             ; #8 (bit 22)               ' 7
0030+  0000~                        LD  (HL), L             ; #9 (bit 23 = 0)           ' 7
0031+  0000~            
0032+  0000                         endm                    ;                           ' 101
0033+  0000             
0034+  0000             
0035+  0000             ; setBankFast
0036+  0000             ; -----------
0037+  0000             ; A    -> bit 21-15 of rom address to set in the bank register
0038+  0000             ; HL  <-  BANKREG
0039+  0000             ;
0040+  0000             ; set the bank register for ROM area
0041+  0000             ; = 97 cycles
0042+  0000             
0043+  0000                         macro   setBankFast
0044+  0000~            
0045+  0000~                        LD  HL, BANKREG         ; HL = BANKREG              ' 10
0046+  0000~                        LD  (HL), A             ; #1 (bit 15)               ' 7
0047+  0000~                        RRCA                     ;                          ' 4
0048+  0000~                        LD  (HL), A             ; #2 (bit 16)               ' 7
0049+  0000~                        RRCA                     ;                          ' 4
0050+  0000~                        LD  (HL), A             ; #3 (bit 17)               ' 7
0051+  0000~                        RRCA                     ;                          ' 4
0052+  0000~                        LD  (HL), A             ; #4 (bit 18)               ' 7
0053+  0000~                        RRCA                     ;                          ' 4
0054+  0000~                        LD  (HL), A             ; #5 (bit 19)               ' 7
0055+  0000~                        RRCA                     ;                          ' 4
0056+  0000~                        LD  (HL), A             ; #6 (bit 20)               ' 7
0057+  0000~                        RRCA                     ;                          ' 4
0058+  0000~                        LD  (HL), A             ; #7 (bit 21)               ' 7
0059+  0000~                        LD  (HL), L             ; #8 (bit 22 = 0)           ' 7
0060+  0000~                        LD  (HL), L             ; #9 (bit 23 = 0)           ' 7
0061+  0000~            
0062+  0000                         endm                    ;                           ' 97
0063+  0000             
0064+  0000             
0065+  0000             ; setBank_BC
0066+  0000             ; ----------
0067+  0000             ; A    -> bit 22-15 of rom address to set in the bank register
0068+  0000             ; BC  <-  BANKREG
0069+  0000             ; A   <-  0
0070+  0000             ;
0071+  0000             ; set the bank register for ROM area
0072+  0000             ; = 105 cycles
0073+  0000             
0074+  0000                         macro   setBank_BC
0075+  0000~            
0076+  0000~                        LD  BC, BANKREG         ; BC = BANKREG              ' 10
0077+  0000~                        LD  (BC), A             ; #1 (bit 15)               ' 7
0078+  0000~                        RRCA                     ;                          ' 4
0079+  0000~                        LD  (BC), A             ; #2 (bit 16)               ' 7
0080+  0000~                        RRCA                     ;                          ' 4
0081+  0000~                        LD  (BC), A             ; #3 (bit 17)               ' 7
0082+  0000~                        RRCA                     ;                          ' 4
0083+  0000~                        LD  (BC), A             ; #4 (bit 18)               ' 7
0084+  0000~                        RRCA                     ;                          ' 4
0085+  0000~                        LD  (BC), A             ; #5 (bit 19)               ' 7
0086+  0000~                        RRCA                     ;                          ' 4
0087+  0000~                        LD  (BC), A             ; #6 (bit 20)               ' 7
0088+  0000~                        RRCA                     ;                          ' 4
0089+  0000~                        LD  (BC), A             ; #7 (bit 21)               ' 7
0090+  0000~                        RRCA                     ;                          ' 4
0091+  0000~                        LD  (BC), A             ; #8 (bit 22)               ' 7
0092+  0000~                        XOR A                    ;                          ' 4
0093+  0000~                        LD  (BC), A             ; #9 (bit 23 = 0)           ' 7
0094+  0000~            
0095+  0000                         endm                    ;                           ' 105
0096+  0000             
0097+  0000             
0098+  0000             ; setBank_DE
0099+  0000             ; ----------
0100+  0000             ; A    -> bit 22-15 of rom address to set in the bank register
0101+  0000             ; DE  <-  BANKREG
0102+  0000             ; A   <-  0
0103+  0000             ;
0104+  0000             ; set the bank register for ROM area
0105+  0000             ; = 105 cycles
0106+  0000             
0107+  0000                         macro   setBank_DE
0108+  0000~            
0109+  0000~                        LD  DE, BANKREG         ; DE = BANKREG              ' 10
0110+  0000~                        LD  (DE), A             ; #1 (bit 15)               ' 7
0111+  0000~                        RRCA                     ;                          ' 4
0112+  0000~                        LD  (DE), A             ; #2 (bit 16)               ' 7
0113+  0000~                        RRCA                     ;                          ' 4
0114+  0000~                        LD  (DE), A             ; #3 (bit 17)               ' 7
0115+  0000~                        RRCA                     ;                          ' 4
0116+  0000~                        LD  (DE), A             ; #4 (bit 18)               ' 7
0117+  0000~                        RRCA                     ;                          ' 4
0118+  0000~                        LD  (DE), A             ; #5 (bit 19)               ' 7
0119+  0000~                        RRCA                     ;                          ' 4
0120+  0000~                        LD  (DE), A             ; #6 (bit 20)               ' 7
0121+  0000~                        RRCA                     ;                          ' 4
0122+  0000~                        LD  (DE), A             ; #7 (bit 21)               ' 7
0123+  0000~                        RRCA                     ;                          ' 4
0124+  0000~                        LD  (DE), A             ; #8 (bit 22)               ' 7
0125+  0000~                        XOR A                    ;                          ' 4
0126+  0000~                        LD  (DE), A             ; #9 (bit 23 = 0)           ' 7
0127+  0000~            
0128+  0000                         endm                    ;                           ' 105
0129+  0000             
0130+  0000             
0131+  0000             ; writeYMFast
0132+  0000             ; -----------
0133+  0000             ; HL  <-> YM port where to write
0134+  0000             ; D    -> address
0135+  0000             ; E    -> value
0136+  0000             ;
0137+  0000             ; write to YM2612 (no busy check)
0138+  0000             ; = 18 cycles
0139+  0000             
0140+  0000                         macro   writeYMFast
0141+  0000~            
0142+  0000~                        LD      (HL), D         ; write address             ' 7     |
0143+  0000~                        INC     L               ; next port                 ' 4     | 18
0144+  0000~                        LD      (HL), E         ; write value               ' 7     |
0145+  0000~            
0146+  0000                         endm
0147+  0000             
0148+  0000             
0149+  0000             
0150+  0000             ; getPlayCommand
0151+  0000             ; --------------
0152+  0000             ; HL  <-  point to COMMAND
0153+  0000             ; zf  <-  channel 'ch' play command
0154+  0000             ;
0155+  0000             ; Z flag reset if play command for channel 'ch'
0156+  0000             ; = 22 cycles
0157+  0000             
0158+  0000                         macro   getPlayCommand ch
0159+  0000~            
0160+  0000~                        LD      HL, COMMAND             ;                   ' 10
0161+  0000~                        BIT     COMPLAY_SFT+ch, (HL)    ; play command ?    ' 12
0162+  0000~            
0163+  0000                         endm                            ;                   ' 22
0164+  0000             
0165+  0000             
0166+  0000             ; getStopCommand
0167+  0000             ; --------------
0168+  0000             ; HL  <-  point to COMMAND
0169+  0000             ; zf  <-  channel 'ch' stop command
0170+  0000             ;
0171+  0000             ; Z flag reset if stop command for channel 'ch'
0172+  0000             ; = 22 cycles
0173+  0000             
0174+  0000                         macro   getStopCommand ch
0175+  0000~            
0176+  0000~                        LD      HL, COMMAND             ;                   ' 10
0177+  0000~                        BIT     COMSTOP_SFT+ch, (HL)    ; stop command ?    ' 12
0178+  0000~            
0179+  0000                         endm                            ;                   ' 22
0180+  0000             
0181+  0000             
0182+  0000             ; setPlayCommand
0183+  0000             ; ----------------
0184+  0000             ; HL  <-  point to COMMAND
0185+  0000             ;
0186+  0000             ; set the play command for channel 'ch'
0187+  0000             ; = 25 cycles
0188+  0000             
0189+  0000                         macro   setPlayCommand ch
0190+  0000~            
0191+  0000~                        LD      HL, COMMAND             ;                   ' 10
0192+  0000~                        SET     COMPLAY_SFT+ch, (HL)    ; set command       ' 15
0193+  0000~            
0194+  0000                         endm                            ;                   ' 25
0195+  0000             
0196+  0000             
0197+  0000             ; setStopCommand
0198+  0000             ; ----------------
0199+  0000             ; HL  <-  point to COMMAND
0200+  0000             ;
0201+  0000             ; set the stop command for channel 'ch'
0202+  0000             ; = 25 cycles
0203+  0000             
0204+  0000                         macro   setStopCommand ch
0205+  0000~            
0206+  0000~                        LD      HL, COMMAND             ;                   ' 10
0207+  0000~                        SET     COMSTOP_SFT+ch, (HL)    ; set command       ' 15
0208+  0000~            
0209+  0000                         endm                            ;                   ' 25
0210+  0000             
0211+  0000             
0212+  0000             ; clearPlayCommand
0213+  0000             ; ----------------
0214+  0000             ; HL  <-  point to COMMAND
0215+  0000             ;
0216+  0000             ; clear the play command for channel 'ch'
0217+  0000             ; = 25 cycles
0218+  0000             
0219+  0000                         macro   clearPlayCommand ch
0220+  0000~            
0221+  0000~                        LD      HL, COMMAND             ;                   ' 10
0222+  0000~                        RES     COMPLAY_SFT+ch, (HL)    ; clear command     ' 15
0223+  0000~            
0224+  0000                         endm                            ;                   ' 25
0225+  0000             
0226+  0000             
0227+  0000             ; clearStopCommand
0228+  0000             ; ----------------
0229+  0000             ; HL  <-  point to COMMAND
0230+  0000             ;
0231+  0000             ; clear the stop command for channel 'ch'
0232+  0000             ; = 25 cycles
0233+  0000             
0234+  0000                         macro   clearStopCommand ch
0235+  0000~            
0236+  0000~                        LD      HL, COMMAND             ;                   ' 10
0237+  0000~                        RES     COMSTOP_SFT+ch, (HL)    ; clear command     ' 15
0238+  0000~            
0239+  0000                         endm                            ;                   ' 25
0240+  0000             
0241+  0000             
0242+  0000             ; getPlayStatus
0243+  0000             ; -------------
0244+  0000             ; HL  <- point to STATUS
0245+  0000             ; zf  <-  channel 'ch' is playing
0246+  0000             ;
0247+  0000             ; Z flag reset if play status for channel 'ch'
0248+  0000             ; = 22 cycles
0249+  0000             
0250+  0000                         macro   getPlayStatus ch
0251+  0000~            
0252+  0000~                        LD      HL, STATUS              ;                   ' 10
0253+  0000~                        BIT     STATPLAY_SFT+ch, (HL)   ; get status        ' 12
0254+  0000~            
0255+  0000                         endm                            ;                   ' 22
0256+  0000             
0257+  0000             
0258+  0000             ; setPlayStatus
0259+  0000             ; -------------
0260+  0000             ; HL  <- point to STATUS
0261+  0000             ;
0262+  0000             ; set the play status for channel 'ch'
0263+  0000             ; = 25 cycles
0264+  0000             
0265+  0000                         macro   setPlayStatus ch
0266+  0000~            
0267+  0000~                        LD      HL, STATUS              ;                   ' 10
0268+  0000~                        SET     STATPLAY_SFT+ch, (HL)   ; set status        ' 15
0269+  0000~            
0270+  0000                         endm                            ;                   ' 25
0271+  0000             
0272+  0000             
0273+  0000             ; clearPlayStatus
0274+  0000             ; ---------------
0275+  0000             ; HL  <- point to STATUS
0276+  0000             ;
0277+  0000             ; clear play status for channel 'ch'
0278+  0000             ; = 25 cycles
0279+  0000             
0280+  0000                         macro   clearPlayStatus ch
0281+  0000~            
0282+  0000~                        LD      HL, STATUS              ;                   ' 10
0283+  0000~                        RES     STATPLAY_SFT+ch, (HL)   ; clear status      ' 15
0284+  0000~            
0285+  0000                         endm                            ;                   ' 25
0286+  0000             
0287+  0000             
0288+  0000             ; getLoopStatus
0289+  0000             ; -------------
0290+  0000             ; HL  <- point to STATUS+1
0291+  0000             ; zf  <-  channel 'ch' is playing
0292+  0000             ;
0293+  0000             ; Z flag reset if loop status for channel 'ch'
0294+  0000             ; = 22 cycles
0295+  0000             
0296+  0000                         macro   getLoopStatus ch
0297+  0000~            
0298+  0000~                        LD      HL, STATUS+1            ;                   ' 10
0299+  0000~                        BIT     STATPLAY_SFT+ch, (HL)   ; get status        ' 12
0300+  0000~            
0301+  0000                         endm                            ;                   ' 22
0302+  0000             
0303+  0000             
0304+  0000             ; setLoopStatus
0305+  0000             ; -------------
0306+  0000             ; HL  <- point to STATUS+1
0307+  0000             ;
0308+  0000             ; set the loop status for channel 'ch'
0309+  0000             ; = 25 cycles
0310+  0000             
0311+  0000                         macro   setLoopStatus ch
0312+  0000~            
0313+  0000~                        LD      HL, STATUS+1            ;                   ' 10
0314+  0000~                        SET     STATPLAY_SFT+ch, (HL)   ; set status        ' 15
0315+  0000~            
0316+  0000                         endm                            ;                   ' 25
0317+  0000             
0318+  0000             
0319+  0000             ; clearLoopStatus
0320+  0000             ; ---------------
0321+  0000             ; HL  <- point to STATUS+1
0322+  0000             ;
0323+  0000             ; clear loop status for channel 'ch'
0324+  0000             ; = 25 cycles
0325+  0000             
0326+  0000                         macro   clearLoopStatus ch
0327+  0000~            
0328+  0000~                        LD      HL, STATUS+1            ;                   ' 10
0329+  0000~                        RES     STATPLAY_SFT+ch, (HL)   ; clear status      ' 15
0330+  0000~            
0331+  0000                         endm                            ;                   ' 25
0332+  0000             
0333+  0000             
0334+  0000             ; clearAllStatus
0335+  0000             ; --------------
0336+  0000             ; HL  <- 0
0337+  0000             ;
0338+  0000             ; clear play and loop status for all channel
0339+  0000             ; = 26 cycles
0340+  0000             
0341+  0000                         macro   clearAllStatus
0342+  0000~            
0343+  0000~                        LD      HL, $00                 ;                   ' 10
0344+  0000~                        LD      (STATUS), HL            ; clear status      ' 16
0345+  0000~            
0346+  0000                         endm                            ;                   ' 26
0347+  0000             
0348+  0000             
0349+  0000             ; ############################  macro wait macro  ##############################
0350+  0000             
0351+  0000             
0352+  0000             ; wait2p16x
0353+  0000             ; ---------
0354+  0000             ; wait for ((w * 16) + 2) cycles
0355+  0000             ;
0356+  0000                         macro   wait2p16x w
0357+  0000~            
0358+  0000~                        LD      A, w            ; 7-2
0359+  0000~            .loop
0360+  0000~                        DEC     A               ; 4
0361+  0000~                        JR      NZ, .loop       ; 12
0362+  0000~            
0363+  0000                         endm
0364+  0000             
0365+  0000             
0366+  0000                         macro   wait4
0367+  0000~                        NOP
0368+  0000                         endm
0369+  0000             
0370+  0000                         macro   wait6
0371+  0000~                        INC     DE
0372+  0000                         endm
0373+  0000             
0374+  0000                         macro   wait7
0375+  0000~                        OR      $0
0376+  0000                         endm
0377+  0000             
0378+  0000                         macro   wait8
0379+  0000~                        wait4
0380+  0000~                        wait4
0381+  0000                         endm
0382+  0000             
0383+  0000                         macro   wait9
0384+  0000~                        LD      R, A
0385+  0000                         endm
0386+  0000             
0387+  0000                         macro   wait10
0388+  0000~                        JP      .go
0389+  0000~            .go
0390+  0000                         endm
0391+  0000             
0392+  0000                         macro   wait11
0393+  0000~                        wait7
0394+  0000~                        wait4
0395+  0000                         endm
0396+  0000             
0397+  0000                         macro   wait12
0398+  0000~                        JR      .go
0399+  0000~            .go
0400+  0000                         endm
0401+  0000             
0402+  0000                         macro   wait13
0403+  0000~                        wait9
0404+  0000~                        wait4
0405+  0000                         endm
0406+  0000             
0407+  0000                         macro   wait14
0408+  0000~                        wait7
0409+  0000~                        wait7
0410+  0000                         endm
0411+  0000             
0412+  0000                         macro   wait15
0413+  0000~                        wait8
0414+  0000~                        wait7
0415+  0000                         endm
0416+  0000             
0417+  0000                         macro   wait16
0418+  0000~                        wait12
0419+  0000~                        wait4
0420+  0000                         endm
0421+  0000             
0422+  0000                         macro   wait17
0423+  0000~                        wait10
0424+  0000~                        wait7
0425+  0000                         endm
0426+  0000             
0427+  0000                         macro   wait18
0428+  0000~                        wait9
0429+  0000~                        wait9
0430+  0000                         endm
0431+  0000             
0432+  0000                         macro   wait19
0433+  0000~                        wait12
0434+  0000~                        wait7
0435+  0000                         endm
0436+  0000             
0437+  0000                         macro   wait20
0438+  0000~                        wait11
0439+  0000~                        wait9
0440+  0000                         endm
0441+  0000             
0442+  0000                         macro   wait21
0443+  0000~                        wait12
0444+  0000~                        wait9
0445+  0000                         endm
0446+  0000             
0447+  0000                         macro   wait22
0448+  0000~                        wait18
0449+  0000~                        wait4
0450+  0000                         endm
0451+  0000             
0452+  0000                         macro   wait23
0453+  0000~                        wait14
0454+  0000~                        wait9
0455+  0000                         endm
0456+  0000             
0457+  0000                         macro   wait24
0458+  0000~                        wait12
0459+  0000~                        wait12
0460+  0000                         endm
0461+  0000             
0462+  0000                         macro   wait25
0463+  0000~                        wait21
0464+  0000~                        wait4
0465+  0000                         endm
0466+  0000             
0467+  0000                         macro   wait26
0468+  0000~                        wait18
0469+  0000~                        wait8
0470+  0000                         endm
0471+  0000             
0472+  0000                         macro   wait27
0473+  0000~                        wait18
0474+  0000~                        wait9
0475+  0000                         endm
0476+  0000             
0477+  0000                         macro   wait28
0478+  0000~                        wait21
0479+  0000~                        wait7
0480+  0000                         endm
0481+  0000             
0482+  0000                         macro   wait29
0483+  0000~                        wait21
0484+  0000~                        wait8
0485+  0000                         endm
0486+  0000             
0487+  0000                         macro   wait30
0488+  0000~                        wait21
0489+  0000~                        wait9
0490+  0000                         endm
0491+  0000             
0492+  0000                         macro   wait31
0493+  0000~                        wait21
0494+  0000~                        wait10
0495+  0000                         endm
0496+  0000             
0497+  0000                         macro   wait32
0498+  0000~                        wait20
0499+  0000~                        wait12
0500+  0000                         endm
0501+  0000             
0502+  0000                         macro   wait33
0503+  0000~                        wait21
0504+  0000~                        wait12
0505+  0000                         endm
0506+  0000             
0507+  0000                         macro   wait34
0508+  0000~                        wait2p16x 2
0509+  0000                         endm
0510+  0000             
0511+  0000                         macro   wait35
0512+  0000~                        wait28
0513+  0000~                        wait7
0514+  0000                         endm
0515+  0000             
0516+  0000                         macro   wait36
0517+  0000~                        wait27
0518+  0000~                        wait9
0519+  0000                         endm
0520+  0000             
0521+  0000                         macro   wait37
0522+  0000~                        wait28
0523+  0000~                        wait9
0524+  0000                         endm
0525+  0000             
0526+  0000                         macro   wait38
0527+  0000~                        wait24
0528+  0000~                        wait14
0529+  0000                         endm
0530+  0000             
0531+  0000                         macro   wait39
0532+  0000~                        wait27
0533+  0000~                        wait12
0534+  0000                         endm
0535+  0000             
0536+  0000                         macro   wait40
0537+  0000~                        wait27
0538+  0000~                        wait13
0539+  0000                         endm
0540+  0000             
0541+  0000                         macro   wait41
0542+  0000~                        wait34
0543+  0000~                        wait7
0544+  0000                         endm
0545+  0000             
0546+  0000                         macro   wait42
0547+  0000~                        wait34
0548+  0000~                        wait8
0549+  0000                         endm
0550+  0000             
0551+  0000                         macro   wait43
0552+  0000~                        wait36
0553+  0000~                        wait7
0554+  0000                         endm
0555+  0000             
0556+  0000                         macro   wait44
0557+  0000~                        wait34
0558+  0000~                        wait10
0559+  0000                         endm
0560+  0000             
0561+  0000                         macro   wait45
0562+  0000~                        wait36
0563+  0000~                        wait9
0564+  0000                         endm
0565+  0000             
0566+  0000                         macro   wait46
0567+  0000~                        wait34
0568+  0000~                        wait12
0569+  0000                         endm
0570+  0000             
0571+  0000                         macro   wait47
0572+  0000~                        wait34
0573+  0000~                        wait13
0574+  0000                         endm
0575+  0000             
0576+  0000                         macro   wait48
0577+  0000~                        wait36
0578+  0000~                        wait12
0579+  0000                         endm
0580+  0000             
0581+  0000                         macro   wait49
0582+  0000~                        wait36
0583+  0000~                        wait13
0584+  0000                         endm
0585+  0000             
0586+  0000                         macro   wait50
0587+  0000~                        wait2p16x 3
0588+  0000                         endm
0589+  0000             
0590+  0000                         macro   wait51
0591+  0000~                        wait34
0592+  0000~                        wait17
0593+  0000                         endm
0594+  0000             
0595+  0000                         macro   wait52
0596+  0000~                        wait34
0597+  0000~                        wait18
0598+  0000                         endm
0599+  0000             
0600+  0000                         macro   wait53
0601+  0000~                        wait36
0602+  0000~                        wait17
0603+  0000                         endm
0604+  0000             
0605+  0000                         macro   wait54
0606+  0000~                        wait50
0607+  0000~                        wait4
0608+  0000                         endm
0609+  0000             
0610+  0000                         macro   wait55
0611+  0000~                        wait34
0612+  0000~                        wait21
0613+  0000                         endm
0614+  0000             
0615+  0000                         macro   wait56
0616+  0000~                        wait34
0617+  0000~                        wait22
0618+  0000                         endm
0619+  0000             
0620+  0000                         macro   wait57
0621+  0000~                        wait50
0622+  0000~                        wait7
0623+  0000                         endm
0624+  0000             
0625+  0000                         macro   wait58
0626+  0000~                        wait50
0627+  0000~                        wait8
0628+  0000                         endm
0629+  0000             
0630+  0000                         macro   wait59
0631+  0000~                        wait50
0632+  0000~                        wait9
0633+  0000                         endm
0634+  0000             
0635+  0000                         macro   wait60
0636+  0000~                        wait50
0637+  0000~                        wait10
0638+  0000                         endm
0639+  0000             
0640+  0000                         macro   wait61
0641+  0000~                        wait50
0642+  0000~                        wait11
0643+  0000                         endm
0644+  0000             
0645+  0000                         macro   wait62
0646+  0000~                        wait50
0647+  0000~                        wait12
0648+  0000                         endm
0649+  0000             
0650+  0000                         macro   wait63
0651+  0000~                        wait50
0652+  0000~                        wait13
0653+  0000                         endm
0654+  0000             
0655+  0000                         macro   wait64
0656+  0000~                        wait50
0657+  0000~                        wait14
0658+  0000                         endm
0659+  0000             
0660+  0000                         macro   wait65
0661+  0000~                        wait50
0662+  0000~                        wait15
0663+  0000                         endm
0664+  0000             
0665+  0000                         macro   wait66
0666+  0000~                        wait2p16x 4
0667+  0000                         endm
0668+  0000             
0669+  0000                         macro   wait67
0670+  0000~                        wait50
0671+  0000~                        wait17
0672+  0000                         endm
0673+  0000             
0674+  0000                         macro   wait68
0675+  0000~                        wait50
0676+  0000~                        wait18
0677+  0000                         endm
0678+  0000             
0679+  0000                         macro   wait69
0680+  0000~                        wait50
0681+  0000~                        wait19
0682+  0000                         endm
0683+  0000             
0684+  0000                         macro   wait70
0685+  0000~                        wait66
0686+  0000~                        wait4
0687+  0000                         endm
0688+  0000             
0689+  0000                         macro   wait71
0690+  0000~                        wait50
0691+  0000~                        wait21
0692+  0000                         endm
0693+  0000             
0694+  0000                         macro   wait72
0695+  0000~                        wait50
0696+  0000~                        wait22
0697+  0000                         endm
0698+  0000             
0699+  0000                         macro   wait73
0700+  0000~                        wait66
0701+  0000~                        wait7
0702+  0000                         endm
0703+  0000             
0704+  0000                         macro   wait74
0705+  0000~                        wait66
0706+  0000~                        wait8
0707+  0000                         endm
0708+  0000             
0709+  0000                         macro   wait75
0710+  0000~                        wait66
0711+  0000~                        wait9
0712+  0000                         endm
0713+  0000             
0714+  0000                         macro   wait76
0715+  0000~                        wait66
0716+  0000~                        wait10
0717+  0000                         endm
0718+  0000             
0719+  0000                         macro   wait77
0720+  0000~                        wait66
0721+  0000~                        wait11
0722+  0000                         endm
0723+  0000             
0724+  0000                         macro   wait78
0725+  0000~                        wait66
0726+  0000~                        wait12
0727+  0000                         endm
0728+  0000             
0729+  0000                         macro   wait79
0730+  0000~                        wait66
0731+  0000~                        wait13
0732+  0000                         endm
0733+  0000             
0734+  0000                         macro   wait80
0735+  0000~                        wait66
0736+  0000~                        wait14
0737+  0000                         endm
0738+  0000             
0739+  0000                         macro   wait81
0740+  0000~                        wait66
0741+  0000~                        wait15
0742+  0000                         endm
0743+  0000             
0744+  0000                         macro   wait82
0745+  0000~                        wait2p16x 5
0746+  0000                         endm
0747+  0000             
0748+  0000                         macro   wait83
0749+  0000~                        wait66
0750+  0000~                        wait17
0751+  0000                         endm
0752+  0000             
0753+  0000                         macro   wait84
0754+  0000~                        wait66
0755+  0000~                        wait18
0756+  0000                         endm
0757+  0000             
0758+  0000                         macro   wait85
0759+  0000~                        wait66
0760+  0000~                        wait19
0761+  0000                         endm
0762+  0000             
0763+  0000                         macro   wait86
0764+  0000~                        wait82
0765+  0000~                        wait4
0766+  0000                         endm
0767+  0000             
0768+  0000                         macro   wait87
0769+  0000~                        wait66
0770+  0000~                        wait21
0771+  0000                         endm
0772+  0000             
0773+  0000                         macro   wait88
0774+  0000~                        wait66
0775+  0000~                        wait22
0776+  0000                         endm
0777+  0000             
0778+  0000                         macro   wait89
0779+  0000~                        wait82
0780+  0000~                        wait7
0781+  0000                         endm
0782+  0000             
0783+  0000                         macro   wait90
0784+  0000~                        wait82
0785+  0000~                        wait8
0786+  0000                         endm
0787+  0000             
0788+  0000                         macro   wait91
0789+  0000~                        wait82
0790+  0000~                        wait9
0791+  0000                         endm
0792+  0000             
0793+  0000                         macro   wait92
0794+  0000~                        wait82
0795+  0000~                        wait10
0796+  0000                         endm
0797+  0000             
0798+  0000                         macro   wait94
0799+  0000~                        wait82
0800+  0000~                        wait12
0801+  0000                         endm
0802+  0000             
0803+  0000                         macro   wait95
0804+  0000~                        wait82
0805+  0000~                        wait13
0806+  0000                         endm
0807+  0000             
0808+  0000                         macro   wait96
0809+  0000~                        wait82
0810+  0000~                        wait14
0811+  0000                         endm
0812+  0000             
0813+  0000                         macro   wait97
0814+  0000~                        wait82
0815+  0000~                        wait15
0816+  0000                         endm
0817+  0000             
0818+  0000                         macro   wait98
0819+  0000~                        wait2p16x 6
0820+  0000                         endm
0821+  0000             
0822+  0000                         macro   wait99
0823+  0000~                        wait82
0824+  0000~                        wait17
0825+  0000                         endm
0826+  0000             
0827+  0000                         macro   wait100
0828+  0000~                        wait82
0829+  0000~                        wait18
0830+  0000                         endm
0831+  0000             
0832+  0000                         macro   wait102
0833+  0000~                        wait98
0834+  0000~                        wait4
0835+  0000                         endm
0836+  0000             
0837+  0000                         macro   wait103
0838+  0000~                        wait82
0839+  0000~                        wait21
0840+  0000                         endm
0841+  0000             
0842+  0000                         macro   wait104
0843+  0000~                        wait82
0844+  0000~                        wait22
0845+  0000                         endm
0846+  0000             
0847+  0000                         macro   wait105
0848+  0000~                        wait98
0849+  0000~                        wait7
0850+  0000                         endm
0851+  0000             
0852+  0000                         macro   wait106
0853+  0000~                        wait98
0854+  0000~                        wait8
0855+  0000                         endm
0856+  0000             
0857+  0000                         macro   wait107
0858+  0000~                        wait98
0859+  0000~                        wait9
0860+  0000                         endm
0861+  0000             
0862+  0000                         macro   wait108
0863+  0000~                        wait98
0864+  0000~                        wait10
0865+  0000                         endm
0866+  0000             
0867+  0000                         macro   wait109
0868+  0000~                        wait98
0869+  0000~                        wait11
0870+  0000                         endm
0871+  0000             
0872+  0000                         macro   wait110
0873+  0000~                        wait98
0874+  0000~                        wait12
0875+  0000                         endm
0876+  0000             
0877+  0000                         macro   wait111
0878+  0000~                        wait98
0879+  0000~                        wait13
0880+  0000                         endm
0881+  0000             
0882+  0000                         macro   wait112
0883+  0000~                        wait98
0884+  0000~                        wait14
0885+  0000                         endm
0886+  0000             
0887+  0000                         macro   wait114
0888+  0000~                        wait2p16x 7
0889+  0000                         endm
0890+  0000             
0891+  0000                         macro   wait115
0892+  0000~                        wait98
0893+  0000~                        wait17
0894+  0000                         endm
0895+  0000             
0896+  0000                         macro   wait116
0897+  0000~                        wait98
0898+  0000~                        wait18
0899+  0000                         endm
0900+  0000             
0901+  0000                         macro   wait117
0902+  0000~                        wait98
0903+  0000~                        wait19
0904+  0000                         endm
0905+  0000             
0906+  0000                         macro   wait118
0907+  0000~                        wait114
0908+  0000~                        wait4
0909+  0000                         endm
0910+  0000             
0911+  0000                         macro   wait119
0912+  0000~                        wait98
0913+  0000~                        wait21
0914+  0000                         endm
0915+  0000             
0916+  0000                         macro   wait120
0917+  0000~                        wait98
0918+  0000~                        wait22
0919+  0000                         endm
0920+  0000             
0921+  0000                         macro   wait121
0922+  0000~                        wait114
0923+  0000~                        wait7
0924+  0000                         endm
0925+  0000             
0926+  0000                         macro   wait122
0927+  0000~                        wait114
0928+  0000~                        wait8
0929+  0000                         endm
0930+  0000             
0931+  0000                         macro   wait123
0932+  0000~                        wait114
0933+  0000~                        wait9
0934+  0000                         endm
0935+  0000             
0936+  0000                         macro   wait124
0937+  0000~                        wait114
0938+  0000~                        wait10
0939+  0000                         endm
0940+  0000             
0941+  0000                         macro   wait125
0942+  0000~                        wait114
0943+  0000~                        wait11
0944+  0000                         endm
0945+  0000             
0946+  0000                         macro   wait126
0947+  0000~                        wait114
0948+  0000~                        wait12
0949+  0000                         endm
0950+  0000             
0951+  0000                         macro   wait127
0952+  0000~                        wait114
0953+  0000~                        wait13
0954+  0000                         endm
0955+  0000             
0956+  0000                         macro   wait128
0957+  0000~                        wait114
0958+  0000~                        wait14
0959+  0000                         endm
0960+  0000             
0961+  0000                         macro   wait129
0962+  0000~                        wait114
0963+  0000~                        wait15
0964+  0000                         endm
0965+  0000             
0966+  0000                         macro   wait130
0967+  0000~                        wait2p16x 8
0968+  0000                         endm
0969+  0000             
0970+  0000                         macro   wait131
0971+  0000~                        wait114
0972+  0000~                        wait17
0973+  0000                         endm
0974+  0000             
0975+  0000                         macro   wait132
0976+  0000~                        wait114
0977+  0000~                        wait18
0978+  0000                         endm
0979+  0000             
0980+  0000                         macro   wait133
0981+  0000~                        wait114
0982+  0000~                        wait19
0983+  0000                         endm
0984+  0000             
0985+  0000                         macro   wait134
0986+  0000~                        wait130
0987+  0000~                        wait4
0988+  0000                         endm
0989+  0000             
0990+  0000                         macro   wait135
0991+  0000~                        wait114
0992+  0000~                        wait21
0993+  0000                         endm
0994+  0000             
0995+  0000                         macro   wait136
0996+  0000~                        wait114
0997+  0000~                        wait22
0998+  0000                         endm
0999+  0000             
1000+  0000                         macro   wait137
1001+  0000~                        wait130
1002+  0000~                        wait7
1003+  0000                         endm
1004+  0000             
1005+  0000                         macro   wait138
1006+  0000~                        wait130
1007+  0000~                        wait8
1008+  0000                         endm
1009+  0000             
1010+  0000                         macro   wait139
1011+  0000~                        wait130
1012+  0000~                        wait9
1013+  0000                         endm
1014+  0000             
1015+  0000                         macro   wait140
1016+  0000~                        wait130
1017+  0000~                        wait10
1018+  0000                         endm
1019+  0000             
1020+  0000                         macro   wait141
1021+  0000~                        wait130
1022+  0000~                        wait11
1023+  0000                         endm
1024+  0000             
1025+  0000                         macro   wait144
1026+  0000~                        wait130
1027+  0000~                        wait14
1028+  0000                         endm
1029+  0000             
1030+  0000                         macro   wait145
1031+  0000~                        wait130
1032+  0000~                        wait15
1033+  0000                         endm
1034+  0000             
1035+  0000                         macro   wait146
1036+  0000~                        wait2p16x 9
1037+  0000                         endm
1038+  0000             
1039+  0000                         macro   wait147
1040+  0000~                        wait130
1041+  0000~                        wait17
1042+  0000                         endm
1043+  0000             
1044+  0000                         macro   wait148
1045+  0000~                        wait130
1046+  0000~                        wait18
1047+  0000                         endm
1048+  0000             
1049+  0000                         macro   wait149
1050+  0000~                        wait130
1051+  0000~                        wait19
1052+  0000                         endm
1053+  0000             
1054+  0000                         macro   wait150
1055+  0000~                        wait146
1056+  0000~                        wait4
1057+  0000                         endm
1058+  0000             
1059+  0000                         macro   wait154
1060+  0000~                        wait146
1061+  0000~                        wait8
1062+  0000                         endm
1063+  0000             
1064+  0000                         macro   wait155
1065+  0000~                        wait146
1066+  0000~                        wait9
1067+  0000                         endm
1068+  0000             
1069+  0000                         macro   wait156
1070+  0000~                        wait146
1071+  0000~                        wait10
1072+  0000                         endm
1073+  0000             
1074+  0000                         macro   wait157
1075+  0000~                        wait146
1076+  0000~                        wait11
1077+  0000                         endm
1078+  0000             
1079+  0000                         macro   wait158
1080+  0000~                        wait146
1081+  0000~                        wait12
1082+  0000                         endm
1083+  0000             
1084+  0000                         macro   wait160
1085+  0000~                        wait146
1086+  0000~                        wait14
1087+  0000                         endm
1088+  0000             
1089+  0000                         macro   wait161
1090+  0000~                        wait146
1091+  0000~                        wait15
1092+  0000                         endm
1093+  0000             
1094+  0000                         macro   wait162
1095+  0000~                        wait2p16x 10
1096+  0000                         endm
1097+  0000             
1098+  0000                         macro   wait164
1099+  0000~                        wait146
1100+  0000~                        wait18
1101+  0000                         endm
1102+  0000             
1103+  0000                         macro   wait165
1104+  0000~                        wait146
1105+  0000~                        wait19
1106+  0000                         endm
1107+  0000             
1108+  0000                         macro   wait166
1109+  0000~                        wait162
1110+  0000~                        wait4
1111+  0000                         endm
1112+  0000             
1113+  0000                         macro   wait172
1114+  0000~                        wait162
1115+  0000~                        wait10
1116+  0000                         endm
1117+  0000             
1118+  0000                         macro   wait174
1119+  0000~                        wait162
1120+  0000~                        wait12
1121+  0000                         endm
1122+  0000             
1123+  0000                         macro   wait175
1124+  0000~                        wait162
1125+  0000~                        wait13
1126+  0000                         endm
1127+  0000             
1128+  0000                         macro   wait176
1129+  0000~                        wait162
1130+  0000~                        wait14
1131+  0000                         endm
1132+  0000             
1133+  0000                         macro   wait178
1134+  0000~                        wait2p16x 11
1135+  0000                         endm
1136+  0000             
1137+  0000                         macro   wait179
1138+  0000~                        wait162
1139+  0000~                        wait17
1140+  0000                         endm
1141+  0000             
1142+  0000                         macro   wait180
1143+  0000~                        wait162
1144+  0000~                        wait18
1145+  0000                         endm
1146+  0000             
1147+  0000                         macro   wait182
1148+  0000~                        wait178
1149+  0000~                        wait4
1150+  0000                         endm
1151+  0000             
1152+  0000                         macro   wait183
1153+  0000~                        wait162
1154+  0000~                        wait121
1155+  0000                         endm
1156+  0000             
1157+  0000                         macro   wait186
1158+  0000~                        wait178
1159+  0000~                        wait8
1160+  0000                         endm
1161+  0000             
1162+  0000                         macro   wait187
1163+  0000~                        wait178
1164+  0000~                        wait9
1165+  0000                         endm
1166+  0000             
1167+  0000                         macro   wait189
1168+  0000~                        wait178
1169+  0000~                        wait11
1170+  0000                         endm
1171+  0000             
1172+  0000                         macro   wait191
1173+  0000~                        wait178
1174+  0000~                        wait13
1175+  0000                         endm
1176+  0000             
1177+  0000                         macro   wait192
1178+  0000~                        wait178
1179+  0000~                        wait14
1180+  0000                         endm
1181+  0000             
1182+  0000                         macro   wait193
1183+  0000~                        wait178
1184+  0000~                        wait15
1185+  0000                         endm
1186+  0000             
1187+  0000                         macro   wait194
1188+  0000~                        wait2p16x 12
1189+  0000                         endm
1190+  0000             
1191+  0000                         macro   wait197
1192+  0000~                        wait178
1193+  0000~                        wait19
1194+  0000                         endm
1195+  0000             
1196+  0000                         macro   wait203
1197+  0000~                        wait194
1198+  0000~                        wait9
1199+  0000                         endm
1200+  0000             
1201+  0000                         macro   wait210
1202+  0000~                        wait2p16x 13
1203+  0000                         endm
1204+  0000             
1205+  0000                         macro   wait218
1206+  0000~                        wait210
1207+  0000~                        wait8
1208+  0000                         endm
1209+  0000             
1210+  0000                         macro   wait226
1211+  0000~                        wait2p16x 14
1212+  0000                         endm
1213+  0000             
1214+  0000                         macro   wait234
1215+  0000~                        wait226
1216+  0000~                        wait8
1217+  0000                         endm
1218+  0000             
1219+  0000                         macro   wait242
1220+  0000~                        wait2p16x 15
1221+  0000                         endm
1222+  0000             
1223+  0000                         macro   wait244
1224+  0000~                        wait226
1225+  0000~                        wait18
1226+  0000                         endm
1227+  0000             
1228+  0000                         macro   wait246
1229+  0000~                        wait242
1230+  0000~                        wait4
1231+  0000                         endm
1232+  0000             
1233+  0000                         macro   wait254
1234+  0000~                        wait242
1235+  0000~                        wait12
1236+  0000                         endm
1237+  0000             
1238+  0000                         macro   wait258
1239+  0000~                        wait2p16x 16
1240+  0000                         endm
1241+  0000             
1242+  0000                         macro   wait260
1243+  0000~                        wait242
1244+  0000~                        wait18
1245+  0000                         endm
1246+  0000             
1247+  0000                         macro   wait262
1248+  0000~                        wait258
1249+  0000~                        wait4
1250+  0000                         endm
1251+  0000             
1252+  0000                         macro   wait264
1253+  0000~                        wait242
1254+  0000~                        wait22
1255+  0000                         endm
1256+  0000             
1257+  0000                         macro   wait268
1258+  0000~                        wait258
1259+  0000~                        wait10
1260+  0000                         endm
1261+  0000             
1262+  0000                         macro   wait274
1263+  0000~                        wait2p16x 17
1264+  0000                         endm
1265+  0000             
1266+  0000                         macro   wait276
1267+  0000~                        wait258
1268+  0000~                        wait18
1269+  0000                         endm
1270+  0000             
1271+  0000                         macro   wait278
1272+  0000~                        wait274
1273+  0000~                        wait4
1274+  0000                         endm
1275+  0000             
1276+  0000                         macro   wait282
1277+  0000~                        wait274
1278+  0000~                        wait8
1279+  0000                         endm
1280+  0000             
1281+  0000                         macro   wait283
1282+  0000~                        wait274
1283+  0000~                        wait9
1284+  0000                         endm
1285+  0000             
1286+  0000                         macro   wait285
1287+  0000~                        wait274
1288+  0000~                        wait11
1289+  0000                         endm
1290+  0000             
1291+  0000                         macro   wait287
1292+  0000~                        wait274
1293+  0000~                        wait13
1294+  0000                         endm
1295+  0000             
1296+  0000                         macro   wait290
1297+  0000~                        wait2p16x 18
1298+  0000                         endm
1299+  0000             
1300+  0000                         macro   wait294
1301+  0000~                        wait290
1302+  0000~                        wait4
1303+  0000                         endm
1304+  0000             
1305+  0000                         macro   wait295
1306+  0000~                        wait274
1307+  0000~                        wait21
1308+  0000                         endm
1309+  0000             
1310+  0000                         macro   wait298
1311+  0000~                        wait290
1312+  0000~                        wait8
1313+  0000                         endm
1314+  0000             
1315+  0000                         macro   wait305
1316+  0000~                        wait290
1317+  0000~                        wait15
1318+  0000                         endm
1319+  0000             
1320+  0000                         macro   wait306
1321+  0000~                        wait2p16x 19
1322+  0000                         endm
1323+  0000             
1324+  0000                         macro   wait308
1325+  0000~                        wait290
1326+  0000~                        wait18
1327+  0000                         endm
1328+  0000             
1329+  0000                         macro   wait320
1330+  0000~                        wait306
1331+  0000~                        wait14
1332+  0000                         endm
1333+  0000             
1334+  0000                         macro   wait322
1335+  0000~                        wait2p16x 20
1336+  0000                         endm
1337+  0000             
1338+  0000                         macro   wait324
1339+  0000~                        wait306
1340+  0000~                        wait18
1341+  0000                         endm
1342+  0000             
1343+  0000                         macro   wait329
1344+  0000~                        wait322
1345+  0000~                        wait7
1346+  0000                         endm
1347+  0000             
1348+  0000                         macro   wait337
1349+  0000~                        wait322
1350+  0000~                        wait15
1351+  0000                         endm
1352+  0000             
1353+  0000                         macro   wait338
1354+  0000~                        wait2p16x 21
1355+  0000                         endm
1356+  0000             
1357+  0000                         macro   wait345
1358+  0000~                        wait338
1359+  0000~                        wait7
1360+  0000                         endm
1361+  0000             
1362+  0000                         macro   wait434
1363+  0000~                        wait2p16x 27
1364+  0000                         endm
1365+  0000             
1366+  0000                         macro   wait450
1367+  0000~                        wait2p16x 28
1368+  0000                         endm
1369+  0000             
1370+  0000                         macro   wait454
1371+  0000~                        wait450
1372+  0000~                        wait4
1373+  0000                         endm
1374+  0000             
1375+  0000                         macro   wait455
1376+  0000~                        wait434
1377+  0000~                        wait21
1378+  0000                         endm
1379+  0000             
1380+  0000                         macro   wait546
1381+  0000~                        wait2p16x 34
1382+  0000                         endm
1383+  0000             
1384+  0000                         macro   wait562
1385+  0000~                        wait2p16x 35
1386+  0000                         endm
1387+  0000             
1388+  0000                         macro   wait567
1389+  0000~                        wait546
1390+  0000~                        wait21
1391+  0000                         endm
1392+  0000             
1393+  0000                         macro   wait578
1394+  0000~                        wait2p16x 36
1395+  0000                         endm
1396+  0000             
1397+  0000                         macro   wait586
1398+  0000~                        wait578
1399+  0000~                        wait8
1400+  0000                         endm
1401+  0000             
1402+  0000                         macro   wait590
1403+  0000~                        wait578
1404+  0000~                        wait12
1405+  0000                         endm
1406+  0000             
1407+  0000                         macro   wait594
1408+  0000~                        wait2p16x 37
1409+  0000                         endm
1410+  0000             
1411+  0000                         macro   wait595
1412+  0000~                        wait578
1413+  0000~                        wait17
1414+  0000                         endm
1415+  0000             
1416+  0000                         macro   wait598
1417+  0000~                        wait594
1418+  0000~                        wait4
1419+  0000                         endm
1420+  0000             
1421+  0000                         macro   wait599
1422+  0000~                        wait578
1423+  0000~                        wait21
1424+  0000                         endm
1425+  0000             
1426+  0000                         macro   wait602
1427+  0000~                        wait594
1428+  0000~                        wait8
1429+  0000                         endm
1430+  0000             
1431+  0000                         macro   wait609
1432+  0000~                        wait594
1433+  0000~                        wait15
1434+  0000                         endm
1435+  0000             
1436+  0000                         macro   wait610
1437+  0000~                        wait2p16x 38
1438+  0000                         endm
1439+  0000             
1440+  0000                         macro   wait614
1441+  0000~                        wait610
1442+  0000~                        wait4
1443+  0000                         endm
1444+  0000             
1445+  0000                         macro   wait618
1446+  0000~                        wait610
1447+  0000~                        wait8
1448+  0000                         endm
1449+  0000             
1450+  0000                         macro   wait619
1451+  0000~                        wait610
1452+  0000~                        wait9
1453+  0000                         endm
1454+  0000             
1455+  0000                         macro   wait622
1456+  0000~                        wait610
1457+  0000~                        wait12
1458+  0000                         endm
1459+  0000             
1460+  0000                         macro   wait623
1461+  0000~                        wait610
1462+  0000~                        wait13
1463+  0000                         endm
1464+  0000             
1465+  0000                         macro   wait626
1466+  0000~                        wait2p16x 39
1467+  0000                         endm
1468+  0000             
1469+  0000                         macro   wait634
1470+  0000~                        wait626
1471+  0000~                        wait8
1472+  0000                         endm
1473+  0000             
1474+  0000                         macro   wait638
1475+  0000~                        wait626
1476+  0000~                        wait12
1477+  0000                         endm
0134   0000             
0135   0000             
0136   0000             ; handlePCMCommand
0137   0000             ; ----------------
0138   0000             ; ? ->  HL  -> ?
0139   0000             ; ? ->  BC  -> ?
0140   0000             ; ? ->  SP  -> ?
0141   0000             ;
0142   0000             ; handle PCM command for channel 'ch' (PCM id < 0x100)
0143   0000             ; = 157 cycles
0144   0000             
0145   0000                         macro handlePCMCommand ch
0146   0000~            
0147   0000~                        LD      BC, (PCM_ARG_P+(ch*2))  ; C = SFX prio, B = SFX id  ' 20    |
0148   0000~                        LD      HL, PCM_PRIO+(ch*8)     ; HL point on PCM info      ' 10    | (30)
0149   0000~            
0150   0000~                        LD      A, C                    ; A = new prio              ' 4     |
0151   0000~                        CP      (HL)                    ; compare to old prio       ' 7     | 21 (51)
0152   0000~                        JP      NC, .play_new           ; >= old prio --> play new  ' 10    |
0153   0000~            
0154   0000~                        wait96                          ; sync                      ' 96    |
0155   0000~                        JP      .end                    ;                           ' 10    | 106 (157)
0156   0000~            
0157   0000~            .play_new
0158   0000~                        LD      A, B                    ; A = SFX id                ' 4     |
0159   0000~                        OR      A                       ; not a stop PCM command ?  ' 4     | 18 (69)
0160   0000~                        JR      NZ, .PCM_play           ; go set new prio           ' 7/12  |
0161   0000~            
0162   0000~                        LD      C, 0                    ; reset prio for stop       ' 7     | +2
0163   0000~            
0164   0000~            .PCM_play                                   ;                           ' 69
0165   0000~                        LD      (HL), C                 ; set new prio              ' 7     | (76)
0166   0000~            
0167   0000~                        LD      H, (ID_TABLE>>10)       ;                           ' 7     |
0168   0000~                        LD      L, A                    ;                           ' 4     |
0169   0000~                        ADD     HL, HL                  ;                           ' 6     |
0170   0000~                        ADD     HL, HL                  ; HL point on new PCM addr  ' 6     | 29 (105)
0171   0000~                        LD      SP, HL                  ; set SP to new PCM addr    ' 6     |
0172   0000~            
0173   0000~                        POP     HL                      ; copy params               ' 10    |
0174   0000~                        LD      (PCM_ADDR+(ch*8)),HL    ;                           ' 16    |
0175   0000~                        POP     HL                      ;                           ' 10    | 52 (157)
0176   0000~                        LD      (PCM_LEN+(ch*8)),HL     ;                           ' 16    |
0177   0000~            
0178   0000~            .end
0179   0000                         endm
0180   0000             
0181   0000             
0182   0000             ; handlePCMCommandXGM
0183   0000             ; -------------------
0184   0000             ; XGM data ->  DE  -> XGM data
0185   0000             ; PCM prio ->  C   -> ?
0186   0000             ; ?        ->  HL  -> ?
0187   0000             ; ?        ->  SP  -> ?
0188   0000             ;
0189   0000             ; handle PCM command for channel 'ch' for XGM music (PCM id < 0x40)
0190   0000             ; = 142 cycles
0191   0000             
0192   0000                         macro handlePCMCommandXGM ch
0193   0000~            
0194   0000~                        LD      HL, PCM_PRIO+(ch*8)     ; HL point on PCM info      ' 10    |
0195   0000~                        LD      A, C                    ; A = new prio              ' 4     |
0196   0000~                        CP      (HL)                    ; compare new and old prio  ' 7     | (31)
0197   0000~                        JP      NC, .play_new           ; >= old prio --> play new  ' 10    |
0198   0000~            
0199   0000~                        INC     E                       ; next XGM command          ' 4     |
0200   0000~                        wait97                          ; sync                      ' 97    | 111 (142)
0201   0000~                        JP      .end                    ; done                      ' 10    |
0202   0000~            
0203   0000~            .play_new
0204   0000~                        LD      A, (DE)                 ; A = PCM id (max = $3F)    ' 7     |
0205   0000~                        INC     E                       ; next XGM command          ' 4     |
0206   0000~                        OR      A                       ; not a stop PCM command ?  ' 4     | 27 (58)
0207   0000~                        JR      NZ, .PCM_play           ; go set new prio           ' 7/12  |
0208   0000~            
0209   0000~                        LD      C, 0                    ; reset prio for stop       ' 7     | +2
0210   0000~            
0211   0000~            .PCM_play
0212   0000~                        LD      (HL), C                 ; set new prio              ' 7     | (65)
0213   0000~            
0214   0000~                        LD      H, (ID_TABLE>>8)        ;                           ' 7     |
0215   0000~                        ADD     A                       ;                           ' 4     |
0216   0000~                        ADD     A                       ;                           ' 4     | 25 (90)
0217   0000~                        LD      L, A                    ; HL point on new PCM addr  ' 4     |
0218   0000~                        LD      SP, HL                  ; set SP to new PCM addr    ' 6     |
0219   0000~            
0220   0000~                        POP     HL                      ; copy params               ' 10    |
0221   0000~                        LD      (PCM_ADDR+(ch*8)),HL    ;                           ' 16    |
0222   0000~                        POP     HL                      ;                           ' 10    | 52 (142)
0223   0000~                        LD      (PCM_LEN+(ch*8)),HL     ;                           ' 16    |
0224   0000~            
0225   0000~            .end                                        ;                           ' 142
0226   0000~            
0227   0000                         endm
0228   0000             
0229   0000             
0230   0000             ; prepareChannelAlt
0231   0000             ; -----------------
0232   0000             ; ? ->  HL  ->  point to the sample source (ROM)
0233   0000             ; ? ->  DE  ->  point to write buffer
0234   0000             ;
0235   0000             ; set bank and prepare registers to play PCM channel 'ch'
0236   0000             ; = 176 cycles
0237   0000             
0238   0000                         macro prepareChannelAlt ch
0239   0000~            
0240   0000~                        LD      HL, (PCM_ADDR+(ch*8))   ; HL = sample addr (HM) ' 16    | (16)
0241   0000~            
0242   0000~                        LD      A, L                    ; A = bit 8-15          ' 4     |
0243   0000~                        RLA                             ; C flag = bit 15       ' 4     |
0244   0000~                        LD      A, H                    ; A = bit 16-23         ' 4     | 16 (32)
0245   0000~                        RLA                             ; A = bit 15-22         ' 4     |
0246   0000~            
0247   0000~                        setBank_DE                      ; set bank              ' 105   | (137)
0248   0000~            
0249   0000~                        LD      H, L                    ;                       ' 4     |
0250   0000~                        SET     7, H                    ; HL |= 0x8000          ' 8     | 19 (156)
0251   0000~                        LD      L, 0                    ; HL = sample addr bank ' 7     |
0252   0000~            
0253   0000~                        LD      DE, (WRITEBUF)          ; DE = write buffer     ' 20    | (176)
0254   0000~            
0255   0000                         endm
0256   0000             
0257   0000             ; prepareChannel
0258   0000             ; --------------
0259   0000             ; ? ->  SP  ->  point to the sample source (ROM)
0260   0000             ; ? ->  HL  ->  point to write buffer
0261   0000             ;
0262   0000             ; set bank and prepare registers to play PCM channel 'ch'
0263   0000             ; = 178 cycles
0264   0000             
0265   0000                         macro prepareChannel ch
0266   0000~            
0267   0000~                        LD      HL, (PCM_ADDR+(ch*8))   ; HL = sample addr (HM) ' 16    | (16)
0268   0000~            
0269   0000~                        LD      A, L                    ; A = bit 8-15          ' 4     |
0270   0000~                        RLA                             ; C flag = bit 15       ' 4     |
0271   0000~                        LD      A, H                    ; A = bit 16-23         ' 4     | 16 (32)
0272   0000~                        RLA                             ; A = bit 15-22         ' 4     |
0273   0000~            
0274   0000~                        setBank_DE                      ; set bank              ' 105   | (137)
0275   0000~            
0276   0000~                        LD      H, L                    ;                       ' 4     |
0277   0000~                        SET     7, H                    ; HL |= 0x8000          ' 8     | 25 (162)
0278   0000~                        LD      L, 0                    ; HL = sample addr bank ' 7     |
0279   0000~                        LD      SP, HL                  ; SP point on sample    ' 6     |
0280   0000~            
0281   0000~                        LD      HL, (WRITEBUF)          ; HL = write buffer     ' 16    | (178)
0282   0000~            
0283   0000                         endm
0284   0000             
0285   0000             
0286   0000             ; stopChannel
0287   0000             ; -----------
0288   0000             ; ? ->  HL  -> STATUS
0289   0000             ;
0290   0000             ; set null sample play for channel 'ch'
0291   0000             ; = 75 cycles
0292   0000             
0293   0000                         macro stopChannel ch
0294   0000~            
0295   0000~                        LD      HL, (ID_TABLE+0)        ; HL = null PCM addr        ' 16    |
0296   0000~                        LD      (PCM_ADDR+(ch*8)), HL   ; set new PCM addr          ' 16    |
0297   0000~                        LD      HL, $0001               ; HL = null PCM len         ' 10    | (58)
0298   0000~                        LD      (PCM_LEN+(ch*8)), HL    ; set new PCM addr          ' 16    |
0299   0000~            
0300   0000~                        XOR     A                       ;                           ' 4     |
0301   0000~                        LD      (PCM_PRIO+(ch*8)), A    ; clear prio                ' 13    | 17 (75)
0302   0000~            
0303   0000                         endm
0304   0000             
0305   0000             
0306   0000             ; updateChannelData
0307   0000             ; -----------------
0308   0000             ; ? ->  HL  -> ?
0309   0000             ;
0310   0000             ; update sample address and sample lenght
0311   0000             ; check if sample is done and stop it if needed
0312   0000             ; = 153 cycles
0313   0000             
0314   0000                         macro updateChannelData ch
0315   0000~            
0316   0000~                        LD      HL, (PCM_ADDR+(ch*8))   ; increment address     ' 16    |
0317   0000~                        INC     HL                      ;                       ' 6     | (38)
0318   0000~                        LD      (PCM_ADDR+(ch*8)), HL   ;                       ' 16    |
0319   0000~            
0320   0000~                        LD      HL, (PCM_LEN+(ch*8))    ; decrement lenght      ' 16    |
0321   0000~                        DEC     HL                      ;                       ' 6     | 22 (60)
0322   0000~            
0323   0000~                        LD      A, H                    ;                       ' 4     |
0324   0000~                        OR      L                       ;                       ' 4     | 18 (78)
0325   0000~                        JP      Z, .done                ; sample done ?         ' 10    |
0326   0000~            
0327   0000~                        LD      (PCM_LEN+(ch*8)), HL    ; set new sample len    ' 16    |
0328   0000~                        wait49                          ;                       ' 49    | 75 (153)
0329   0000~                        JP      .end                    ;                       ' 10    |
0330   0000~            
0331   0000~            .done
0332   0000~                        stopChannel ch                  ; stop channel          ' 75    | (153)
0333   0000~            
0334   0000~            .end
0335   0000~            
0336   0000                         endm
0337   0000             
0338   0000             
0339   0000             ; compareReadWrite
0340   0000             ; ----------------
0341   0000             ; read buffer  -> BC'
0342   0000             ; write buffer -> DE
0343   0000             ;                 ZF ->  Write == Read buffer
0344   0000             ;
0345   0000             ; compare read and write buffer
0346   0000             ; = 16 cycles
0347   0000             
0348   0000                         macro compareReadWrite
0349   0000~            
0350   0000~                        EXX                     ;                           ' 4     |
0351   0000~                        LD      A, B            ; A = read buffer high      ' 4     |
0352   0000~                        EXX                     ;                           ' 4     | 16
0353   0000~                        CP      D               ; compare write buffer high ' 4     |
0354   0000~            
0355   0000                         endm
0356   0000             
0357   0000             
0358   0000             ; readAndClear
0359   0000             ; ------------
0360   0000             ; point to sample source (ROM) ->  HL  ->  point to sample source (ROM)
0361   0000             ; point to write buffer        ->  DE  ->  point to write buffer
0362   0000             ; ?                            ->  PF  ->  0=done 1=not done
0363   0000             ;
0364   0000             ; read 1 sample from rom and write it in output buffer
0365   0000             ; = 19 cycles
0366   0000             
0367   0000                         macro readAndClear
0368   0000~            
0369   0000~                        LDI                     ;                           ' 16+3  | 19
0370   0000~            
0371   0000                         endm
0372   0000             
0373   0000             
0374   0000             ; readAndClear2
0375   0000             ; -------------
0376   0000             ; point to sample source (ROM) ->  HL  ->  point to sample source (ROM)
0377   0000             ; point to write buffer        ->  DE  ->  point to write buffer
0378   0000             ; ?                            ->  PF  ->  0=done 1=not done
0379   0000             ;
0380   0000             ; read 2 samples from rom and write them in write buffer
0381   0000             ; = 38 cycles
0382   0000             
0383   0000                         macro readAndClear2
0384   0000~            
0385   0000~                        LDI                     ;                           ' 16+3  |
0386   0000~                        LDI                     ;                           ' 16+3  | (38)
0387   0000~            
0388   0000                         endm
0389   0000             
0390   0000             
0391   0000             ; readAndMix2
0392   0000             ; -----------
0393   0000             ; point to sample source (ROM) ->  SP  ->  point to sample source (ROM)
0394   0000             ; point to write buffer        ->  HL  ->  point to write buffer
0395   0000             ; $80 ->  C
0396   0000             ;
0397   0000             ; read 2 samples and mix them in output buffer
0398   0000             ; = 80 (+22 when overflow)
0399   0000             
0400   0000                         macro readAndMix2
0401   0000~            
0402   0000~                        POP     DE              ; read 2 samples from ROM   ' 10+6  | (16)
0403   0000~            
0404   0000~                        LD      A, E            ; first sample              ' 4     |
0405   0000~                        ADD     (HL)            ; mix with write buffer     ' 7     | 21 (37)
0406   0000~                        JP      PO, .ok         ; check overflow            ' 10    |
0407   0000~            
0408   0000~                        LD      A, C            ; fix overflow              ' 4     |
0409   0000~                        ADC     $FF             ; A = $7F/$80               ' 7     | +11
0410   0000~            
0411   0000~            .ok
0412   0000~                        LD      (HL), A         ; store it in write sample  ' 7     |
0413   0000~                        INC     L               ;                           ' 4     | 11 (48)
0414   0000~            
0415   0000~                        LD      A, D            ; second sample             ' 4     |
0416   0000~                        ADD     (HL)            ; mix                       ' 7     | 21 (69)
0417   0000~                        JP      PO, .ok2        ; check overflow            ' 10    |
0418   0000~            
0419   0000~                        LD      A, C            ; fix overflow              ' 4     |
0420   0000~                        ADC     $FF             ; A = $7F/$80               ' 7     | +11
0421   0000~            
0422   0000~            .ok2
0423   0000~                        LD      (HL), A         ; store it in write sample  ' 7     |
0424   0000~                        INC     L               ;                           ' 4     | 11 (80)
0425   0000~            
0426   0000                         endm                    ;                           ' 80 (+22)
0427   0000             
0428   0000             
0429   0000             ; readAndMix16WhilePlay3
0430   0000             ; ----------------------
0431   0000             ; point to sample source (ROM) ->  SP  ->  point to sample source (ROM)
0432   0000             ; point to write buffer        ->  HL  ->  point to write buffer
0433   0000             ; $80 ->  C
0434   0000             ;
0435   0000             ; read 16 samples and mix them in output buffer
0436   0000             ; = 2 samples + 240 cycles
0437   0000             
0438   0000                         macro readAndMix16WhilePlay3
0439   0000~            
0440   0000~                        sampleOutput            ;                           ' 36    | (36)
0441   0000~            
0442   0000~                        readAndMix2             ; read and mix 2 samples    ' 80    |
0443   0000~                        readAndMix2             ; read and mix 2 samples    ' 80    | 160 (196)
0444   0000~            
0445   0000~                        POP     DE              ; read 2 samples from ROM   ' 10+6  | (212)
0446   0000~            
0447   0000~                        LD      A, E            ; first sample              ' 4     |
0448   0000~                        ADD     (HL)            ; mix with write buffer     ' 7     | 21 (233)
0449   0000~                        JP      PO, .ok         ; check overflow            ' 10    |
0450   0000~            
0451   0000~                        LD      A, C            ; fix overflow              ' 4     |
0452   0000~                        ADC     $FF             ; A = $7F/$80               ' 7     | +11
0453   0000~            
0454   0000~            .ok
0455   0000~                        LD      (HL), A         ; store it in write sample  ' 7     |
0456   0000~                        INC     L               ;                           ' 4     | 11 (254-10)
0457   0000~            
0458   0000~                        sampleOutput            ; -10 --> too soon          ' 36    | (36-10)
0459   0000~            
0460   0000~                        LD      A, D            ; second sample             ' 4     |
0461   0000~                        ADD     (HL)            ; mix                       ' 7     | 21 (47)
0462   0000~                        JP      PO, .ok2        ; check overflow            ' 10    |
0463   0000~            
0464   0000~                        LD      A, C            ; fix overflow              ' 4     |
0465   0000~                        ADC     $FF             ; A = $7F/$80               ' 7     | +11
0466   0000~            
0467   0000~            .ok2
0468   0000~                        LD      (HL), A         ; store it in write sample  ' 7     |
0469   0000~                        INC     L               ;                           ' 4     | 11 (58)
0470   0000~            
0471   0000~                        readAndMix2             ; read and mix 2 samples    ' 80    |
0472   0000~                        readAndMix2             ; read and mix 2 samples    ' 80    | 160 (218)
0473   0000~            
0474   0000~                        POP     DE              ; read 2 samples from ROM   ' 10+6  | (234)
0475   0000~            
0476   0000~                        LD      A, E            ; first sample              ' 4     |
0477   0000~                        ADD     (HL)            ; mix with write buffer     ' 7     | 21 (254+1)
0478   0000~                        JP      PO, .ok3        ; check overflow            ' 10    |
0479   0000~            
0480   0000~                        LD      A, C            ; fix overflow              ' 4     |
0481   0000~                        ADC     $FF             ; A = $7F/$80               ' 7     | +11
0482   0000~            
0483   0000~            .ok3
0484   0000~                        LD      (HL), A         ; store it in write sample  ' 7     | (254+8)
0485   0000~            
0486   0000~                        sampleOutput            ; +8 --> too late           ' 36    | (36+8)
0487   0000~            
0488   0000~                        INC     L               ;                           ' 4     | (48)
0489   0000~            
0490   0000~                        LD      A, D            ; second sample             ' 4     |
0491   0000~                        ADD     (HL)            ; mix                       ' 7     | 21 (69)
0492   0000~                        JP      PO, .ok4        ; check overflow            ' 10    |
0493   0000~            
0494   0000~                        LD      A, C            ; fix overflow              ' 4     |
0495   0000~                        ADC     $FF             ; A = $7F/$80               ' 7     | +11
0496   0000~            
0497   0000~            .ok4
0498   0000~                        LD      (HL), A         ; store it in write sample  ' 7     |
0499   0000~                        INC     L               ;                           ' 4     | 11 (80)
0500   0000~            
0501   0000~                        readAndMix2             ; read and mix 2 samples    ' 80    |
0502   0000~                        readAndMix2             ; read and mix 2 samples    ' 80    | 160 (240)
0503   0000~            
0504   0000                         endm                    ;                           ' 240
0505   0000             
0506   0000             
0507   0000             ; readMixAndUnsign
0508   0000             ; ----------------
0509   0000             ; point to sample source (ROM) ->  HL  ->  point to sample source (ROM)
0510   0000             ; point to write buffer        ->  DE  ->  point to write buffer
0511   0000             ; $80 ->  C
0512   0000             ;
0513   0000             ; read 1 sample and mix it with output buffer, then unsign it
0514   0000             ; = 46 (+11 when overflow)
0515   0000             
0516   0000                         macro readMixAndUnsign
0517   0000~            
0518   0000~                        LD      A, (DE)         ; read value in write buf   ' 7     |
0519   0000~                        ADD     (HL)            ; mix with source sample    ' 7+3   | (27)
0520   0000~                        JP      PO, .ok         ; check overflow            ' 10    |
0521   0000~            
0522   0000~                        LD      A, C            ; fix overflow              ' 4     |
0523   0000~                        ADC     $FF             ; A = $7F/$80               ' 7     | +11
0524   0000~            
0525   0000~            .ok
0526   0000~                        ADD     C               ; unsign                    ' 4     |
0527   0000~                        LD      (DE), A         ; write sample in buffer    ' 7     | 19 (46)
0528   0000~                        INC     E               ;                           ' 4     |
0529   0000~                        INC     L               ; next                      ' 4     |
0530   0000~            
0531   0000                         endm                    ;                           ' 46 (+11)
0532   0000             
0533   0000             
0534   0000             ; sampleOutput
0535   0000             ; ------------
0536   0000             ; YMPORT0     -> HL'
0537   0000             ; YMPORT1     -> DE'
0538   0000             ; read buffer -> BC' ->  read buffer
0539   0000             ;
0540   0000             ; output a sample to the DAC
0541   0000             ; = 36 cycles
0542   0000             
0543   0000                         macro sampleOutput
0544   0000~            
0545   0000~                        EXX                     ;                           ' 4     | 4
0546   0000~            
0547   0000~                        LD      A, (BC)         ; read sample from buffer   ' 7     |
0548   0000~                        INC     BC              ; increment read address    ' 6     |
0549   0000~                        RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
0550   0000~                        LD      (DE), A         ; play sample               ' 7     |
0551   0000~            
0552   0000~                        EXX                     ;                           ' 4     | (36)
0553   0000~            
0554   0000                         endm
0555   0000             
0556   0000             
0557   0000             ; sampleOutputSafe
0558   0000             ; ----------------
0559   0000             ; YMPORT0     -> HL'
0560   0000             ; YMPORT1     -> DE'
0561   0000             ; read buffer -> BC' ->  read buffer
0562   0000             ;
0563   0000             ; output a sample to the DAC
0564   0000             ; = 46 cycles
0565   0000             
0566   0000                         macro sampleOutputSafe
0567   0000~            
0568   0000~                        EXX                     ;                           ' 4     | 4
0569   0000~            
0570   0000~                        LD      (HL), $2A       ; prepare DAC write         ' 10    |
0571   0000~                        LD      A, (BC)         ; read sample from buffer   ' 7     |
0572   0000~                        INC     BC              ; increment read address    ' 6     | 38 (42)
0573   0000~                        RES     2, B            ; read_address &= 0x03FF    ' 8     |
0574   0000~                        LD      (DE), A         ; play sample               ' 7     |
0575   0000~            
0576   0000~                        EXX                     ;                           ' 4     | (46)
0577   0000~            
0578   0000                         endm
0579   0000             
0580   0000             
0581   0000             ; waitYMReadyFast
0582   0000             ; ---------------
0583   0000             ; YMPORT0   -> HL
0584   0000             ;
0585   0000             ; wait until YM ready
0586   0000             ; = 22 cycles minimum (22 * X)
0587   0000             
0588   0000                         macro waitYMReadyFast
0589   0000~            
0590   0000~            .wait
0591   0000~                        BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
0592   0000~                        JP      NZ, .wait       ; wait while busy           ' 10    |
0593   0000~            
0594   0000                         endm
0595   0000             
0596   0000             
0597   0000             ; waitYMReady
0598   0000             ; -----------
0599   0000             ; YMPORT0   -> HL'
0600   0000             ;
0601   0000             ; wait until YM ready
0602   0000             ; = 30 cycles minimum (8 + (22 * X))
0603   0000             
0604   0000                         macro waitYMReady
0605   0000~            
0606   0000~                        EXX                     ;                           ' 4     | (4)
0607   0000~            
0608   0000~            .wait
0609   0000~                        BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
0610   0000~                        JP      NZ, .wait       ; wait while busy           ' 10    |
0611   0000~            
0612   0000~                        EXX                     ;                           ' 4     | (30)
0613   0000~            
0614   0000                         endm
0615   0000             
0616   0000             
0617   0000             ; ###########################       init       ##############################
0618   0000             
0619   0000                         ORG     $0000
0620   0000             
0621   0000             init
0622   0000 F3                      DI                      ; disable ints
0623   0001 31 00 16                LD      SP, STACK       ; setup stack
0624   0004 ED 56                   IM      $01             ; set int mode 1
0625   0006 AF                      XOR     A
0626   0007 32 02 01                LD      (STATUS), A     ; driver not ready
0627   000A 32 00 01                LD      (COMMAND), A    ; command cleared
0628   000D C3 00 02                JP      start           ; jump to start
0629   0010             
0630   0010             
0631   0010             ; ###########################       main       ##############################
0632   0010             
0633   0010 00                      BLOCK   $0200-$
0634   0200             
0635   0200             start
0636   0200             
0637   0200 21 04 01                LD      HL, PARAMS
0638   0203 3E 00                   LD      A, $00
0639   0205 06 40                   LD      B, $40
0640   0207             
0641   0207             cp_loop
0642   0207 77                      LD      (HL), A         ; clear parameters
0643   0208 23                      INC     HL
0644   0209 10 FC                   DJNZ    cp_loop
0645   020B             
0646   020B 21 64 01                LD      HL, YM_RR_OFF
0647   020E 3E FF                   LD      A, $FF
0648   0210 06 18                   LD      B, (6 * 4)
0649   0212             
0650   0212             off_loop
0651   0212 77                      LD      (HL), A         ; clear off settings
0652   0213 23                      INC     HL
0653   0214 10 FC                   DJNZ    off_loop
0654   0216             
0655   0216 21 7C 01                LD      HL, PSG_ENV_OFF
0656   0219             
0657   0219 36 9F                   LD      (HL), $9F       ; PSG channel 0 off
0658   021B 23                      INC     HL
0659   021C 36 BF                   LD      (HL), $BF       ; PSG channel 1 off
0660   021E 23                      INC     HL
0661   021F 36 DF                   LD      (HL), $DF       ; PSG channel 2 off
0662   0221 23                      INC     HL
0663   0222 36 FF                   LD      (HL), $FF       ; PSG channel 3 off
0664   0224             
0665   0224 21 64 01                LD      HL, YM_RR_OFF
0666   0227 11 44 01                LD      DE, YM_RR_SAV
0667   022A 01 1C 00                LD      BC, (6 * 4) + 4
0668   022D ED B0                   LDIR                    ; copy off settings to sav settings
0669   022F             
0670   022F 21 00 18                LD      HL, PCM_BUFFER
0671   0232 3E 80                   LD      A, $80
0672   0234 06 00                   LD      B, $00          ; for 256 * 4 bytes to clear
0673   0236             
0674   0236             cb_loop
0675   0236 77                      LD      (HL), A         ; initialise buffers to silent
0676   0237 23                      INC     HL
0677   0238 77                      LD      (HL), A
0678   0239 23                      INC     HL
0679   023A 77                      LD      (HL), A
0680   023B 23                      INC     HL
0681   023C 77                      LD      (HL), A
0682   023D 23                      INC     HL
0683   023E 10 F6                   DJNZ    cb_loop
0684   0240             
0685   0240 3E 00                   LD      A, $00
0686   0242             
0687   0242 21 60 01                LD      HL, YM_2B_SAV
0688   0245 77                      LD      (HL), A         ; DAC disabled by default
0689   0246 21 61 01                LD      HL, YM_2B_CNT
0690   0249 77                      LD      (HL), A         ; DAC disabled by default
0691   024A             
0692   024A 21 12 01                LD      HL, MODIFYING_F
0693   024D 77                      LD      (HL), A         ; clear modifying variable flag
0694   024E 21 13 01                LD      HL, PENDING_FRM
0695   0251 77                      LD      (HL), A         ; clear frame to process counter
0696   0252             
0697   0252 CD C2 14                CALL    initDAC         ; prepare DAC for output
0698   0255             
0699   0255 21 00 18                LD      HL, PCM_BUFFER0 ; initialise write and read buffer
0700   0258 22 38 01                LD      (WRITEBUF), HL
0701   025B 21 00 19                LD      HL, PCM_BUFFER1
0702   025E 22 3A 01                LD      (READBUF), HL
0703   0261             
0704   0261 44 4D                   LD      BC, HL          ; BC' point to read buffer
0705   0263 21 00 40                LD      HL, YMPORT0     ; HL' point to YMPORT0
0706   0266 11 01 40                LD      DE, YMPORT1     ; DE' point to YMPORT1
0707   0269 D9                      EXX
0708   026A             
0709   026A                         stopChannel 0           ; stop all channels
0709   026A 2A 00 1C    >            LD      HL, (ID_TABLE+0)        ; HL = null PCM addr        ' 16    |
0709   026D 22 16 01    >            LD      (PCM_ADDR+(ch*8)), HL   ; set new PCM addr          ' 16    |
0709   0270 21 01 00    >            LD      HL, $0001               ; HL = null PCM len         ' 10    | (58)
0709   0273 22 18 01    >            LD      (PCM_LEN+(ch*8)), HL    ; set new PCM addr          ' 16    |
0709   0276 AF          >            XOR     A                       ;                           ' 4     |
0709   0277 32 14 01    >            LD      (PCM_PRIO+(ch*8)), A    ; clear prio                ' 13    | 17 (75)
0710   027A                         stopChannel 1
0710   027A 2A 00 1C    >            LD      HL, (ID_TABLE+0)        ; HL = null PCM addr        ' 16    |
0710   027D 22 1E 01    >            LD      (PCM_ADDR+(ch*8)), HL   ; set new PCM addr          ' 16    |
0710   0280 21 01 00    >            LD      HL, $0001               ; HL = null PCM len         ' 10    | (58)
0710   0283 22 20 01    >            LD      (PCM_LEN+(ch*8)), HL    ; set new PCM addr          ' 16    |
0710   0286 AF          >            XOR     A                       ;                           ' 4     |
0710   0287 32 1C 01    >            LD      (PCM_PRIO+(ch*8)), A    ; clear prio                ' 13    | 17 (75)
0711   028A                         stopChannel 2
0711   028A 2A 00 1C    >            LD      HL, (ID_TABLE+0)        ; HL = null PCM addr        ' 16    |
0711   028D 22 26 01    >            LD      (PCM_ADDR+(ch*8)), HL   ; set new PCM addr          ' 16    |
0711   0290 21 01 00    >            LD      HL, $0001               ; HL = null PCM len         ' 10    | (58)
0711   0293 22 28 01    >            LD      (PCM_LEN+(ch*8)), HL    ; set new PCM addr          ' 16    |
0711   0296 AF          >            XOR     A                       ;                           ' 4     |
0711   0297 32 24 01    >            LD      (PCM_PRIO+(ch*8)), A    ; clear prio                ' 13    | 17 (75)
0712   029A                         stopChannel 3
0712   029A 2A 00 1C    >            LD      HL, (ID_TABLE+0)        ; HL = null PCM addr        ' 16    |
0712   029D 22 2E 01    >            LD      (PCM_ADDR+(ch*8)), HL   ; set new PCM addr          ' 16    |
0712   02A0 21 01 00    >            LD      HL, $0001               ; HL = null PCM len         ' 10    | (58)
0712   02A3 22 30 01    >            LD      (PCM_LEN+(ch*8)), HL    ; set new PCM addr          ' 16    |
0712   02A6 AF          >            XOR     A                       ;                           ' 4     |
0712   02A7 32 2C 01    >            LD      (PCM_PRIO+(ch*8)), A    ; clear prio                ' 13    | 17 (75)
0713   02AA             
0714   02AA 3E 80                   LD      A, STATREADY
0715   02AC 32 02 01                LD      (STATUS), A     ; driver ready
0716   02AF             
0717   02AF             main_loop
0718   02AF             
0719   02AF             ;    LD  A, (VCOUNTER)
0720   02AF             ;    LD  (DEBUG_1), A
0721   02AF             
0722   02AF             
0723   02AF             ; prepare XGM buffer
0724   02AF             ; ------------------
0725   02AF             
0726   02AF             ; $00
0727   02AF                         sampleOutput                ;                       ' 36    | 36
0727   02AF D9          >            EXX                     ;                           ' 4     | 4
0727   02B0 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
0727   02B1 03          >            INC     BC              ; increment read address    ' 6     |
0727   02B2 CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
0727   02B4 12          >            LD      (DE), A         ; play sample               ' 7     |
0727   02B5 D9          >            EXX                     ;                           ' 4     | (36)
0728   02B6             
0729   02B6 11 00 17                LD      DE, XGM_BUFFER      ; DE point to XGM buf   ' 10    |
0730   02B9 3A 02 01                LD      A, (STATUS)         ; A = STATUS            ' 13    |
0731   02BC CB 77                   BIT     XGM_PLAY_SFT, A     ; is XGM playing ?      ' 8     | 41 (77)
0732   02BE C2 CA 02                JP      NZ, has_xgm         ; go to prepare buf     ' 10    |
0733   02C1             
0734   02C1                         wait146                     ; sync                  ' 146   |
0734   02C1 3E 09       >            LD      A, w            ; 7-2
0734   02C3 3D          >            DEC     A               ; 4
0734   02C4 20 FD       >            JR      NZ, .loop       ; 12
0735   02C6 AF                      XOR     A                   ; A = 0                 ' 4     | 160 (237)
0736   02C7 C3 D8 04                JP      end_prep_xgm        ; preparation done      ' 10    |
0737   02CA             
0738   02CA             has_xgm
0739   02CA 2A 34 01                LD      HL, (XGM_ADDR)      ; XGM addr (b0-b15)     ' 16    |
0740   02CD 7C                      LD      A, H                ; A = XGM addr (b8-b15) ' 4     |
0741   02CE 17                      RLA                         ; CF = XGM addr b15     ' 4     | 146 (223)
0742   02CF 3A 36 01                LD      A, (XGM_ADDR+2)     ; A = sample addr (H)   ' 13    |
0743   02D2 17                      RLA                         ; sample addr (b22-b15) ' 4     |
0744   02D3                         setBank_BC                  ; setBank               ' 105   |
0744   02D3 01 00 60    >            LD  BC, BANKREG         ; BC = BANKREG              ' 10
0744   02D6 02          >            LD  (BC), A             ; #1 (bit 15)               ' 7
0744   02D7 0F          >            RRCA                     ;                          ' 4
0744   02D8 02          >            LD  (BC), A             ; #2 (bit 16)               ' 7
0744   02D9 0F          >            RRCA                     ;                          ' 4
0744   02DA 02          >            LD  (BC), A             ; #3 (bit 17)               ' 7
0744   02DB 0F          >            RRCA                     ;                          ' 4
0744   02DC 02          >            LD  (BC), A             ; #4 (bit 18)               ' 7
0744   02DD 0F          >            RRCA                     ;                          ' 4
0744   02DE 02          >            LD  (BC), A             ; #5 (bit 19)               ' 7
0744   02DF 0F          >            RRCA                     ;                          ' 4
0744   02E0 02          >            LD  (BC), A             ; #6 (bit 20)               ' 7
0744   02E1 0F          >            RRCA                     ;                          ' 4
0744   02E2 02          >            LD  (BC), A             ; #7 (bit 21)               ' 7
0744   02E3 0F          >            RRCA                     ;                          ' 4
0744   02E4 02          >            LD  (BC), A             ; #8 (bit 22)               ' 7
0744   02E5 AF          >            XOR A                    ;                          ' 4
0744   02E6 02          >            LD  (BC), A             ; #9 (bit 23 = 0)           ' 7
0745   02E7             
0746   02E7 7C                      LD      A, H                ; save H                ' 4     |
0747   02E8 CB FC                   SET     7, H                ; HL = XGM addr bank    ' 8     |
0748   02EA 06 00                   LD      B, $0               ; B = 0                 ' 7     | 30 (254-1)
0749   02EC 4E                      LD      C, (HL)             ; BC = bytes to process ' 7     |
0750   02ED 67                      LD      H, A                ; restore H             ' 4     |
0751   02EE             
0752   02EE             ; $00+X
0753   02EE                         sampleOutput                ;                       ' 36    | (36-1)
0753   02EE D9          >            EXX                     ;                           ' 4     | 4
0753   02EF 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
0753   02F0 03          >            INC     BC              ; increment read address    ' 6     |
0753   02F1 CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
0753   02F3 12          >            LD      (DE), A         ; play sample               ' 7     |
0753   02F4 D9          >            EXX                     ;                           ' 4     | (36)
0754   02F5             
0755   02F5 7D                      LD      A, L                ; A = addr low          ' 4     |
0756   02F6 81                      ADD     C                   ; compute new addr (L)  ' 4     |
0757   02F7 32 34 01                LD      (XGM_ADDR+0), A     ; store new addr (L)    ' 13    | 28 (63)
0758   02FA 38 1A                   JR      C, .split           ; carry --> separate    ' 7     |
0759   02FC             
0760   02FC             .no_split
0761   02FC                         wait104                     ; sync                  ' 104   | (167)
0761   02FC 3E 05       >            LD      A, w            ; 7-2
0761   02FE 3D          >            DEC     A               ; 4
0761   02FF 20 FD       >            JR      NZ, .loop       ; 12
0761   0301 ED 4F       >            LD      R, A
0761   0303 ED 4F       >            LD      R, A
0761   0305 00          >            NOP
0762   0306             
0763   0306 CB FC                   SET     7, H                ; HL = XGM addr bank    ' 8     |
0764   0308 23                      INC     HL                  ; HL = start frame data ' 6     |
0765   0309 AF                      XOR     A                   ; no second part        ' 4     |
0766   030A FD 67                   LD      IYH, A              ; IYH = sec part size   ' 8     | 44 (211)
0767   030C 00                      NOP                         ;                       ' 4     |
0768   030D 0D                      DEC     C                   ; first part size = 0 ? ' 4     |
0769   030E CA F5 03                JP      Z, .second_part     ; go to second part     ' 10    |
0770   0311             
0771   0311                         wait12                      ; sync                  ' 12    | 22 (233)
0771   0311 18 00       >            JR      .go
0772   0313 C3 54 03                JP      .first_part_pre     ; start filling         ' 10    |
0773   0316             
0774   0316             .split
0775   0316 FD 67                   LD      IYH, A              ; IYH = sec part size   ' 8     |
0776   0318 91                      SUB     C                   ;                       ' 4     |
0777   0319 ED 44                   NEG                         ;                       ' 8     | 34 (97)
0778   031B 3D                      DEC     A                   ; A = (C - IYH) - 1     ' 4     |
0779   031C C2 3A 03                JP      NZ, .first_part_ok  ; not zero --> do it    ' 10    |
0780   031F             
0781   031F 7C                      LD      A, H                ; A = addr med (M)      ' 4     |
0782   0320 C6 01                   ADD     $1                  ; inc with CF set       ' 7     |
0783   0322 32 35 01                LD      (XGM_ADDR+1), A     ; store new addr (M)    ' 13    |
0784   0325 3A 36 01                LD      A, (XGM_ADDR+2)     ; load sample addr (H)  ' 13    |
0785   0328 88                      ADC     B                   ; inc                   ' 4     | 68 (164)
0786   0329 32 36 01                LD      (XGM_ADDR+2), A     ; store sample addr (H) ' 13    |
0787   032C CB FC                   SET     7, H                ; HL = XGM addr bank    ' 8     |
0788   032E 23                      INC     HL                  ; HL = start frame data ' 6     |
0789   032F             
0790   032F                         wait36                      ; sync                  ' 36    |
0790   032F ED 4F       >            LD      R, A
0790   0331 ED 4F       >            LD      R, A
0790   0333 ED 4F       >            LD      R, A
0790   0335 ED 4F       >            LD      R, A
0791   0337 C3 F5 03                JP      .second_part        ; go second part        ' 10    | 65 (211)
0792   033A             
0793   033A             .first_part_ok
0794   033A 4F                      LD      C, A                ; C = first part size   ' 4     |
0795   033B 7C                      LD      A, H                ; A = addr med (M)      ' 4     |
0796   033C C6 01                   ADD     $1                  ; inc with CF set       ' 7     |
0797   033E 32 35 01                LD      (XGM_ADDR+1), A     ; store new addr (M)    ' 13    |
0798   0341 3A 36 01                LD      A, (XGM_ADDR+2)     ; load sample addr (H)  ' 13    | 72 (169)
0799   0344 88                      ADC     B                   ; inc                   ' 4     |
0800   0345 32 36 01                LD      (XGM_ADDR+2), A     ; store sample addr (H) ' 13    |
0801   0348 CB FC                   SET     7, H                ; HL = XGM addr bank    ' 8     |
0802   034A 23                      INC     HL                  ; HL = start frame data ' 6     |
0803   034B             
0804   034B                         wait64                      ; sync                  ' 64    | (233)
0804   034B 3E 03       >            LD      A, w            ; 7-2
0804   034D 3D          >            DEC     A               ; 4
0804   034E 20 FD       >            JR      NZ, .loop       ; 12
0804   0350 F6 00       >            OR      $0
0804   0352 F6 00       >            OR      $0
0805   0354             
0806   0354             .first_part_pre                         ;                       ' 233
0807   0354 3E 0B                   LD      A, 11               ; A = block fill size   ' 7     |
0808   0356 B9                      CP      C                   ; C < block size        ' 4     | 21 (254)
0809   0357 D2 80 03                JP      NC, .first_part_end ; go to last bytes      ' 10    |
0810   035A             
0811   035A             .first_part
0812   035A             ; $00+X
0813   035A                         sampleOutput                ;                       ' 36    | 36
0813   035A D9          >            EXX                     ;                           ' 4     | 4
0813   035B 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
0813   035C 03          >            INC     BC              ; increment read address    ' 6     |
0813   035D CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
0813   035F 12          >            LD      (DE), A         ; play sample               ' 7     |
0813   0360 D9          >            EXX                     ;                           ' 4     | (36)
0814   0361             
0815   0361 ED A0                   LDI                         ; fill XGM buffer       ' 16+1  |
0816   0363 ED A0                   LDI                         ; 11 bytes at once      ' 16+1  |
0817   0365 ED A0                   LDI                         ;                       ' 16+1  |
0818   0367 ED A0                   LDI                         ;                       ' 16+1  |
0819   0369 ED A0                   LDI                         ;                       ' 16+1  |
0820   036B ED A0                   LDI                         ;                       ' 16+1  | 187 (223)
0821   036D ED A0                   LDI                         ;                       ' 16+1  |
0822   036F ED A0                   LDI                         ;                       ' 16+1  |
0823   0371 ED A0                   LDI                         ;                       ' 16+1  |
0824   0373 ED A0                   LDI                         ;                       ' 16+1  |
0825   0375 ED A0                   LDI                         ;                       ' 16+1  |
0826   0377             
0827   0377                         wait10                      ; sync                  ' 10    |
0827   0377 C3 7A 03    >            JP      .go
0828   037A 3E 0B                   LD      A, 11               ; A = block fill size   ' 7     |
0829   037C B9                      CP      C                   ; remaining > 11        ' 4     | 31 (254)
0830   037D DA 5A 03                JP      C, .first_part      ; continu block fill    ' 10    |
0831   0380             
0832   0380             .first_part_end
0833   0380             ; $00+X
0834   0380                         sampleOutput                ;                       ' 36    | 36
0834   0380 D9          >            EXX                     ;                           ' 4     | 4
0834   0381 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
0834   0382 03          >            INC     BC              ; increment read address    ' 6     |
0834   0383 CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
0834   0385 12          >            LD      (DE), A         ; play sample               ' 7     |
0834   0386 D9          >            EXX                     ;                           ' 4     | (36)
0835   0387             
0836   0387 ED A0                   LDI                         ; fill XGM buffer       ' 16+1  |
0837   0389 E2 D4 03                JP      PO, .fst_part_d0    ;                       ' 10    | 27 (63)
0838   038C ED A0                   LDI                         ;                       ' 16+1  |
0839   038E E2 DA 03                JP      PO, .fst_part_d1    ;                       ' 10    | 27 (90)
0840   0391 ED A0                   LDI                         ;                       ' 16+1  |
0841   0393 E2 E0 03                JP      PO, .fst_part_d2    ;                       ' 10    | 27 (117)
0842   0396 ED A0                   LDI                         ;                       ' 16+1  |
0843   0398 E2 E6 03                JP      PO, .fst_part_d3    ;                       ' 10    | 27 (144)
0844   039B ED A0                   LDI                         ;                       ' 16+1  |
0845   039D E2 EC 03                JP      PO, .fst_part_d4    ;                       ' 10    | 27 (171)
0846   03A0 ED A0                   LDI                         ;                       ' 16+1  |
0847   03A2 E2 F2 03                JP      PO, .fst_part_d5    ;                       ' 10    | 27 (198)
0848   03A5             
0849   03A5                         wait56                      ; sync                  ' 56    | (254)
0849   03A5 3E 02       >            LD      A, w            ; 7-2
0849   03A7 3D          >            DEC     A               ; 4
0849   03A8 20 FD       >            JR      NZ, .loop       ; 12
0849   03AA ED 4F       >            LD      R, A
0849   03AC ED 4F       >            LD      R, A
0849   03AE 00          >            NOP
0850   03AF             
0851   03AF             ; $00+X
0852   03AF                         sampleOutput                ;                       ' 36    | 36
0852   03AF D9          >            EXX                     ;                           ' 4     | 4
0852   03B0 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
0852   03B1 03          >            INC     BC              ; increment read address    ' 6     |
0852   03B2 CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
0852   03B4 12          >            LD      (DE), A         ; play sample               ' 7     |
0852   03B5 D9          >            EXX                     ;                           ' 4     | (36)
0853   03B6             
0854   03B6 ED A0                   LDI                         ; fill XGM buffer       ' 16+1  |
0855   03B8 E2 D4 03                JP      PO, .fst_part_d0    ;                       ' 10    | 27 (63)
0856   03BB ED A0                   LDI                         ;                       ' 16+1  |
0857   03BD E2 DA 03                JP      PO, .fst_part_d1    ;                       ' 10    | 27 (90)
0858   03C0 ED A0                   LDI                         ;                       ' 16+1  |
0859   03C2 E2 E0 03                JP      PO, .fst_part_d2    ;                       ' 10    | 27 (117)
0860   03C5 ED A0                   LDI                         ;                       ' 16+1  |
0861   03C7 E2 E6 03                JP      PO, .fst_part_d3    ;                       ' 10    | 27 (144)
0862   03CA ED A0                   LDI                         ;                       ' 16+1  |
0863   03CC E2 EC 03                JP      PO, .fst_part_d4    ;                       ' 10    | 27 (171)
0864   03CF ED A0                   LDI                         ;                       ' 16+1  |
0865   03D1 C3 F2 03                JP      .fst_part_d5        ;                       ' 10    | 27 (198)
0866   03D4             
0867   03D4             .fst_part_d0
0868   03D4                         wait27                      ; sync                  ' 27    | (90)
0868   03D4 ED 4F       >            LD      R, A
0868   03D6 ED 4F       >            LD      R, A
0868   03D8 ED 4F       >            LD      R, A
0869   03DA             .fst_part_d1
0870   03DA                         wait27                      ; sync                  ' 27    | (117)
0870   03DA ED 4F       >            LD      R, A
0870   03DC ED 4F       >            LD      R, A
0870   03DE ED 4F       >            LD      R, A
0871   03E0             .fst_part_d2
0872   03E0                         wait27                      ; sync                  ' 27    | (144)
0872   03E0 ED 4F       >            LD      R, A
0872   03E2 ED 4F       >            LD      R, A
0872   03E4 ED 4F       >            LD      R, A
0873   03E6             .fst_part_d3
0874   03E6                         wait27                      ; sync                  ' 27    | (171)
0874   03E6 ED 4F       >            LD      R, A
0874   03E8 ED 4F       >            LD      R, A
0874   03EA ED 4F       >            LD      R, A
0875   03EC             .fst_part_d4
0876   03EC                         wait27                      ; sync                  ' 27    | (198)
0876   03EC ED 4F       >            LD      R, A
0876   03EE ED 4F       >            LD      R, A
0876   03F0 ED 4F       >            LD      R, A
0877   03F2             .fst_part_d5
0878   03F2                         wait13                      ; sync                  ' 13    | (211)
0878   03F2 ED 4F       >            LD      R, A
0878   03F4 00          >            NOP
0879   03F5             
0880   03F5             .second_part                            ;                       ' 211
0881   03F5 00                      NOP                         ; sync                  ' 4
0882   03F6 FD 7C                   LD      A, IYH              ; A = second part size  ' 8     |
0883   03F8 B7                      OR      A                   ;                       ' 4     | 26 (237)
0884   03F9 CA D8 04                JP      Z, end_prep_xgm     ; done                  ' 10    |
0885   03FC             
0886   03FC                         wait17                      ; sync                  ' 17    | 254
0886   03FC C3 FF 03    >            JP      .go
0886   03FF F6 00       >            OR      $0
0887   0401             
0888   0401             ; $00+X
0889   0401                         sampleOutput                ;                       ' 36    | 36
0889   0401 D9          >            EXX                     ;                           ' 4     | 4
0889   0402 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
0889   0403 03          >            INC     BC              ; increment read address    ' 6     |
0889   0404 CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
0889   0406 12          >            LD      (DE), A         ; play sample               ' 7     |
0889   0407 D9          >            EXX                     ;                           ' 4     | (36)
0890   0408             
0891   0408 2A 34 01                LD      HL, (XGM_ADDR)      ; XGM addr (b0-b15)     ' 16    |
0892   040B 7C                      LD      A, H                ; A = XGM addr (b8-b15) ' 4     |
0893   040C 17                      RLA                         ; CF = XGM addr b15     ' 4     | 146 (182)
0894   040D 3A 36 01                LD      A, (XGM_ADDR+2)     ; A = sample addr (H)   ' 13    |
0895   0410 17                      RLA                         ; sample addr (b22-b15) ' 4     |
0896   0411                         setBank_BC                  ; setBank               ' 105   |
0896   0411 01 00 60    >            LD  BC, BANKREG         ; BC = BANKREG              ' 10
0896   0414 02          >            LD  (BC), A             ; #1 (bit 15)               ' 7
0896   0415 0F          >            RRCA                     ;                          ' 4
0896   0416 02          >            LD  (BC), A             ; #2 (bit 16)               ' 7
0896   0417 0F          >            RRCA                     ;                          ' 4
0896   0418 02          >            LD  (BC), A             ; #3 (bit 17)               ' 7
0896   0419 0F          >            RRCA                     ;                          ' 4
0896   041A 02          >            LD  (BC), A             ; #4 (bit 18)               ' 7
0896   041B 0F          >            RRCA                     ;                          ' 4
0896   041C 02          >            LD  (BC), A             ; #5 (bit 19)               ' 7
0896   041D 0F          >            RRCA                     ;                          ' 4
0896   041E 02          >            LD  (BC), A             ; #6 (bit 20)               ' 7
0896   041F 0F          >            RRCA                     ;                          ' 4
0896   0420 02          >            LD  (BC), A             ; #7 (bit 21)               ' 7
0896   0421 0F          >            RRCA                     ;                          ' 4
0896   0422 02          >            LD  (BC), A             ; #8 (bit 22)               ' 7
0896   0423 AF          >            XOR A                    ;                          ' 4
0896   0424 02          >            LD  (BC), A             ; #9 (bit 23 = 0)           ' 7
0897   0425             
0898   0425 CB FC                   SET     7, H                ; HL = XGM addr bank    ' 8     | 15 (197)
0899   0427 2E 00                   LD      L, 0                ;                       ' 7     |
0900   0429             
0901   0429                         wait21                      ; sync                  ' 21    | (218)
0901   0429 18 00       >            JR      .go
0901   042B ED 4F       >            LD      R, A
0902   042D             
0903   042D 06 00                   LD      B, 0                ; B = 0                 ' 7     |
0904   042F FD 4C                   LD      C, IYH              ; BC = second part size ' 8     |
0905   0431 3E 0B                   LD      A, 11               ; A = block fill size   ' 7     | 36 (254)
0906   0433 B9                      CP      C                   ; C < block size        ' 4     |
0907   0434 D2 5D 04                JP      NC, .sec_part_end   ; go to last bytes      ' 10    |
0908   0437             
0909   0437             ; $00+X
0910   0437             .sec_part_loop
0911   0437                         sampleOutput                ;                       ' 36    | 36
0911   0437 D9          >            EXX                     ;                           ' 4     | 4
0911   0438 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
0911   0439 03          >            INC     BC              ; increment read address    ' 6     |
0911   043A CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
0911   043C 12          >            LD      (DE), A         ; play sample               ' 7     |
0911   043D D9          >            EXX                     ;                           ' 4     | (36)
0912   043E             
0913   043E ED A0                   LDI                         ; fill XGM buffer       ' 16+1  |
0914   0440 ED A0                   LDI                         ; 11 bytes at once      ' 16+1  |
0915   0442 ED A0                   LDI                         ;                       ' 16+1  |
0916   0444 ED A0                   LDI                         ;                       ' 16+1  |
0917   0446 ED A0                   LDI                         ;                       ' 16+1  |
0918   0448 ED A0                   LDI                         ;                       ' 16+1  | 187 (223)
0919   044A ED A0                   LDI                         ;                       ' 16+1  |
0920   044C ED A0                   LDI                         ;                       ' 16+1  |
0921   044E ED A0                   LDI                         ;                       ' 16+1  |
0922   0450 ED A0                   LDI                         ;                       ' 16+1  |
0923   0452 ED A0                   LDI                         ;                       ' 16+1  |
0924   0454             
0925   0454                         wait10                      ; sync                  ' 10    |
0925   0454 C3 57 04    >            JP      .go
0926   0457 3E 0B                   LD      A, 11               ; A = block fill size   ' 7     |
0927   0459 B9                      CP      C                   ; remaining > 11        ' 4     | 31 (254)
0928   045A DA 37 04                JP      C, .sec_part_loop   ; continu block fill    ' 10    |
0929   045D             
0930   045D             .sec_part_end
0931   045D             ; $00+X
0932   045D                         sampleOutput                ;                       ' 36    | 36
0932   045D D9          >            EXX                     ;                           ' 4     | 4
0932   045E 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
0932   045F 03          >            INC     BC              ; increment read address    ' 6     |
0932   0460 CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
0932   0462 12          >            LD      (DE), A         ; play sample               ' 7     |
0932   0463 D9          >            EXX                     ;                           ' 4     | (36)
0933   0464             
0934   0464 ED A0                   LDI                         ; fill XGM buffer       ' 16+1  |
0935   0466 E2 B1 04                JP      PO, .sec_part_d0    ;                       ' 10    | 27 (63)
0936   0469 ED A0                   LDI                         ;                       ' 16+1  |
0937   046B E2 B7 04                JP      PO, .sec_part_d1    ;                       ' 10    | 27 (90)
0938   046E ED A0                   LDI                         ;                       ' 16+1  |
0939   0470 E2 BD 04                JP      PO, .sec_part_d2    ;                       ' 10    | 27 (117)
0940   0473 ED A0                   LDI                         ;                       ' 16+1  |
0941   0475 E2 C3 04                JP      PO, .sec_part_d3    ;                       ' 10    | 27 (144)
0942   0478 ED A0                   LDI                         ;                       ' 16+1  |
0943   047A E2 C9 04                JP      PO, .sec_part_d4    ;                       ' 10    | 27 (171)
0944   047D ED A0                   LDI                         ;                       ' 16+1  |
0945   047F E2 CF 04                JP      PO, .sec_part_d5    ;                       ' 10    | 27 (198)
0946   0482             
0947   0482                         wait56                      ; sync                  ' 56    | (254)
0947   0482 3E 02       >            LD      A, w            ; 7-2
0947   0484 3D          >            DEC     A               ; 4
0947   0485 20 FD       >            JR      NZ, .loop       ; 12
0947   0487 ED 4F       >            LD      R, A
0947   0489 ED 4F       >            LD      R, A
0947   048B 00          >            NOP
0948   048C             
0949   048C             ; $00+X
0950   048C                         sampleOutput                ;                       ' 36    | 36
0950   048C D9          >            EXX                     ;                           ' 4     | 4
0950   048D 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
0950   048E 03          >            INC     BC              ; increment read address    ' 6     |
0950   048F CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
0950   0491 12          >            LD      (DE), A         ; play sample               ' 7     |
0950   0492 D9          >            EXX                     ;                           ' 4     | (36)
0951   0493             
0952   0493 ED A0                   LDI                         ; fill XGM buffer       ' 16+1  |
0953   0495 E2 B1 04                JP      PO, .sec_part_d0    ;                       ' 10    | 27 (63)
0954   0498 ED A0                   LDI                         ;                       ' 16+1  |
0955   049A E2 B7 04                JP      PO, .sec_part_d1    ;                       ' 10    | 27 (90)
0956   049D ED A0                   LDI                         ;                       ' 16+1  |
0957   049F E2 BD 04                JP      PO, .sec_part_d2    ;                       ' 10    | 27 (117)
0958   04A2 ED A0                   LDI                         ;                       ' 16+1  |
0959   04A4 E2 C3 04                JP      PO, .sec_part_d3    ;                       ' 10    | 27 (144)
0960   04A7 ED A0                   LDI                         ;                       ' 16+1  |
0961   04A9 E2 C9 04                JP      PO, .sec_part_d4    ;                       ' 10    | 27 (171)
0962   04AC ED A0                   LDI                         ;                       ' 16+1  |
0963   04AE C3 CF 04                JP      .sec_part_d5        ;                       ' 10    | 27 (198)
0964   04B1             
0965   04B1             .sec_part_d0
0966   04B1                         wait27                      ; sync                  '       | (90)
0966   04B1 ED 4F       >            LD      R, A
0966   04B3 ED 4F       >            LD      R, A
0966   04B5 ED 4F       >            LD      R, A
0967   04B7             .sec_part_d1
0968   04B7                         wait27                      ; sync                  '       | (117)
0968   04B7 ED 4F       >            LD      R, A
0968   04B9 ED 4F       >            LD      R, A
0968   04BB ED 4F       >            LD      R, A
0969   04BD             .sec_part_d2
0970   04BD                         wait27                      ; sync                  '       | (144)
0970   04BD ED 4F       >            LD      R, A
0970   04BF ED 4F       >            LD      R, A
0970   04C1 ED 4F       >            LD      R, A
0971   04C3             .sec_part_d3
0972   04C3                         wait27                      ; sync                  '       | (171)
0972   04C3 ED 4F       >            LD      R, A
0972   04C5 ED 4F       >            LD      R, A
0972   04C7 ED 4F       >            LD      R, A
0973   04C9             .sec_part_d4
0974   04C9                         wait27                      ; sync                  '       | (198)
0974   04C9 ED 4F       >            LD      R, A
0974   04CB ED 4F       >            LD      R, A
0974   04CD ED 4F       >            LD      R, A
0975   04CF             .sec_part_d5
0976   04CF                         wait35                      ; sync                  ' 35    |
0976   04CF 18 00       >            JR      .go
0976   04D1 ED 4F       >            LD      R, A
0976   04D3 F6 00       >            OR      $0
0976   04D5 F6 00       >            OR      $0
0977   04D7 AF                      XOR     A                   ; A = 0                 ' 4     | 39 (237)
0978   04D8             
0979   04D8             end_prep_xgm                            ;                       ' 237
0980   04D8 12                      LD      (DE), A             ; XGM buf end with 0    ' 7     |
0981   04D9                         wait10                      ; sync                  ' 10    | 17 (254)
0981   04D9 C3 DC 04    >            JP      .go
0982   04DC             
0983   04DC             
0984   04DC             ; XGM PREP DONE
0985   04DC             ; -------------
0986   04DC             
0987   04DC             ; $01+x
0988   04DC                         sampleOutput                ;                       ' 36    | (36)
0988   04DC D9          >            EXX                     ;                           ' 4     | 4
0988   04DD 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
0988   04DE 03          >            INC     BC              ; increment read address    ' 6     |
0988   04DF CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
0988   04E1 12          >            LD      (DE), A         ; play sample               ' 7     |
0988   04E2 D9          >            EXX                     ;                           ' 4     | (36)
0989   04E3             
0990   04E3 3A 02 01                LD      A, (STATUS)         ; A = STATUS            ' 13    |
0991   04E6 CB 77                   BIT     XGM_PLAY_SFT, A     ; XGM playing ?         ' 8     | 31 (67)
0992   04E8 C2 F7 04                JP      NZ, .inc            ; count elapsed         ' 10    |
0993   04EB             
0994   04EB                         wait71                      ; sync                  ' 71    | 81 (148)
0994   04EB 3E 03       >            LD      A, w            ; 7-2
0994   04ED 3D          >            DEC     A               ; 4
0994   04EE 20 FD       >            JR      NZ, .loop       ; 12
0994   04F0 18 00       >            JR      .go
0994   04F2 ED 4F       >            LD      R, A
0995   04F4 C3 08 05                JP      .noinc              ; preparation done      ' 10    |
0996   04F7             
0997   04F7             .inc
0998   04F7 21 94 01                LD      HL, ELAPSED         ;                       ' 10    | (77)
0999   04FA             
1000   04FA 7E                      LD      A, (HL)             ;                       ' 7     |
1001   04FB C6 01                   ADD     A, #1               ;                       ' 7     |
1002   04FD 77                      LD      (HL), A             ;                       ' 7     |
1003   04FE 2C                      INC     L                   ;                       ' 4     |
1004   04FF 7E                      LD      A, (HL)             ;                       ' 7     |
1005   0500 CE 00                   ADC     A, #0               ; inc elapsed frame     ' 7     | 71 (148)
1006   0502 77                      LD      (HL), A             ; (24 bit counter)      ' 7     |
1007   0503 2C                      INC     L                   ;                       ' 4     |
1008   0504 7E                      LD      A, (HL)             ;                       ' 7     |
1009   0505 CE 00                   ADC     A, #0               ;                       ' 7     |
1010   0507 77                      LD      (HL), A             ;                       ' 7     |
1011   0508             
1012   0508             .noinc
1013   0508                         wait60                      ; sync                  ' 60    | (208)
1013   0508 3E 03       >            LD      A, w            ; 7-2
1013   050A 3D          >            DEC     A               ; 4
1013   050B 20 FD       >            JR      NZ, .loop       ; 12
1013   050D C3 10 05    >            JP      .go
1014   0510             
1015   0510 ED 5B 38 01             LD      DE, (WRITEBUF)      ; DE = write buf        ' 20    |
1016   0514                         compareReadWrite            ; PCM buffer full ?     ' 16    | 46 (254)
1016   0514 D9          >            EXX                     ;                           ' 4     |
1016   0515 78          >            LD      A, B            ; A = read buffer high      ' 4     |
1016   0516 D9          >            EXX                     ;                           ' 4     | 16
1016   0517 BA          >            CP      D               ; compare write buffer high ' 4     |
1017   0518 CA EC 09                JP      Z, sync_frame       ; go to sync directly   ' 10    |
1018   051B             
1019   051B             pcm_mix
1020   051B             
1021   051B             ; PCM channel 0
1022   051B             ; -------------
1023   051B             
1024   051B             ; $02+X
1025   051B                         sampleOutput                ;                       ' 36    |
1025   051B D9          >            EXX                     ;                           ' 4     | 4
1025   051C 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
1025   051D 03          >            INC     BC              ; increment read address    ' 6     |
1025   051E CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
1025   0520 12          >            LD      (DE), A         ; play sample               ' 7     |
1025   0521 D9          >            EXX                     ;                           ' 4     | (36)
1026   0522                         prepareChannelAlt 0         ;                       ' 176   |
1026   0522 2A 16 01    >            LD      HL, (PCM_ADDR+(ch*8))   ; HL = sample addr (HM) ' 16    | (16)
1026   0525 7D          >            LD      A, L                    ; A = bit 8-15          ' 4     |
1026   0526 17          >            RLA                             ; C flag = bit 15       ' 4     |
1026   0527 7C          >            LD      A, H                    ; A = bit 16-23         ' 4     | 16 (32)
1026   0528 17          >            RLA                             ; A = bit 15-22         ' 4     |
1026   0529 11 00 60    >            LD  DE, BANKREG         ; DE = BANKREG              ' 10
1026   052C 12          >            LD  (DE), A             ; #1 (bit 15)               ' 7
1026   052D 0F          >            RRCA                     ;                          ' 4
1026   052E 12          >            LD  (DE), A             ; #2 (bit 16)               ' 7
1026   052F 0F          >            RRCA                     ;                          ' 4
1026   0530 12          >            LD  (DE), A             ; #3 (bit 17)               ' 7
1026   0531 0F          >            RRCA                     ;                          ' 4
1026   0532 12          >            LD  (DE), A             ; #4 (bit 18)               ' 7
1026   0533 0F          >            RRCA                     ;                          ' 4
1026   0534 12          >            LD  (DE), A             ; #5 (bit 19)               ' 7
1026   0535 0F          >            RRCA                     ;                          ' 4
1026   0536 12          >            LD  (DE), A             ; #6 (bit 20)               ' 7
1026   0537 0F          >            RRCA                     ;                          ' 4
1026   0538 12          >            LD  (DE), A             ; #7 (bit 21)               ' 7
1026   0539 0F          >            RRCA                     ;                          ' 4
1026   053A 12          >            LD  (DE), A             ; #8 (bit 22)               ' 7
1026   053B AF          >            XOR A                    ;                          ' 4
1026   053C 12          >            LD  (DE), A             ; #9 (bit 23 = 0)           ' 7
1026   053D 65          >            LD      H, L                    ;                       ' 4     |
1026   053E CB FC       >            SET     7, H                    ; HL |= 0x8000          ' 8     | 19 (156)
1026   0540 2E 00       >            LD      L, 0                    ; HL = sample addr bank ' 7     |
1026   0542 ED 5B 38 01 >            LD      DE, (WRITEBUF)          ; DE = write buffer     ' 20    | (176)
1027   0546 01 F2 00                LD      BC, 242             ; prepare loop counter  ' 10    | 254
1028   0549                         wait32                      ; sync                  ' 32    |
1028   0549 F6 00       >            OR      $0
1028   054B 00          >            NOP
1028   054C ED 4F       >            LD      R, A
1028   054E 18 00       >            JR      .go
1029   0550             
1030   0550             ; $03-$18+X
1031   0550             .loop_ch0
1032   0550                         sampleOutput                ;                       ' 36    |
1032   0550 D9          >            EXX                     ;                           ' 4     | 4
1032   0551 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
1032   0552 03          >            INC     BC              ; increment read address    ' 6     |
1032   0553 CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
1032   0555 12          >            LD      (DE), A         ; play sample               ' 7     |
1032   0556 D9          >            EXX                     ;                           ' 4     | (36)
1033   0557                         readAndClear2               ;                       ' 38    |
1033   0557 ED A0       >            LDI                     ;                           ' 16+3  |
1033   0559 ED A0       >            LDI                     ;                           ' 16+3  | (38)
1034   055B                         readAndClear2               ; process 11 samples    ' 38    |
1034   055B ED A0       >            LDI                     ;                           ' 16+3  |
1034   055D ED A0       >            LDI                     ;                           ' 16+3  | (38)
1035   055F                         readAndClear2               ;                       ' 38    | 254-1
1035   055F ED A0       >            LDI                     ;                           ' 16+3  |
1035   0561 ED A0       >            LDI                     ;                           ' 16+3  | (38)
1036   0563                         readAndClear2               ;                       ' 38    |
1036   0563 ED A0       >            LDI                     ;                           ' 16+3  |
1036   0565 ED A0       >            LDI                     ;                           ' 16+3  | (38)
1037   0567                         readAndClear2               ;                       ' 38    |
1037   0567 ED A0       >            LDI                     ;                           ' 16+3  |
1037   0569 ED A0       >            LDI                     ;                           ' 16+3  | (38)
1038   056B                         readAndClear                ;                       ' 19    |
1038   056B ED A0       >            LDI                     ;                           ' 16+3  | 19
1039   056D                         wait8                       ; sync                  ' 8     |
1039   056D 00          >            NOP
1039   056E 00          >            NOP
1040   056F             
1041   056F                         sampleOutput                ; -1 --> a bit early    ' 36    |
1041   056F D9          >            EXX                     ;                           ' 4     | 4
1041   0570 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
1041   0571 03          >            INC     BC              ; increment read address    ' 6     |
1041   0572 CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
1041   0574 12          >            LD      (DE), A         ; play sample               ' 7     |
1041   0575 D9          >            EXX                     ;                           ' 4     | (36)
1042   0576                         readAndClear2               ;                       ' 38    |
1042   0576 ED A0       >            LDI                     ;                           ' 16+3  |
1042   0578 ED A0       >            LDI                     ;                           ' 16+3  | (38)
1043   057A                         readAndClear2               ; process 11 samples    ' 38    |
1043   057A ED A0       >            LDI                     ;                           ' 16+3  |
1043   057C ED A0       >            LDI                     ;                           ' 16+3  | (38)
1044   057E                         readAndClear2               ;                       ' 38    | 254+1
1044   057E ED A0       >            LDI                     ;                           ' 16+3  |
1044   0580 ED A0       >            LDI                     ;                           ' 16+3  | (38)
1045   0582                         readAndClear2               ;                       ' 38    |
1045   0582 ED A0       >            LDI                     ;                           ' 16+3  |
1045   0584 ED A0       >            LDI                     ;                           ' 16+3  | (38)
1046   0586                         readAndClear2               ;                       ' 38    |
1046   0586 ED A0       >            LDI                     ;                           ' 16+3  |
1046   0588 ED A0       >            LDI                     ;                           ' 16+3  | (38)
1047   058A                         readAndClear                ;                       ' 19    |
1047   058A ED A0       >            LDI                     ;                           ' 16+3  | 19
1048   058C EA 50 05                JP      PE, .loop_ch0       ;                       ' 10    |
1049   058F             
1050   058F             ; $19+X
1051   058F                         sampleOutput                ;                       ' 36    |
1051   058F D9          >            EXX                     ;                           ' 4     | 4
1051   0590 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
1051   0591 03          >            INC     BC              ; increment read address    ' 6     |
1051   0592 CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
1051   0594 12          >            LD      (DE), A         ; play sample               ' 7     |
1051   0595 D9          >            EXX                     ;                           ' 4     | (36)
1052   0596                         readAndClear2               ;                       ' 38    |
1052   0596 ED A0       >            LDI                     ;                           ' 16+3  |
1052   0598 ED A0       >            LDI                     ;                           ' 16+3  | (38)
1053   059A                         readAndClear2               ; process 10 samples    ' 38    |
1053   059A ED A0       >            LDI                     ;                           ' 16+3  |
1053   059C ED A0       >            LDI                     ;                           ' 16+3  | (38)
1054   059E                         readAndClear2               ;                       ' 38    | 254+10
1054   059E ED A0       >            LDI                     ;                           ' 16+3  |
1054   05A0 ED A0       >            LDI                     ;                           ' 16+3  | (38)
1055   05A2                         readAndClear2               ;                       ' 38    |
1055   05A2 ED A0       >            LDI                     ;                           ' 16+3  |
1055   05A4 ED A0       >            LDI                     ;                           ' 16+3  | (38)
1056   05A6                         readAndClear2               ;                       ' 38    |
1056   05A6 ED A0       >            LDI                     ;                           ' 16+3  |
1056   05A8 ED A0       >            LDI                     ;                           ' 16+3  | (38)
1057   05AA                         readAndClear2               ;                       ' 38    |
1057   05AA ED A0       >            LDI                     ;                           ' 16+3  |
1057   05AC ED A0       >            LDI                     ;                           ' 16+3  | (38)
1058   05AE             
1059   05AE             ; $1A+X
1060   05AE                         sampleOutput                ; +10 --> too late      ' 36+10 |
1060   05AE D9          >            EXX                     ;                           ' 4     | 4
1060   05AF 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
1060   05B0 03          >            INC     BC              ; increment read address    ' 6     |
1060   05B1 CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
1060   05B3 12          >            LD      (DE), A         ; play sample               ' 7     |
1060   05B4 D9          >            EXX                     ;                           ' 4     | (36)
1061   05B5                         readAndClear2               ;                       ' 38    |
1061   05B5 ED A0       >            LDI                     ;                           ' 16+3  |
1061   05B7 ED A0       >            LDI                     ;                           ' 16+3  | (38)
1062   05B9                         updateChannelData 0         ; update channel data   ' 153   | 254
1062   05B9 2A 16 01    >            LD      HL, (PCM_ADDR+(ch*8))   ; increment address     ' 16    |
1062   05BC 23          >            INC     HL                      ;                       ' 6     | (38)
1062   05BD 22 16 01    >            LD      (PCM_ADDR+(ch*8)), HL   ;                       ' 16    |
1062   05C0 2A 18 01    >            LD      HL, (PCM_LEN+(ch*8))    ; decrement lenght      ' 16    |
1062   05C3 2B          >            DEC     HL                      ;                       ' 6     | 22 (60)
1062   05C4 7C          >            LD      A, H                    ;                       ' 4     |
1062   05C5 B5          >            OR      L                       ;                       ' 4     | 18 (78)
1062   05C6 CA DA 05    >            JP      Z, .done                ; sample done ?         ' 10    |
1062   05C9 22 18 01    >            LD      (PCM_LEN+(ch*8)), HL    ; set new sample len    ' 16    |
1062   05CC ED 4F       >            LD      R, A
1062   05CE ED 4F       >            LD      R, A
1062   05D0 ED 4F       >            LD      R, A
1062   05D2 ED 4F       >            LD      R, A
1062   05D4 ED 4F       >            LD      R, A
1062   05D6 00          >            NOP
1062   05D7 C3 EA 05    >            JP      .end                    ;                       ' 10    |
1062   05DA 2A 00 1C    >            LD      HL, (ID_TABLE+0)        ; HL = null PCM addr        ' 16    |
1062   05DD 22 16 01    >            LD      (PCM_ADDR+(ch*8)), HL   ; set new PCM addr          ' 16    |
1062   05E0 21 01 00    >            LD      HL, $0001               ; HL = null PCM len         ' 10    | (58)
1062   05E3 22 18 01    >            LD      (PCM_LEN+(ch*8)), HL    ; set new PCM addr          ' 16    |
1062   05E6 AF          >            XOR     A                       ;                           ' 4     |
1062   05E7 32 14 01    >            LD      (PCM_PRIO+(ch*8)), A    ; clear prio                ' 13    | 17 (75)
1063   05EA                         wait17                      ; sync                  ' 17    |
1063   05EA C3 ED 05    >            JP      .go
1063   05ED F6 00       >            OR      $0
1064   05EF             
1065   05EF             
1066   05EF             ;    LD  A, (VCOUNTER)
1067   05EF             ;    LD  (DEBUG_2), A
1068   05EF             
1069   05EF             ; PCM channel 1
1070   05EF             ; -------------
1071   05EF             
1072   05EF             ; $1B+X
1073   05EF                         sampleOutput                ;                       ' 36    |
1073   05EF D9          >            EXX                     ;                           ' 4     | 4
1073   05F0 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
1073   05F1 03          >            INC     BC              ; increment read address    ' 6     |
1073   05F2 CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
1073   05F4 12          >            LD      (DE), A         ; play sample               ' 7     |
1073   05F5 D9          >            EXX                     ;                           ' 4     | (36)
1074   05F6                         prepareChannel 1            ;                       ' 178   | 254
1074   05F6 2A 1E 01    >            LD      HL, (PCM_ADDR+(ch*8))   ; HL = sample addr (HM) ' 16    | (16)
1074   05F9 7D          >            LD      A, L                    ; A = bit 8-15          ' 4     |
1074   05FA 17          >            RLA                             ; C flag = bit 15       ' 4     |
1074   05FB 7C          >            LD      A, H                    ; A = bit 16-23         ' 4     | 16 (32)
1074   05FC 17          >            RLA                             ; A = bit 15-22         ' 4     |
1074   05FD 11 00 60    >            LD  DE, BANKREG         ; DE = BANKREG              ' 10
1074   0600 12          >            LD  (DE), A             ; #1 (bit 15)               ' 7
1074   0601 0F          >            RRCA                     ;                          ' 4
1074   0602 12          >            LD  (DE), A             ; #2 (bit 16)               ' 7
1074   0603 0F          >            RRCA                     ;                          ' 4
1074   0604 12          >            LD  (DE), A             ; #3 (bit 17)               ' 7
1074   0605 0F          >            RRCA                     ;                          ' 4
1074   0606 12          >            LD  (DE), A             ; #4 (bit 18)               ' 7
1074   0607 0F          >            RRCA                     ;                          ' 4
1074   0608 12          >            LD  (DE), A             ; #5 (bit 19)               ' 7
1074   0609 0F          >            RRCA                     ;                          ' 4
1074   060A 12          >            LD  (DE), A             ; #6 (bit 20)               ' 7
1074   060B 0F          >            RRCA                     ;                          ' 4
1074   060C 12          >            LD  (DE), A             ; #7 (bit 21)               ' 7
1074   060D 0F          >            RRCA                     ;                          ' 4
1074   060E 12          >            LD  (DE), A             ; #8 (bit 22)               ' 7
1074   060F AF          >            XOR A                    ;                          ' 4
1074   0610 12          >            LD  (DE), A             ; #9 (bit 23 = 0)           ' 7
1074   0611 65          >            LD      H, L                    ;                       ' 4     |
1074   0612 CB FC       >            SET     7, H                    ; HL |= 0x8000          ' 8     | 25 (162)
1074   0614 2E 00       >            LD      L, 0                    ; HL = sample addr bank ' 7     |
1074   0616 F9          >            LD      SP, HL                  ; SP point on sample    ' 6     |
1074   0617 2A 38 01    >            LD      HL, (WRITEBUF)          ; HL = write buffer     ' 16    | (178)
1075   061A 01 80 10                LD      BC, $1080           ; prepare loop counter  ' 10    |
1076   061D                         wait30                      ; sync                  ' 30    |
1076   061D 18 00       >            JR      .go
1076   061F ED 4F       >            LD      R, A
1076   0621 ED 4F       >            LD      R, A
1077   0623             
1078   0623             ; $1C-4B+X
1079   0623             .loop_ch1
1080   0623                         readAndMix16WhilePlay3      ;                       ' 240   |
1080   0623 D9          >            EXX                     ;                           ' 4     | 4
1080   0624 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
1080   0625 03          >            INC     BC              ; increment read address    ' 6     |
1080   0626 CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
1080   0628 12          >            LD      (DE), A         ; play sample               ' 7     |
1080   0629 D9          >            EXX                     ;                           ' 4     | (36)
1080   062A D1          >            POP     DE              ; read 2 samples from ROM   ' 10+6  | (16)
1080   062B 7B          >            LD      A, E            ; first sample              ' 4     |
1080   062C 86          >            ADD     (HL)            ; mix with write buffer     ' 7     | 21 (37)
1080   062D E2 33 06    >            JP      PO, .ok         ; check overflow            ' 10    |
1080   0630 79          >            LD      A, C            ; fix overflow              ' 4     |
1080   0631 CE FF       >            ADC     $FF             ; A = $7F/$80               ' 7     | +11
1080   0633 77          >            LD      (HL), A         ; store it in write sample  ' 7     |
1080   0634 2C          >            INC     L               ;                           ' 4     | 11 (48)
1080   0635 7A          >            LD      A, D            ; second sample             ' 4     |
1080   0636 86          >            ADD     (HL)            ; mix                       ' 7     | 21 (69)
1080   0637 E2 3D 06    >            JP      PO, .ok2        ; check overflow            ' 10    |
1080   063A 79          >            LD      A, C            ; fix overflow              ' 4     |
1080   063B CE FF       >            ADC     $FF             ; A = $7F/$80               ' 7     | +11
1080   063D 77          >            LD      (HL), A         ; store it in write sample  ' 7     |
1080   063E 2C          >            INC     L               ;                           ' 4     | 11 (80)
1080   063F D1          >            POP     DE              ; read 2 samples from ROM   ' 10+6  | (16)
1080   0640 7B          >            LD      A, E            ; first sample              ' 4     |
1080   0641 86          >            ADD     (HL)            ; mix with write buffer     ' 7     | 21 (37)
1080   0642 E2 48 06    >            JP      PO, .ok         ; check overflow            ' 10    |
1080   0645 79          >            LD      A, C            ; fix overflow              ' 4     |
1080   0646 CE FF       >            ADC     $FF             ; A = $7F/$80               ' 7     | +11
1080   0648 77          >            LD      (HL), A         ; store it in write sample  ' 7     |
1080   0649 2C          >            INC     L               ;                           ' 4     | 11 (48)
1080   064A 7A          >            LD      A, D            ; second sample             ' 4     |
1080   064B 86          >            ADD     (HL)            ; mix                       ' 7     | 21 (69)
1080   064C E2 52 06    >            JP      PO, .ok2        ; check overflow            ' 10    |
1080   064F 79          >            LD      A, C            ; fix overflow              ' 4     |
1080   0650 CE FF       >            ADC     $FF             ; A = $7F/$80               ' 7     | +11
1080   0652 77          >            LD      (HL), A         ; store it in write sample  ' 7     |
1080   0653 2C          >            INC     L               ;                           ' 4     | 11 (80)
1080   0654 D1          >            POP     DE              ; read 2 samples from ROM   ' 10+6  | (212)
1080   0655 7B          >            LD      A, E            ; first sample              ' 4     |
1080   0656 86          >            ADD     (HL)            ; mix with write buffer     ' 7     | 21 (233)
1080   0657 E2 5D 06    >            JP      PO, .ok         ; check overflow            ' 10    |
1080   065A 79          >            LD      A, C            ; fix overflow              ' 4     |
1080   065B CE FF       >            ADC     $FF             ; A = $7F/$80               ' 7     | +11
1080   065D 77          >            LD      (HL), A         ; store it in write sample  ' 7     |
1080   065E 2C          >            INC     L               ;                           ' 4     | 11 (254-10)
1080   065F D9          >            EXX                     ;                           ' 4     | 4
1080   0660 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
1080   0661 03          >            INC     BC              ; increment read address    ' 6     |
1080   0662 CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
1080   0664 12          >            LD      (DE), A         ; play sample               ' 7     |
1080   0665 D9          >            EXX                     ;                           ' 4     | (36)
1080   0666 7A          >            LD      A, D            ; second sample             ' 4     |
1080   0667 86          >            ADD     (HL)            ; mix                       ' 7     | 21 (47)
1080   0668 E2 6E 06    >            JP      PO, .ok2        ; check overflow            ' 10    |
1080   066B 79          >            LD      A, C            ; fix overflow              ' 4     |
1080   066C CE FF       >            ADC     $FF             ; A = $7F/$80               ' 7     | +11
1080   066E 77          >            LD      (HL), A         ; store it in write sample  ' 7     |
1080   066F 2C          >            INC     L               ;                           ' 4     | 11 (58)
1080   0670 D1          >            POP     DE              ; read 2 samples from ROM   ' 10+6  | (16)
1080   0671 7B          >            LD      A, E            ; first sample              ' 4     |
1080   0672 86          >            ADD     (HL)            ; mix with write buffer     ' 7     | 21 (37)
1080   0673 E2 79 06    >            JP      PO, .ok         ; check overflow            ' 10    |
1080   0676 79          >            LD      A, C            ; fix overflow              ' 4     |
1080   0677 CE FF       >            ADC     $FF             ; A = $7F/$80               ' 7     | +11
1080   0679 77          >            LD      (HL), A         ; store it in write sample  ' 7     |
1080   067A 2C          >            INC     L               ;                           ' 4     | 11 (48)
1080   067B 7A          >            LD      A, D            ; second sample             ' 4     |
1080   067C 86          >            ADD     (HL)            ; mix                       ' 7     | 21 (69)
1080   067D E2 83 06    >            JP      PO, .ok2        ; check overflow            ' 10    |
1080   0680 79          >            LD      A, C            ; fix overflow              ' 4     |
1080   0681 CE FF       >            ADC     $FF             ; A = $7F/$80               ' 7     | +11
1080   0683 77          >            LD      (HL), A         ; store it in write sample  ' 7     |
1080   0684 2C          >            INC     L               ;                           ' 4     | 11 (80)
1080   0685 D1          >            POP     DE              ; read 2 samples from ROM   ' 10+6  | (16)
1080   0686 7B          >            LD      A, E            ; first sample              ' 4     |
1080   0687 86          >            ADD     (HL)            ; mix with write buffer     ' 7     | 21 (37)
1080   0688 E2 8E 06    >            JP      PO, .ok         ; check overflow            ' 10    |
1080   068B 79          >            LD      A, C            ; fix overflow              ' 4     |
1080   068C CE FF       >            ADC     $FF             ; A = $7F/$80               ' 7     | +11
1080   068E 77          >            LD      (HL), A         ; store it in write sample  ' 7     |
1080   068F 2C          >            INC     L               ;                           ' 4     | 11 (48)
1080   0690 7A          >            LD      A, D            ; second sample             ' 4     |
1080   0691 86          >            ADD     (HL)            ; mix                       ' 7     | 21 (69)
1080   0692 E2 98 06    >            JP      PO, .ok2        ; check overflow            ' 10    |
1080   0695 79          >            LD      A, C            ; fix overflow              ' 4     |
1080   0696 CE FF       >            ADC     $FF             ; A = $7F/$80               ' 7     | +11
1080   0698 77          >            LD      (HL), A         ; store it in write sample  ' 7     |
1080   0699 2C          >            INC     L               ;                           ' 4     | 11 (80)
1080   069A D1          >            POP     DE              ; read 2 samples from ROM   ' 10+6  | (234)
1080   069B 7B          >            LD      A, E            ; first sample              ' 4     |
1080   069C 86          >            ADD     (HL)            ; mix with write buffer     ' 7     | 21 (254+1)
1080   069D E2 A3 06    >            JP      PO, .ok3        ; check overflow            ' 10    |
1080   06A0 79          >            LD      A, C            ; fix overflow              ' 4     |
1080   06A1 CE FF       >            ADC     $FF             ; A = $7F/$80               ' 7     | +11
1080   06A3 77          >            LD      (HL), A         ; store it in write sample  ' 7     | (254+8)
1080   06A4 D9          >            EXX                     ;                           ' 4     | 4
1080   06A5 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
1080   06A6 03          >            INC     BC              ; increment read address    ' 6     |
1080   06A7 CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
1080   06A9 12          >            LD      (DE), A         ; play sample               ' 7     |
1080   06AA D9          >            EXX                     ;                           ' 4     | (36)
1080   06AB 2C          >            INC     L               ;                           ' 4     | (48)
1080   06AC 7A          >            LD      A, D            ; second sample             ' 4     |
1080   06AD 86          >            ADD     (HL)            ; mix                       ' 7     | 21 (69)
1080   06AE E2 B4 06    >            JP      PO, .ok4        ; check overflow            ' 10    |
1080   06B1 79          >            LD      A, C            ; fix overflow              ' 4     |
1080   06B2 CE FF       >            ADC     $FF             ; A = $7F/$80               ' 7     | +11
1080   06B4 77          >            LD      (HL), A         ; store it in write sample  ' 7     |
1080   06B5 2C          >            INC     L               ;                           ' 4     | 11 (80)
1080   06B6 D1          >            POP     DE              ; read 2 samples from ROM   ' 10+6  | (16)
1080   06B7 7B          >            LD      A, E            ; first sample              ' 4     |
1080   06B8 86          >            ADD     (HL)            ; mix with write buffer     ' 7     | 21 (37)
1080   06B9 E2 BF 06    >            JP      PO, .ok         ; check overflow            ' 10    |
1080   06BC 79          >            LD      A, C            ; fix overflow              ' 4     |
1080   06BD CE FF       >            ADC     $FF             ; A = $7F/$80               ' 7     | +11
1080   06BF 77          >            LD      (HL), A         ; store it in write sample  ' 7     |
1080   06C0 2C          >            INC     L               ;                           ' 4     | 11 (48)
1080   06C1 7A          >            LD      A, D            ; second sample             ' 4     |
1080   06C2 86          >            ADD     (HL)            ; mix                       ' 7     | 21 (69)
1080   06C3 E2 C9 06    >            JP      PO, .ok2        ; check overflow            ' 10    |
1080   06C6 79          >            LD      A, C            ; fix overflow              ' 4     |
1080   06C7 CE FF       >            ADC     $FF             ; A = $7F/$80               ' 7     | +11
1080   06C9 77          >            LD      (HL), A         ; store it in write sample  ' 7     |
1080   06CA 2C          >            INC     L               ;                           ' 4     | 11 (80)
1080   06CB D1          >            POP     DE              ; read 2 samples from ROM   ' 10+6  | (16)
1080   06CC 7B          >            LD      A, E            ; first sample              ' 4     |
1080   06CD 86          >            ADD     (HL)            ; mix with write buffer     ' 7     | 21 (37)
1080   06CE E2 D4 06    >            JP      PO, .ok         ; check overflow            ' 10    |
1080   06D1 79          >            LD      A, C            ; fix overflow              ' 4     |
1080   06D2 CE FF       >            ADC     $FF             ; A = $7F/$80               ' 7     | +11
1080   06D4 77          >            LD      (HL), A         ; store it in write sample  ' 7     |
1080   06D5 2C          >            INC     L               ;                           ' 4     | 11 (48)
1080   06D6 7A          >            LD      A, D            ; second sample             ' 4     |
1080   06D7 86          >            ADD     (HL)            ; mix                       ' 7     | 21 (69)
1080   06D8 E2 DE 06    >            JP      PO, .ok2        ; check overflow            ' 10    |
1080   06DB 79          >            LD      A, C            ; fix overflow              ' 4     |
1080   06DC CE FF       >            ADC     $FF             ; A = $7F/$80               ' 7     | +11
1080   06DE 77          >            LD      (HL), A         ; store it in write sample  ' 7     |
1080   06DF 2C          >            INC     L               ;                           ' 4     | 11 (80)
1081   06E0 05                      DEC     B                   ;                       ' 4     | 254*3
1082   06E1 C2 23 06                JP      NZ, .loop_ch1       ;                       ' 10    |
1083   06E4             
1084   06E4             ; $4C+X
1085   06E4                         sampleOutput                ;                       ' 36    |
1085   06E4 D9          >            EXX                     ;                           ' 4     | 4
1085   06E5 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
1085   06E6 03          >            INC     BC              ; increment read address    ' 6     |
1085   06E7 CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
1085   06E9 12          >            LD      (DE), A         ; play sample               ' 7     |
1085   06EA D9          >            EXX                     ;                           ' 4     | (36)
1086   06EB                         updateChannelData 1         ; update channel data   ' 153   | 254
1086   06EB 2A 1E 01    >            LD      HL, (PCM_ADDR+(ch*8))   ; increment address     ' 16    |
1086   06EE 23          >            INC     HL                      ;                       ' 6     | (38)
1086   06EF 22 1E 01    >            LD      (PCM_ADDR+(ch*8)), HL   ;                       ' 16    |
1086   06F2 2A 20 01    >            LD      HL, (PCM_LEN+(ch*8))    ; decrement lenght      ' 16    |
1086   06F5 2B          >            DEC     HL                      ;                       ' 6     | 22 (60)
1086   06F6 7C          >            LD      A, H                    ;                       ' 4     |
1086   06F7 B5          >            OR      L                       ;                       ' 4     | 18 (78)
1086   06F8 CA 0C 07    >            JP      Z, .done                ; sample done ?         ' 10    |
1086   06FB 22 20 01    >            LD      (PCM_LEN+(ch*8)), HL    ; set new sample len    ' 16    |
1086   06FE ED 4F       >            LD      R, A
1086   0700 ED 4F       >            LD      R, A
1086   0702 ED 4F       >            LD      R, A
1086   0704 ED 4F       >            LD      R, A
1086   0706 ED 4F       >            LD      R, A
1086   0708 00          >            NOP
1086   0709 C3 1C 07    >            JP      .end                    ;                       ' 10    |
1086   070C 2A 00 1C    >            LD      HL, (ID_TABLE+0)        ; HL = null PCM addr        ' 16    |
1086   070F 22 1E 01    >            LD      (PCM_ADDR+(ch*8)), HL   ; set new PCM addr          ' 16    |
1086   0712 21 01 00    >            LD      HL, $0001               ; HL = null PCM len         ' 10    | (58)
1086   0715 22 20 01    >            LD      (PCM_LEN+(ch*8)), HL    ; set new PCM addr          ' 16    |
1086   0718 AF          >            XOR     A                       ;                           ' 4     |
1086   0719 32 1C 01    >            LD      (PCM_PRIO+(ch*8)), A    ; clear prio                ' 13    | 17 (75)
1087   071C                         wait65                      ; sync                  ' 65    |
1087   071C 3E 03       >            LD      A, w            ; 7-2
1087   071E 3D          >            DEC     A               ; 4
1087   071F 20 FD       >            JR      NZ, .loop       ; 12
1087   0721 00          >            NOP
1087   0722 00          >            NOP
1087   0723 F6 00       >            OR      $0
1088   0725             
1089   0725             
1090   0725             ;    LD  A, (VCOUNTER)
1091   0725             ;    LD  (DEBUG_3), A
1092   0725             
1093   0725             ; PCM channel 2
1094   0725             ; -------------
1095   0725             
1096   0725             ; $4D+X
1097   0725                         sampleOutput                ;                       ' 36    |
1097   0725 D9          >            EXX                     ;                           ' 4     | 4
1097   0726 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
1097   0727 03          >            INC     BC              ; increment read address    ' 6     |
1097   0728 CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
1097   072A 12          >            LD      (DE), A         ; play sample               ' 7     |
1097   072B D9          >            EXX                     ;                           ' 4     | (36)
1098   072C                         prepareChannel 2            ;                       ' 178   | 254
1098   072C 2A 26 01    >            LD      HL, (PCM_ADDR+(ch*8))   ; HL = sample addr (HM) ' 16    | (16)
1098   072F 7D          >            LD      A, L                    ; A = bit 8-15          ' 4     |
1098   0730 17          >            RLA                             ; C flag = bit 15       ' 4     |
1098   0731 7C          >            LD      A, H                    ; A = bit 16-23         ' 4     | 16 (32)
1098   0732 17          >            RLA                             ; A = bit 15-22         ' 4     |
1098   0733 11 00 60    >            LD  DE, BANKREG         ; DE = BANKREG              ' 10
1098   0736 12          >            LD  (DE), A             ; #1 (bit 15)               ' 7
1098   0737 0F          >            RRCA                     ;                          ' 4
1098   0738 12          >            LD  (DE), A             ; #2 (bit 16)               ' 7
1098   0739 0F          >            RRCA                     ;                          ' 4
1098   073A 12          >            LD  (DE), A             ; #3 (bit 17)               ' 7
1098   073B 0F          >            RRCA                     ;                          ' 4
1098   073C 12          >            LD  (DE), A             ; #4 (bit 18)               ' 7
1098   073D 0F          >            RRCA                     ;                          ' 4
1098   073E 12          >            LD  (DE), A             ; #5 (bit 19)               ' 7
1098   073F 0F          >            RRCA                     ;                          ' 4
1098   0740 12          >            LD  (DE), A             ; #6 (bit 20)               ' 7
1098   0741 0F          >            RRCA                     ;                          ' 4
1098   0742 12          >            LD  (DE), A             ; #7 (bit 21)               ' 7
1098   0743 0F          >            RRCA                     ;                          ' 4
1098   0744 12          >            LD  (DE), A             ; #8 (bit 22)               ' 7
1098   0745 AF          >            XOR A                    ;                          ' 4
1098   0746 12          >            LD  (DE), A             ; #9 (bit 23 = 0)           ' 7
1098   0747 65          >            LD      H, L                    ;                       ' 4     |
1098   0748 CB FC       >            SET     7, H                    ; HL |= 0x8000          ' 8     | 25 (162)
1098   074A 2E 00       >            LD      L, 0                    ; HL = sample addr bank ' 7     |
1098   074C F9          >            LD      SP, HL                  ; SP point on sample    ' 6     |
1098   074D 2A 38 01    >            LD      HL, (WRITEBUF)          ; HL = write buffer     ' 16    | (178)
1099   0750 01 80 10                LD      BC, $1080           ; prepare loop counter  ' 10    |
1100   0753                         wait30                      ; sync                  ' 30    |
1100   0753 18 00       >            JR      .go
1100   0755 ED 4F       >            LD      R, A
1100   0757 ED 4F       >            LD      R, A
1101   0759             
1102   0759             ; $4E-7D+X
1103   0759             .loop_ch2
1104   0759                         readAndMix16WhilePlay3      ;                       ' 240   |
1104   0759 D9          >            EXX                     ;                           ' 4     | 4
1104   075A 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
1104   075B 03          >            INC     BC              ; increment read address    ' 6     |
1104   075C CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
1104   075E 12          >            LD      (DE), A         ; play sample               ' 7     |
1104   075F D9          >            EXX                     ;                           ' 4     | (36)
1104   0760 D1          >            POP     DE              ; read 2 samples from ROM   ' 10+6  | (16)
1104   0761 7B          >            LD      A, E            ; first sample              ' 4     |
1104   0762 86          >            ADD     (HL)            ; mix with write buffer     ' 7     | 21 (37)
1104   0763 E2 69 07    >            JP      PO, .ok         ; check overflow            ' 10    |
1104   0766 79          >            LD      A, C            ; fix overflow              ' 4     |
1104   0767 CE FF       >            ADC     $FF             ; A = $7F/$80               ' 7     | +11
1104   0769 77          >            LD      (HL), A         ; store it in write sample  ' 7     |
1104   076A 2C          >            INC     L               ;                           ' 4     | 11 (48)
1104   076B 7A          >            LD      A, D            ; second sample             ' 4     |
1104   076C 86          >            ADD     (HL)            ; mix                       ' 7     | 21 (69)
1104   076D E2 73 07    >            JP      PO, .ok2        ; check overflow            ' 10    |
1104   0770 79          >            LD      A, C            ; fix overflow              ' 4     |
1104   0771 CE FF       >            ADC     $FF             ; A = $7F/$80               ' 7     | +11
1104   0773 77          >            LD      (HL), A         ; store it in write sample  ' 7     |
1104   0774 2C          >            INC     L               ;                           ' 4     | 11 (80)
1104   0775 D1          >            POP     DE              ; read 2 samples from ROM   ' 10+6  | (16)
1104   0776 7B          >            LD      A, E            ; first sample              ' 4     |
1104   0777 86          >            ADD     (HL)            ; mix with write buffer     ' 7     | 21 (37)
1104   0778 E2 7E 07    >            JP      PO, .ok         ; check overflow            ' 10    |
1104   077B 79          >            LD      A, C            ; fix overflow              ' 4     |
1104   077C CE FF       >            ADC     $FF             ; A = $7F/$80               ' 7     | +11
1104   077E 77          >            LD      (HL), A         ; store it in write sample  ' 7     |
1104   077F 2C          >            INC     L               ;                           ' 4     | 11 (48)
1104   0780 7A          >            LD      A, D            ; second sample             ' 4     |
1104   0781 86          >            ADD     (HL)            ; mix                       ' 7     | 21 (69)
1104   0782 E2 88 07    >            JP      PO, .ok2        ; check overflow            ' 10    |
1104   0785 79          >            LD      A, C            ; fix overflow              ' 4     |
1104   0786 CE FF       >            ADC     $FF             ; A = $7F/$80               ' 7     | +11
1104   0788 77          >            LD      (HL), A         ; store it in write sample  ' 7     |
1104   0789 2C          >            INC     L               ;                           ' 4     | 11 (80)
1104   078A D1          >            POP     DE              ; read 2 samples from ROM   ' 10+6  | (212)
1104   078B 7B          >            LD      A, E            ; first sample              ' 4     |
1104   078C 86          >            ADD     (HL)            ; mix with write buffer     ' 7     | 21 (233)
1104   078D E2 93 07    >            JP      PO, .ok         ; check overflow            ' 10    |
1104   0790 79          >            LD      A, C            ; fix overflow              ' 4     |
1104   0791 CE FF       >            ADC     $FF             ; A = $7F/$80               ' 7     | +11
1104   0793 77          >            LD      (HL), A         ; store it in write sample  ' 7     |
1104   0794 2C          >            INC     L               ;                           ' 4     | 11 (254-10)
1104   0795 D9          >            EXX                     ;                           ' 4     | 4
1104   0796 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
1104   0797 03          >            INC     BC              ; increment read address    ' 6     |
1104   0798 CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
1104   079A 12          >            LD      (DE), A         ; play sample               ' 7     |
1104   079B D9          >            EXX                     ;                           ' 4     | (36)
1104   079C 7A          >            LD      A, D            ; second sample             ' 4     |
1104   079D 86          >            ADD     (HL)            ; mix                       ' 7     | 21 (47)
1104   079E E2 A4 07    >            JP      PO, .ok2        ; check overflow            ' 10    |
1104   07A1 79          >            LD      A, C            ; fix overflow              ' 4     |
1104   07A2 CE FF       >            ADC     $FF             ; A = $7F/$80               ' 7     | +11
1104   07A4 77          >            LD      (HL), A         ; store it in write sample  ' 7     |
1104   07A5 2C          >            INC     L               ;                           ' 4     | 11 (58)
1104   07A6 D1          >            POP     DE              ; read 2 samples from ROM   ' 10+6  | (16)
1104   07A7 7B          >            LD      A, E            ; first sample              ' 4     |
1104   07A8 86          >            ADD     (HL)            ; mix with write buffer     ' 7     | 21 (37)
1104   07A9 E2 AF 07    >            JP      PO, .ok         ; check overflow            ' 10    |
1104   07AC 79          >            LD      A, C            ; fix overflow              ' 4     |
1104   07AD CE FF       >            ADC     $FF             ; A = $7F/$80               ' 7     | +11
1104   07AF 77          >            LD      (HL), A         ; store it in write sample  ' 7     |
1104   07B0 2C          >            INC     L               ;                           ' 4     | 11 (48)
1104   07B1 7A          >            LD      A, D            ; second sample             ' 4     |
1104   07B2 86          >            ADD     (HL)            ; mix                       ' 7     | 21 (69)
1104   07B3 E2 B9 07    >            JP      PO, .ok2        ; check overflow            ' 10    |
1104   07B6 79          >            LD      A, C            ; fix overflow              ' 4     |
1104   07B7 CE FF       >            ADC     $FF             ; A = $7F/$80               ' 7     | +11
1104   07B9 77          >            LD      (HL), A         ; store it in write sample  ' 7     |
1104   07BA 2C          >            INC     L               ;                           ' 4     | 11 (80)
1104   07BB D1          >            POP     DE              ; read 2 samples from ROM   ' 10+6  | (16)
1104   07BC 7B          >            LD      A, E            ; first sample              ' 4     |
1104   07BD 86          >            ADD     (HL)            ; mix with write buffer     ' 7     | 21 (37)
1104   07BE E2 C4 07    >            JP      PO, .ok         ; check overflow            ' 10    |
1104   07C1 79          >            LD      A, C            ; fix overflow              ' 4     |
1104   07C2 CE FF       >            ADC     $FF             ; A = $7F/$80               ' 7     | +11
1104   07C4 77          >            LD      (HL), A         ; store it in write sample  ' 7     |
1104   07C5 2C          >            INC     L               ;                           ' 4     | 11 (48)
1104   07C6 7A          >            LD      A, D            ; second sample             ' 4     |
1104   07C7 86          >            ADD     (HL)            ; mix                       ' 7     | 21 (69)
1104   07C8 E2 CE 07    >            JP      PO, .ok2        ; check overflow            ' 10    |
1104   07CB 79          >            LD      A, C            ; fix overflow              ' 4     |
1104   07CC CE FF       >            ADC     $FF             ; A = $7F/$80               ' 7     | +11
1104   07CE 77          >            LD      (HL), A         ; store it in write sample  ' 7     |
1104   07CF 2C          >            INC     L               ;                           ' 4     | 11 (80)
1104   07D0 D1          >            POP     DE              ; read 2 samples from ROM   ' 10+6  | (234)
1104   07D1 7B          >            LD      A, E            ; first sample              ' 4     |
1104   07D2 86          >            ADD     (HL)            ; mix with write buffer     ' 7     | 21 (254+1)
1104   07D3 E2 D9 07    >            JP      PO, .ok3        ; check overflow            ' 10    |
1104   07D6 79          >            LD      A, C            ; fix overflow              ' 4     |
1104   07D7 CE FF       >            ADC     $FF             ; A = $7F/$80               ' 7     | +11
1104   07D9 77          >            LD      (HL), A         ; store it in write sample  ' 7     | (254+8)
1104   07DA D9          >            EXX                     ;                           ' 4     | 4
1104   07DB 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
1104   07DC 03          >            INC     BC              ; increment read address    ' 6     |
1104   07DD CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
1104   07DF 12          >            LD      (DE), A         ; play sample               ' 7     |
1104   07E0 D9          >            EXX                     ;                           ' 4     | (36)
1104   07E1 2C          >            INC     L               ;                           ' 4     | (48)
1104   07E2 7A          >            LD      A, D            ; second sample             ' 4     |
1104   07E3 86          >            ADD     (HL)            ; mix                       ' 7     | 21 (69)
1104   07E4 E2 EA 07    >            JP      PO, .ok4        ; check overflow            ' 10    |
1104   07E7 79          >            LD      A, C            ; fix overflow              ' 4     |
1104   07E8 CE FF       >            ADC     $FF             ; A = $7F/$80               ' 7     | +11
1104   07EA 77          >            LD      (HL), A         ; store it in write sample  ' 7     |
1104   07EB 2C          >            INC     L               ;                           ' 4     | 11 (80)
1104   07EC D1          >            POP     DE              ; read 2 samples from ROM   ' 10+6  | (16)
1104   07ED 7B          >            LD      A, E            ; first sample              ' 4     |
1104   07EE 86          >            ADD     (HL)            ; mix with write buffer     ' 7     | 21 (37)
1104   07EF E2 F5 07    >            JP      PO, .ok         ; check overflow            ' 10    |
1104   07F2 79          >            LD      A, C            ; fix overflow              ' 4     |
1104   07F3 CE FF       >            ADC     $FF             ; A = $7F/$80               ' 7     | +11
1104   07F5 77          >            LD      (HL), A         ; store it in write sample  ' 7     |
1104   07F6 2C          >            INC     L               ;                           ' 4     | 11 (48)
1104   07F7 7A          >            LD      A, D            ; second sample             ' 4     |
1104   07F8 86          >            ADD     (HL)            ; mix                       ' 7     | 21 (69)
1104   07F9 E2 FF 07    >            JP      PO, .ok2        ; check overflow            ' 10    |
1104   07FC 79          >            LD      A, C            ; fix overflow              ' 4     |
1104   07FD CE FF       >            ADC     $FF             ; A = $7F/$80               ' 7     | +11
1104   07FF 77          >            LD      (HL), A         ; store it in write sample  ' 7     |
1104   0800 2C          >            INC     L               ;                           ' 4     | 11 (80)
1104   0801 D1          >            POP     DE              ; read 2 samples from ROM   ' 10+6  | (16)
1104   0802 7B          >            LD      A, E            ; first sample              ' 4     |
1104   0803 86          >            ADD     (HL)            ; mix with write buffer     ' 7     | 21 (37)
1104   0804 E2 0A 08    >            JP      PO, .ok         ; check overflow            ' 10    |
1104   0807 79          >            LD      A, C            ; fix overflow              ' 4     |
1104   0808 CE FF       >            ADC     $FF             ; A = $7F/$80               ' 7     | +11
1104   080A 77          >            LD      (HL), A         ; store it in write sample  ' 7     |
1104   080B 2C          >            INC     L               ;                           ' 4     | 11 (48)
1104   080C 7A          >            LD      A, D            ; second sample             ' 4     |
1104   080D 86          >            ADD     (HL)            ; mix                       ' 7     | 21 (69)
1104   080E E2 14 08    >            JP      PO, .ok2        ; check overflow            ' 10    |
1104   0811 79          >            LD      A, C            ; fix overflow              ' 4     |
1104   0812 CE FF       >            ADC     $FF             ; A = $7F/$80               ' 7     | +11
1104   0814 77          >            LD      (HL), A         ; store it in write sample  ' 7     |
1104   0815 2C          >            INC     L               ;                           ' 4     | 11 (80)
1105   0816 05                      DEC     B                   ;                       ' 4     | 254*3
1106   0817 C2 59 07                JP      NZ, .loop_ch2       ;                       ' 10    |
1107   081A             
1108   081A             ; $7E+X
1109   081A                         sampleOutput                ;                       ' 36    |
1109   081A D9          >            EXX                     ;                           ' 4     | 4
1109   081B 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
1109   081C 03          >            INC     BC              ; increment read address    ' 6     |
1109   081D CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
1109   081F 12          >            LD      (DE), A         ; play sample               ' 7     |
1109   0820 D9          >            EXX                     ;                           ' 4     | (36)
1110   0821                         updateChannelData 2         ; update channel data   ' 153   | 254
1110   0821 2A 26 01    >            LD      HL, (PCM_ADDR+(ch*8))   ; increment address     ' 16    |
1110   0824 23          >            INC     HL                      ;                       ' 6     | (38)
1110   0825 22 26 01    >            LD      (PCM_ADDR+(ch*8)), HL   ;                       ' 16    |
1110   0828 2A 28 01    >            LD      HL, (PCM_LEN+(ch*8))    ; decrement lenght      ' 16    |
1110   082B 2B          >            DEC     HL                      ;                       ' 6     | 22 (60)
1110   082C 7C          >            LD      A, H                    ;                       ' 4     |
1110   082D B5          >            OR      L                       ;                       ' 4     | 18 (78)
1110   082E CA 42 08    >            JP      Z, .done                ; sample done ?         ' 10    |
1110   0831 22 28 01    >            LD      (PCM_LEN+(ch*8)), HL    ; set new sample len    ' 16    |
1110   0834 ED 4F       >            LD      R, A
1110   0836 ED 4F       >            LD      R, A
1110   0838 ED 4F       >            LD      R, A
1110   083A ED 4F       >            LD      R, A
1110   083C ED 4F       >            LD      R, A
1110   083E 00          >            NOP
1110   083F C3 52 08    >            JP      .end                    ;                       ' 10    |
1110   0842 2A 00 1C    >            LD      HL, (ID_TABLE+0)        ; HL = null PCM addr        ' 16    |
1110   0845 22 26 01    >            LD      (PCM_ADDR+(ch*8)), HL   ; set new PCM addr          ' 16    |
1110   0848 21 01 00    >            LD      HL, $0001               ; HL = null PCM len         ' 10    | (58)
1110   084B 22 28 01    >            LD      (PCM_LEN+(ch*8)), HL    ; set new PCM addr          ' 16    |
1110   084E AF          >            XOR     A                       ;                           ' 4     |
1110   084F 32 24 01    >            LD      (PCM_PRIO+(ch*8)), A    ; clear prio                ' 13    | 17 (75)
1111   0852                         wait65                      ; sync                  ' 65    |
1111   0852 3E 03       >            LD      A, w            ; 7-2
1111   0854 3D          >            DEC     A               ; 4
1111   0855 20 FD       >            JR      NZ, .loop       ; 12
1111   0857 00          >            NOP
1111   0858 00          >            NOP
1111   0859 F6 00       >            OR      $0
1112   085B             
1113   085B             
1114   085B             ;    LD  A, (VCOUNTER)
1115   085B             ;    LD  (DEBUG_4), A
1116   085B             
1117   085B             ; PCM channel 3
1118   085B             ; -------------
1119   085B             
1120   085B             ; $7F+X
1121   085B                         sampleOutput                ;                       ' 36    |
1121   085B D9          >            EXX                     ;                           ' 4     | 4
1121   085C 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
1121   085D 03          >            INC     BC              ; increment read address    ' 6     |
1121   085E CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
1121   0860 12          >            LD      (DE), A         ; play sample               ' 7     |
1121   0861 D9          >            EXX                     ;                           ' 4     | (36)
1122   0862                         prepareChannelAlt 3         ;                       ' 176   | 254
1122   0862 2A 2E 01    >            LD      HL, (PCM_ADDR+(ch*8))   ; HL = sample addr (HM) ' 16    | (16)
1122   0865 7D          >            LD      A, L                    ; A = bit 8-15          ' 4     |
1122   0866 17          >            RLA                             ; C flag = bit 15       ' 4     |
1122   0867 7C          >            LD      A, H                    ; A = bit 16-23         ' 4     | 16 (32)
1122   0868 17          >            RLA                             ; A = bit 15-22         ' 4     |
1122   0869 11 00 60    >            LD  DE, BANKREG         ; DE = BANKREG              ' 10
1122   086C 12          >            LD  (DE), A             ; #1 (bit 15)               ' 7
1122   086D 0F          >            RRCA                     ;                          ' 4
1122   086E 12          >            LD  (DE), A             ; #2 (bit 16)               ' 7
1122   086F 0F          >            RRCA                     ;                          ' 4
1122   0870 12          >            LD  (DE), A             ; #3 (bit 17)               ' 7
1122   0871 0F          >            RRCA                     ;                          ' 4
1122   0872 12          >            LD  (DE), A             ; #4 (bit 18)               ' 7
1122   0873 0F          >            RRCA                     ;                          ' 4
1122   0874 12          >            LD  (DE), A             ; #5 (bit 19)               ' 7
1122   0875 0F          >            RRCA                     ;                          ' 4
1122   0876 12          >            LD  (DE), A             ; #6 (bit 20)               ' 7
1122   0877 0F          >            RRCA                     ;                          ' 4
1122   0878 12          >            LD  (DE), A             ; #7 (bit 21)               ' 7
1122   0879 0F          >            RRCA                     ;                          ' 4
1122   087A 12          >            LD  (DE), A             ; #8 (bit 22)               ' 7
1122   087B AF          >            XOR A                    ;                          ' 4
1122   087C 12          >            LD  (DE), A             ; #9 (bit 23 = 0)           ' 7
1122   087D 65          >            LD      H, L                    ;                       ' 4     |
1122   087E CB FC       >            SET     7, H                    ; HL |= 0x8000          ' 8     | 19 (156)
1122   0880 2E 00       >            LD      L, 0                    ; HL = sample addr bank ' 7     |
1122   0882 ED 5B 38 01 >            LD      DE, (WRITEBUF)          ; DE = write buffer     ' 20    | (176)
1123   0886 01 80 1C                LD      BC, $1C80           ; prepare loop counter  ' 10    |
1124   0889                         wait32                      ; sync                  ' 32    |
1124   0889 F6 00       >            OR      $0
1124   088B 00          >            NOP
1124   088C ED 4F       >            LD      R, A
1124   088E 18 00       >            JR      .go
1125   0890             
1126   0890             ; $80-$B7+X
1127   0890             .loop_ch3
1128   0890                         sampleOutput                ;                       ' 36    |
1128   0890 D9          >            EXX                     ;                           ' 4     | 4
1128   0891 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
1128   0892 03          >            INC     BC              ; increment read address    ' 6     |
1128   0893 CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
1128   0895 12          >            LD      (DE), A         ; play sample               ' 7     |
1128   0896 D9          >            EXX                     ;                           ' 4     | (36)
1129   0897                         readMixAndUnsign            ; mix/unsign 9 samples  ' 46    |
1129   0897 1A          >            LD      A, (DE)         ; read value in write buf   ' 7     |
1129   0898 86          >            ADD     (HL)            ; mix with source sample    ' 7+3   | (27)
1129   0899 E2 9F 08    >            JP      PO, .ok         ; check overflow            ' 10    |
1129   089C 79          >            LD      A, C            ; fix overflow              ' 4     |
1129   089D CE FF       >            ADC     $FF             ; A = $7F/$80               ' 7     | +11
1129   089F 81          >            ADD     C               ; unsign                    ' 4     |
1129   08A0 12          >            LD      (DE), A         ; write sample in buffer    ' 7     | 19 (46)
1129   08A1 1C          >            INC     E               ;                           ' 4     |
1129   08A2 2C          >            INC     L               ; next                      ' 4     |
1130   08A3                         readMixAndUnsign            ;                       ' 46    |
1130   08A3 1A          >            LD      A, (DE)         ; read value in write buf   ' 7     |
1130   08A4 86          >            ADD     (HL)            ; mix with source sample    ' 7+3   | (27)
1130   08A5 E2 AB 08    >            JP      PO, .ok         ; check overflow            ' 10    |
1130   08A8 79          >            LD      A, C            ; fix overflow              ' 4     |
1130   08A9 CE FF       >            ADC     $FF             ; A = $7F/$80               ' 7     | +11
1130   08AB 81          >            ADD     C               ; unsign                    ' 4     |
1130   08AC 12          >            LD      (DE), A         ; write sample in buffer    ' 7     | 19 (46)
1130   08AD 1C          >            INC     E               ;                           ' 4     |
1130   08AE 2C          >            INC     L               ; next                      ' 4     |
1131   08AF                         readMixAndUnsign            ;                       ' 46    | 254+12
1131   08AF 1A          >            LD      A, (DE)         ; read value in write buf   ' 7     |
1131   08B0 86          >            ADD     (HL)            ; mix with source sample    ' 7+3   | (27)
1131   08B1 E2 B7 08    >            JP      PO, .ok         ; check overflow            ' 10    |
1131   08B4 79          >            LD      A, C            ; fix overflow              ' 4     |
1131   08B5 CE FF       >            ADC     $FF             ; A = $7F/$80               ' 7     | +11
1131   08B7 81          >            ADD     C               ; unsign                    ' 4     |
1131   08B8 12          >            LD      (DE), A         ; write sample in buffer    ' 7     | 19 (46)
1131   08B9 1C          >            INC     E               ;                           ' 4     |
1131   08BA 2C          >            INC     L               ; next                      ' 4     |
1132   08BB                         readMixAndUnsign            ;                       ' 46    |
1132   08BB 1A          >            LD      A, (DE)         ; read value in write buf   ' 7     |
1132   08BC 86          >            ADD     (HL)            ; mix with source sample    ' 7+3   | (27)
1132   08BD E2 C3 08    >            JP      PO, .ok         ; check overflow            ' 10    |
1132   08C0 79          >            LD      A, C            ; fix overflow              ' 4     |
1132   08C1 CE FF       >            ADC     $FF             ; A = $7F/$80               ' 7     | +11
1132   08C3 81          >            ADD     C               ; unsign                    ' 4     |
1132   08C4 12          >            LD      (DE), A         ; write sample in buffer    ' 7     | 19 (46)
1132   08C5 1C          >            INC     E               ;                           ' 4     |
1132   08C6 2C          >            INC     L               ; next                      ' 4     |
1133   08C7                         readMixAndUnsign            ;                       ' 46    |
1133   08C7 1A          >            LD      A, (DE)         ; read value in write buf   ' 7     |
1133   08C8 86          >            ADD     (HL)            ; mix with source sample    ' 7+3   | (27)
1133   08C9 E2 CF 08    >            JP      PO, .ok         ; check overflow            ' 10    |
1133   08CC 79          >            LD      A, C            ; fix overflow              ' 4     |
1133   08CD CE FF       >            ADC     $FF             ; A = $7F/$80               ' 7     | +11
1133   08CF 81          >            ADD     C               ; unsign                    ' 4     |
1133   08D0 12          >            LD      (DE), A         ; write sample in buffer    ' 7     | 19 (46)
1133   08D1 1C          >            INC     E               ;                           ' 4     |
1133   08D2 2C          >            INC     L               ; next                      ' 4     |
1134   08D3             
1135   08D3                         sampleOutput                ; +12 --> late          ' 36    |
1135   08D3 D9          >            EXX                     ;                           ' 4     | 4
1135   08D4 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
1135   08D5 03          >            INC     BC              ; increment read address    ' 6     |
1135   08D6 CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
1135   08D8 12          >            LD      (DE), A         ; play sample               ' 7     |
1135   08D9 D9          >            EXX                     ;                           ' 4     | (36)
1136   08DA                         readMixAndUnsign            ;                       ' 46    |
1136   08DA 1A          >            LD      A, (DE)         ; read value in write buf   ' 7     |
1136   08DB 86          >            ADD     (HL)            ; mix with source sample    ' 7+3   | (27)
1136   08DC E2 E2 08    >            JP      PO, .ok         ; check overflow            ' 10    |
1136   08DF 79          >            LD      A, C            ; fix overflow              ' 4     |
1136   08E0 CE FF       >            ADC     $FF             ; A = $7F/$80               ' 7     | +11
1136   08E2 81          >            ADD     C               ; unsign                    ' 4     |
1136   08E3 12          >            LD      (DE), A         ; write sample in buffer    ' 7     | 19 (46)
1136   08E4 1C          >            INC     E               ;                           ' 4     |
1136   08E5 2C          >            INC     L               ; next                      ' 4     |
1137   08E6                         readMixAndUnsign            ;                       ' 46    |
1137   08E6 1A          >            LD      A, (DE)         ; read value in write buf   ' 7     |
1137   08E7 86          >            ADD     (HL)            ; mix with source sample    ' 7+3   | (27)
1137   08E8 E2 EE 08    >            JP      PO, .ok         ; check overflow            ' 10    |
1137   08EB 79          >            LD      A, C            ; fix overflow              ' 4     |
1137   08EC CE FF       >            ADC     $FF             ; A = $7F/$80               ' 7     | +11
1137   08EE 81          >            ADD     C               ; unsign                    ' 4     |
1137   08EF 12          >            LD      (DE), A         ; write sample in buffer    ' 7     | 19 (46)
1137   08F0 1C          >            INC     E               ;                           ' 4     |
1137   08F1 2C          >            INC     L               ; next                      ' 4     |
1138   08F2                         readMixAndUnsign            ;                       ' 46    | 254
1138   08F2 1A          >            LD      A, (DE)         ; read value in write buf   ' 7     |
1138   08F3 86          >            ADD     (HL)            ; mix with source sample    ' 7+3   | (27)
1138   08F4 E2 FA 08    >            JP      PO, .ok         ; check overflow            ' 10    |
1138   08F7 79          >            LD      A, C            ; fix overflow              ' 4     |
1138   08F8 CE FF       >            ADC     $FF             ; A = $7F/$80               ' 7     | +11
1138   08FA 81          >            ADD     C               ; unsign                    ' 4     |
1138   08FB 12          >            LD      (DE), A         ; write sample in buffer    ' 7     | 19 (46)
1138   08FC 1C          >            INC     E               ;                           ' 4     |
1138   08FD 2C          >            INC     L               ; next                      ' 4     |
1139   08FE                         readMixAndUnsign            ;                       ' 46    |
1139   08FE 1A          >            LD      A, (DE)         ; read value in write buf   ' 7     |
1139   08FF 86          >            ADD     (HL)            ; mix with source sample    ' 7+3   | (27)
1139   0900 E2 06 09    >            JP      PO, .ok         ; check overflow            ' 10    |
1139   0903 79          >            LD      A, C            ; fix overflow              ' 4     |
1139   0904 CE FF       >            ADC     $FF             ; A = $7F/$80               ' 7     | +11
1139   0906 81          >            ADD     C               ; unsign                    ' 4     |
1139   0907 12          >            LD      (DE), A         ; write sample in buffer    ' 7     | 19 (46)
1139   0908 1C          >            INC     E               ;                           ' 4     |
1139   0909 2C          >            INC     L               ; next                      ' 4     |
1140   090A                         wait8                       ; sync                  ' 8     |
1140   090A 00          >            NOP
1140   090B 00          >            NOP
1141   090C 05                      DEC     B                   ;                       ' 4     |
1142   090D C2 90 08                JP      NZ, .loop_ch3       ;                       ' 10    |
1143   0910             
1144   0910             ; $B8+X
1145   0910                         sampleOutput                ;                       ' 36    |
1145   0910 D9          >            EXX                     ;                           ' 4     | 4
1145   0911 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
1145   0912 03          >            INC     BC              ; increment read address    ' 6     |
1145   0913 CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
1145   0915 12          >            LD      (DE), A         ; play sample               ' 7     |
1145   0916 D9          >            EXX                     ;                           ' 4     | (36)
1146   0917                         readMixAndUnsign            ;                       ' 46    |
1146   0917 1A          >            LD      A, (DE)         ; read value in write buf   ' 7     |
1146   0918 86          >            ADD     (HL)            ; mix with source sample    ' 7+3   | (27)
1146   0919 E2 1F 09    >            JP      PO, .ok         ; check overflow            ' 10    |
1146   091C 79          >            LD      A, C            ; fix overflow              ' 4     |
1146   091D CE FF       >            ADC     $FF             ; A = $7F/$80               ' 7     | +11
1146   091F 81          >            ADD     C               ; unsign                    ' 4     |
1146   0920 12          >            LD      (DE), A         ; write sample in buffer    ' 7     | 19 (46)
1146   0921 1C          >            INC     E               ;                           ' 4     |
1146   0922 2C          >            INC     L               ; next                      ' 4     |
1147   0923                         readMixAndUnsign            ;                       ' 46    | 254
1147   0923 1A          >            LD      A, (DE)         ; read value in write buf   ' 7     |
1147   0924 86          >            ADD     (HL)            ; mix with source sample    ' 7+3   | (27)
1147   0925 E2 2B 09    >            JP      PO, .ok         ; check overflow            ' 10    |
1147   0928 79          >            LD      A, C            ; fix overflow              ' 4     |
1147   0929 CE FF       >            ADC     $FF             ; A = $7F/$80               ' 7     | +11
1147   092B 81          >            ADD     C               ; unsign                    ' 4     |
1147   092C 12          >            LD      (DE), A         ; write sample in buffer    ' 7     | 19 (46)
1147   092D 1C          >            INC     E               ;                           ' 4     |
1147   092E 2C          >            INC     L               ; next                      ' 4     |
1148   092F                         readMixAndUnsign            ;                       ' 46    |
1148   092F 1A          >            LD      A, (DE)         ; read value in write buf   ' 7     |
1148   0930 86          >            ADD     (HL)            ; mix with source sample    ' 7+3   | (27)
1148   0931 E2 37 09    >            JP      PO, .ok         ; check overflow            ' 10    |
1148   0934 79          >            LD      A, C            ; fix overflow              ' 4     |
1148   0935 CE FF       >            ADC     $FF             ; A = $7F/$80               ' 7     | +11
1148   0937 81          >            ADD     C               ; unsign                    ' 4     |
1148   0938 12          >            LD      (DE), A         ; write sample in buffer    ' 7     | 19 (46)
1148   0939 1C          >            INC     E               ;                           ' 4     |
1148   093A 2C          >            INC     L               ; next                      ' 4     |
1149   093B                         readMixAndUnsign            ;                       ' 46    |
1149   093B 1A          >            LD      A, (DE)         ; read value in write buf   ' 7     |
1149   093C 86          >            ADD     (HL)            ; mix with source sample    ' 7+3   | (27)
1149   093D E2 43 09    >            JP      PO, .ok         ; check overflow            ' 10    |
1149   0940 79          >            LD      A, C            ; fix overflow              ' 4     |
1149   0941 CE FF       >            ADC     $FF             ; A = $7F/$80               ' 7     | +11
1149   0943 81          >            ADD     C               ; unsign                    ' 4     |
1149   0944 12          >            LD      (DE), A         ; write sample in buffer    ' 7     | 19 (46)
1149   0945 1C          >            INC     E               ;                           ' 4     |
1149   0946 2C          >            INC     L               ; next                      ' 4     |
1150   0947                         wait34                      ;                       ' 34    |
1150   0947 3E 02       >            LD      A, w            ; 7-2
1150   0949 3D          >            DEC     A               ; 4
1150   094A 20 FD       >            JR      NZ, .loop       ; 12
1151   094C             
1152   094C             ; $B9+X
1153   094C                         sampleOutput                ;                       ' 36    |
1153   094C D9          >            EXX                     ;                           ' 4     | 4
1153   094D 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
1153   094E 03          >            INC     BC              ; increment read address    ' 6     |
1153   094F CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
1153   0951 12          >            LD      (DE), A         ; play sample               ' 7     |
1153   0952 D9          >            EXX                     ;                           ' 4     | (36)
1154   0953                         updateChannelData 3         ; update channel data   ' 153   | 254
1154   0953 2A 2E 01    >            LD      HL, (PCM_ADDR+(ch*8))   ; increment address     ' 16    |
1154   0956 23          >            INC     HL                      ;                       ' 6     | (38)
1154   0957 22 2E 01    >            LD      (PCM_ADDR+(ch*8)), HL   ;                       ' 16    |
1154   095A 2A 30 01    >            LD      HL, (PCM_LEN+(ch*8))    ; decrement lenght      ' 16    |
1154   095D 2B          >            DEC     HL                      ;                       ' 6     | 22 (60)
1154   095E 7C          >            LD      A, H                    ;                       ' 4     |
1154   095F B5          >            OR      L                       ;                       ' 4     | 18 (78)
1154   0960 CA 74 09    >            JP      Z, .done                ; sample done ?         ' 10    |
1154   0963 22 30 01    >            LD      (PCM_LEN+(ch*8)), HL    ; set new sample len    ' 16    |
1154   0966 ED 4F       >            LD      R, A
1154   0968 ED 4F       >            LD      R, A
1154   096A ED 4F       >            LD      R, A
1154   096C ED 4F       >            LD      R, A
1154   096E ED 4F       >            LD      R, A
1154   0970 00          >            NOP
1154   0971 C3 84 09    >            JP      .end                    ;                       ' 10    |
1154   0974 2A 00 1C    >            LD      HL, (ID_TABLE+0)        ; HL = null PCM addr        ' 16    |
1154   0977 22 2E 01    >            LD      (PCM_ADDR+(ch*8)), HL   ; set new PCM addr          ' 16    |
1154   097A 21 01 00    >            LD      HL, $0001               ; HL = null PCM len         ' 10    | (58)
1154   097D 22 30 01    >            LD      (PCM_LEN+(ch*8)), HL    ; set new PCM addr          ' 16    |
1154   0980 AF          >            XOR     A                       ;                           ' 4     |
1154   0981 32 2C 01    >            LD      (PCM_PRIO+(ch*8)), A    ; clear prio                ' 13    | 17 (75)
1155   0984                         wait65                      ; sync                  ' 65    |
1155   0984 3E 03       >            LD      A, w            ; 7-2
1155   0986 3D          >            DEC     A               ; 4
1155   0987 20 FD       >            JR      NZ, .loop       ; 12
1155   0989 00          >            NOP
1155   098A 00          >            NOP
1155   098B F6 00       >            OR      $0
1156   098D             
1157   098D             
1158   098D             ;    LD  A, (VCOUNTER)
1159   098D             ;    LD  (DEBUG_5), A
1160   098D             
1161   098D             ; next write buffer
1162   098D             ; -----------------
1163   098D             
1164   098D             ; $BA+X
1165   098D             next_write_buf
1166   098D                         sampleOutput                ;                       ' 36    | 36
1166   098D D9          >            EXX                     ;                           ' 4     | 4
1166   098E 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
1166   098F 03          >            INC     BC              ; increment read address    ' 6     |
1166   0990 CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
1166   0992 12          >            LD      (DE), A         ; play sample               ' 7     |
1166   0993 D9          >            EXX                     ;                           ' 4     | (36)
1167   0994             
1168   0994 3A 02 01                LD      A, (STATUS)         ; A = (STATUS)          ' 13    |
1169   0997 21 00 40                LD      HL, YMPORT0         ; HL point on YM port0  ' 10    |
1170   099A 36 2B                   LD      (HL), $2B           ; register = DAC enable ' 10    | 54 (90)
1171   099C 2C                      INC     L                   ; HL point on YM port1  ' 4     |
1172   099D E6 0F                   AND     $0F                 ; PCM is playing ?      ' 7     |
1173   099F C2 B2 09                JP      NZ, .still_pcm      ;                       ' 10    |
1174   09A2             
1175   09A2 3A 61 01                LD      A, (YM_2B_CNT)      ;                       ' 13    |
1176   09A5 B7                      OR      A                   ;                       ' 4     | 27 (117)
1177   09A6 CA C3 09                JP      Z, .no_pcm          ; DAC enabled expired ? ' 10    |
1178   09A9             
1179   09A9 3D                      DEC     A                   ; decrement expiration  ' 4     |
1180   09AA 32 61 01                LD      (YM_2B_CNT), A      ;                       ' 13    |
1181   09AD 3E 80                   LD      A, $80              ; DAC enabled           ' 7     | 34 (151)
1182   09AF C3 CA 09                JP      .set_dac            ; assume still PCM      ' 10    |
1183   09B2             
1184   09B2             .still_pcm                              ;                       ' 90
1185   09B2                         wait7                       ; sync                  ' 7     |
1185   09B2 F6 00       >            OR      $0
1186   09B4 3E 03                   LD      A, 3                ; set DAC ON expiration ' 7     | 27 (117)
1187   09B6 32 61 01                LD      (YM_2B_CNT), A      ; 4 frames to expire    ' 13    |
1188   09B9             
1189   09B9                         wait17                      ; sync                  ' 17    |
1189   09B9 C3 BC 09    >            JP      .go
1189   09BC F6 00       >            OR      $0
1190   09BE 3E 80                   LD      A, $80              ; DAC enabled           ' 7     | 34 (151)
1191   09C0 C3 CA 09                JP      .set_dac            ; assume still PCM      ' 10    |
1192   09C3             
1193   09C3             .no_pcm                                 ;                       ' 117
1194   09C3                         wait21                      ; sync                  ' 21    |
1194   09C3 18 00       >            JR      .go
1194   09C5 ED 4F       >            LD      R, A
1195   09C7 3A 60 01                LD      A, (YM_2B_SAV)      ; use current DAC on    ' 13    | 34 (151)
1196   09CA             
1197   09CA             .set_dac                                ;                       ' 151
1198   09CA 77                      LD      (HL), A             ; set DAC enabled       ' 7     |
1199   09CB 2D                      DEC     L                   ; HL point on YM port0  ' 4     | 11 (162)
1200   09CC             
1201   09CC D9                      EXX                         ;                       ' 4     |
1202   09CD 78                      LD      A, B                ; A = read buffer high  ' 4     |
1203   09CE 32 3B 01                LD      (READBUF+1), A      ; save current read buf ' 13    | 25 (187)
1204   09D1 D9                      EXX                         ;                       ' 4     |
1205   09D2             
1206   09D2 BA                      CP      D                   ; prepare DAC write     ' 4     |
1207   09D3 36 2A                   LD      (HL), 0x2A          ; write buf == read buf ' 10    | 24 (211)
1208   09D5 CA E2 09                JP      Z, .continu_pcm     ; continu to fill pcm   ' 10    |
1209   09D8             
1210   09D8 14                      INC     D                   ; inc write addr        ' 4     |
1211   09D9 CB 92                   RES     2, D                ; write addr &= 0x03FF  ' 8     | 42 (254-1)
1212   09DB ED 53 38 01             LD      (WRITEBUF), DE      ; save new write addr   ' 20    |
1213   09DF C3 EC 09                JP      sync_frame          ;                       ' 10    |
1214   09E2             
1215   09E2             .continu_pcm
1216   09E2 14                      INC     D                   ; inc write addr        ' 4     |
1217   09E3 CB 92                   RES     2, D                ; write addr &= 0x03FF  ' 8     | 42 (254-1)
1218   09E5 ED 53 38 01             LD      (WRITEBUF), DE      ; save new write addr   ' 20    |
1219   09E9 C3 1B 05                JP      pcm_mix             ; do pcm mix again      ' 10    |
1220   09EC             
1221   09EC             ; sync
1222   09EC             ; ----
1223   09EC             
1224   09EC             ; $BB+X
1225   09EC             sync_frame                              ; DE point on write buf
1226   09EC             
1227   09EC             ;    LD  A, (VCOUNTER)
1228   09EC             ;    LD  (DEBUG_6), A
1229   09EC             
1230   09EC             sync_frame_loop
1231   09EC                         sampleOutput                ;                       ' 36    | (36)
1231   09EC D9          >            EXX                     ;                           ' 4     | 4
1231   09ED 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
1231   09EE 03          >            INC     BC              ; increment read address    ' 6     |
1231   09EF CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
1231   09F1 12          >            LD      (DE), A         ; play sample               ' 7     |
1231   09F2 D9          >            EXX                     ;                           ' 4     | (36)
1232   09F3             
1233   09F3                         wait62                      ; sync                  ' 62    | (98)
1233   09F3 3E 03       >            LD      A, w            ; 7-2
1233   09F5 3D          >            DEC     A               ; 4
1233   09F6 20 FD       >            JR      NZ, .loop       ; 12
1233   09F8 18 00       >            JR      .go
1234   09FA             
1235   09FA 2A 80 01                LD      HL, (IDLE_LOOP)     ;                       ' 16    |
1236   09FD 23                      INC     HL                  ; increment idle loop   ' 6     | 38 (136)
1237   09FE 22 80 01                LD      (IDLE_LOOP), HL     ;                       ' 16    |
1238   0A01             
1239   0A01 3A 13 01                LD      A, (PENDING_FRM)    ; A = frame to process  ' 13    |
1240   0A04 B7                      OR      A                   ; something to do ?     ' 4     | 27 (163)
1241   0A05 C2 30 0A                JP      NZ, .do_xgm         ; do the XGM frame      ' 10    |
1242   0A08             
1243   0A08 3A 11 01                LD      A, (PROTECT_ARG)    ; get BUS protect state ' 13    |
1244   0A0B B7                      OR      A                   ; protecting ?          ' 4     | 27 (190)
1245   0A0C C2 20 0A                JP      NZ, .wait_dma       ; wait for it           ' 10    |
1246   0A0F             
1247   0A0F D9                      EXX                         ;                       ' 4     |
1248   0A10 78                      LD      A, B                ; A = read buffer high  ' 4     |
1249   0A11 32 3B 01                LD      (READBUF+1), A      ; save current read buf ' 13    | 25 (215)
1250   0A14 D9                      EXX                         ;                       ' 4     |
1251   0A15             
1252   0A15 C6 01                   ADD     $1                  ;                       ' 7     |
1253   0A17 CB 97                   RES     2, A                ; read pos &= 0x03FF    ' 8     |
1254   0A19 BA                      CP      D                   ; pcm buffer empty ?    ' 4     | 29 (244)
1255   0A1A CA 2D 0A                JP      Z, .do_pcm          ; fill pcm              ' 10    |
1256   0A1D             
1257   0A1D C3 EC 09                JP      sync_frame_loop     ; wait for a frame      ' 10    | (254)
1258   0A20             
1259   0A20             .wait_dma                               ;                       ' 190
1260   0A20 2A 82 01                LD      HL, (WAIT_LOOP)     ;                       ' 16    |
1261   0A23 23                      INC     HL                  ; increment wait loop   ' 6     | 38 (228)
1262   0A24 22 82 01                LD      (WAIT_LOOP), HL     ;                       ' 16    |
1263   0A27             
1264   0A27                         wait16                      ; sync                  ' 16    |
1264   0A27 18 00       >            JR      .go
1264   0A29 00          >            NOP
1265   0A2A C3 EC 09                JP      sync_frame          ; wait for a frame      ' 10    | 26 (254)
1266   0A2D             
1267   0A2D             .do_pcm                                 ;                       ' 244
1268   0A2D C3 1B 05                JP      pcm_mix             ; do pcm mix again      ' 10    | (254)
1269   0A30             
1270   0A30             .do_xgm                                 ;                       ' 163
1271   0A30                         wait81                      ; sync                  ' 81    |
1271   0A30 3E 04       >            LD      A, w            ; 7-2
1271   0A32 3D          >            DEC     A               ; 4
1271   0A33 20 FD       >            JR      NZ, .loop       ; 12
1271   0A35 00          >            NOP
1271   0A36 00          >            NOP
1271   0A37 F6 00       >            OR      $0
1272   0A39 11 00 17                LD      DE, XGM_BUFFER      ; DE point to XGM buf   ' 10    | 91 (254)
1273   0A3C             
1274   0A3C             
1275   0A3C             ;    LD  A, (VCOUNTER)
1276   0A3C             ;    LD  (DEBUG_7), A
1277   0A3C             
1278   0A3C             ; execute XGM command
1279   0A3C             ; -------------------
1280   0A3C             
1281   0A3C             ; $BC+X+Y
1282   0A3C             execute_xgm
1283   0A3C                         sampleOutput                ;                       ' 36    | (36)
1283   0A3C D9          >            EXX                     ;                           ' 4     | 4
1283   0A3D 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
1283   0A3E 03          >            INC     BC              ; increment read address    ' 6     |
1283   0A3F CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
1283   0A41 12          >            LD      (DE), A         ; play sample               ' 7     |
1283   0A42 D9          >            EXX                     ;                           ' 4     | (36)
1284   0A43             
1285   0A43 1A                      LD      A, (DE)             ; A = command           ' 7     |
1286   0A44 32 49 0A                LD      (.ld_hl_xx + 1), A  ; set jump address      ' 13    |
1287   0A47 1C                      INC     E                   ; next command          ' 4     | 44 (80)
1288   0A48             .ld_hl_xx                               ;                       '       |
1289   0A48 2A 00 16                LD      HL, (JUMP_TABLE)    ; LD HL, (jt)           ' 16    |
1290   0A4B E9                      JP      (HL)                ;                       ' 4     |
1291   0A4C             
1292   0A4C             
1293   0A4C             ; next frame command
1294   0A4C             ; ------------------
1295   0A4C             
1296   0A4C             com_next_frame                          ; 00                    ' 80
1297   0A4C C3 4D 12                JP      xgm_done            ; XGM frame done        ' 10    | (90)
1298   0A4F             
1299   0A4F             
1300   0A4F             ; PSG command
1301   0A4F             ; -----------
1302   0A4F             
1303   0A4F             com_psg_tone_w0                         ; 10                    ' 80
1304   0A4F                         wait126                     ; sync                  ' 126   |
1304   0A4F 3E 07       >            LD      A, w            ; 7-2
1304   0A51 3D          >            DEC     A               ; 4
1304   0A52 20 FD       >            JR      NZ, .loop       ; 12
1304   0A54 18 00       >            JR      .go
1305   0A56 21 11 7F                LD      HL, PSGPORT         ; HL point on PSG port  ' 10    | 146 (226)
1306   0A59 C3 C6 0A                JP      psg_tone_write0     ;                       ' 10    |
1307   0A5C             
1308   0A5C             com_psg_tone_w1                         ; 11                    ' 80
1309   0A5C                         wait108                     ; sync                  ' 108   |
1309   0A5C 3E 06       >            LD      A, w            ; 7-2
1309   0A5E 3D          >            DEC     A               ; 4
1309   0A5F 20 FD       >            JR      NZ, .loop       ; 12
1309   0A61 C3 64 0A    >            JP      .go
1310   0A64 21 11 7F                LD      HL, PSGPORT         ; HL point on PSG port  ' 10    | 128 (208)
1311   0A67 C3 C3 0A                JP      psg_tone_write1     ;                       ' 10    |
1312   0A6A             
1313   0A6A             com_psg_tone_w2                         ; 12                    ' 80
1314   0A6A                         wait90                      ; sync                  ' 90    |
1314   0A6A 3E 05       >            LD      A, w            ; 7-2
1314   0A6C 3D          >            DEC     A               ; 4
1314   0A6D 20 FD       >            JR      NZ, .loop       ; 12
1314   0A6F 00          >            NOP
1314   0A70 00          >            NOP
1315   0A71 21 11 7F                LD      HL, PSGPORT         ; HL point on PSG port  ' 10    | 110 (190)
1316   0A74 C3 C0 0A                JP      psg_tone_write2     ;                       ' 10    |
1317   0A77             
1318   0A77             com_psg_tone_w3                         ; 13                    ' 80
1319   0A77                         wait72                      ; sync                  ' 72    |
1319   0A77 3E 03       >            LD      A, w            ; 7-2
1319   0A79 3D          >            DEC     A               ; 4
1319   0A7A 20 FD       >            JR      NZ, .loop       ; 12
1319   0A7C ED 4F       >            LD      R, A
1319   0A7E ED 4F       >            LD      R, A
1319   0A80 00          >            NOP
1320   0A81 21 11 7F                LD      HL, PSGPORT         ; HL point on PSG port  ' 10    | 92 (172)
1321   0A84 C3 BD 0A                JP      psg_tone_write3     ;                       ' 10    |
1322   0A87             
1323   0A87             com_psg_tone_w4                         ; 14                    ' 80
1324   0A87                         wait54                      ; sync                  ' 54    |
1324   0A87 3E 03       >            LD      A, w            ; 7-2
1324   0A89 3D          >            DEC     A               ; 4
1324   0A8A 20 FD       >            JR      NZ, .loop       ; 12
1324   0A8C 00          >            NOP
1325   0A8D 21 11 7F                LD      HL, PSGPORT         ; HL point on PSG port  ' 10    | 74 (154)
1326   0A90 C3 BA 0A                JP      psg_tone_write4     ;                       ' 10    |
1327   0A93             
1328   0A93             com_psg_tone_w5                         ; 15                    ' 80
1329   0A93                         wait36                      ; sync                  ' 36    |
1329   0A93 ED 4F       >            LD      R, A
1329   0A95 ED 4F       >            LD      R, A
1329   0A97 ED 4F       >            LD      R, A
1329   0A99 ED 4F       >            LD      R, A
1330   0A9B 21 11 7F                LD      HL, PSGPORT         ; HL point on PSG port  ' 10    | 56 (136)
1331   0A9E C3 B7 0A                JP      psg_tone_write5     ;                       ' 10    |
1332   0AA1             
1333   0AA1             com_psg_tone_w6                         ; 16                    ' 80
1334   0AA1                         wait18                      ; sync                  ' 18    |
1334   0AA1 ED 4F       >            LD      R, A
1334   0AA3 ED 4F       >            LD      R, A
1335   0AA5 21 11 7F                LD      HL, PSGPORT         ; HL point on PSG port  ' 10    | 38 (118)
1336   0AA8 C3 B4 0A                JP      psg_tone_write6     ;                       ' 10    |
1337   0AAB             
1338   0AAB             com_psg_tone_w7                         ; 17                    ' 80
1339   0AAB 21 11 7F                LD      HL, PSGPORT         ; HL point on PSG port  ' 10    | 20 (100)
1340   0AAE C3 B1 0A                JP      psg_tone_write7     ;                       ' 10    |
1341   0AB1             
1342   0AB1             
1343   0AB1             psg_tone_write7                         ;                       ' 100
1344   0AB1 1A                      LD      A, (DE)             ; A = PSG data          ' 7     |
1345   0AB2 1C                      INC     E                   ; next data             ' 4     | 18 (118)
1346   0AB3 77                      LD      (HL), A             ; write to PSG          ' 7     |
1347   0AB4             
1348   0AB4             psg_tone_write6
1349   0AB4 1A                      LD      A, (DE)             ; A = PSG data          ' 7     |
1350   0AB5 1C                      INC     E                   ; next data             ' 4     | 18 (136)
1351   0AB6 77                      LD      (HL), A             ; write to PSG          ' 7     |
1352   0AB7             
1353   0AB7             psg_tone_write5
1354   0AB7 1A                      LD      A, (DE)             ; A = PSG data          ' 7     |
1355   0AB8 1C                      INC     E                   ; next data             ' 4     | 18 (154)
1356   0AB9 77                      LD      (HL), A             ; write to PSG          ' 7     |
1357   0ABA             
1358   0ABA             psg_tone_write4
1359   0ABA 1A                      LD      A, (DE)             ; A = PSG data          ' 7     |
1360   0ABB 1C                      INC     E                   ; next data             ' 4     | 18 (172)
1361   0ABC 77                      LD      (HL), A             ; write to PSG          ' 7     |
1362   0ABD             
1363   0ABD             psg_tone_write3
1364   0ABD 1A                      LD      A, (DE)             ; A = PSG data          ' 7     |
1365   0ABE 1C                      INC     E                   ; next data             ' 4     | 18 (190)
1366   0ABF 77                      LD      (HL), A             ; write to PSG          ' 7     |
1367   0AC0             
1368   0AC0             psg_tone_write2
1369   0AC0 1A                      LD      A, (DE)             ; A = PSG data          ' 7     |
1370   0AC1 1C                      INC     E                   ; next data             ' 4     | 18 (208)
1371   0AC2 77                      LD      (HL), A             ; write to PSG          ' 7     |
1372   0AC3             
1373   0AC3             psg_tone_write1
1374   0AC3 1A                      LD      A, (DE)             ; A = PSG data          ' 7     |
1375   0AC4 1C                      INC     E                   ; next data             ' 4     | 18 (226)
1376   0AC5 77                      LD      (HL), A             ; write to PSG          ' 7     |
1377   0AC6             
1378   0AC6             psg_tone_write0
1379   0AC6 1A                      LD      A, (DE)             ; A = PSG data          ' 7     |
1380   0AC7 1C                      INC     E                   ; next data             ' 4     | 18 (244)
1381   0AC8 77                      LD      (HL), A             ; write to PSG          ' 7     |
1382   0AC9             
1383   0AC9 C3 3C 0A                JP      execute_xgm         ;                       ' 10    | (254)
1384   0ACC             
1385   0ACC             
1386   0ACC             com_psg_env_w0                          ; 18                    ' 80
1387   0ACC                         wait72                      ; sync                  ' 72    |
1387   0ACC 3E 03       >            LD      A, w            ; 7-2
1387   0ACE 3D          >            DEC     A               ; 4
1387   0ACF 20 FD       >            JR      NZ, .loop       ; 12
1387   0AD1 ED 4F       >            LD      R, A
1387   0AD3 ED 4F       >            LD      R, A
1387   0AD5 00          >            NOP
1388   0AD6 21 11 7F                LD      HL, PSGPORT         ; HL point on PSG port  ' 10    | 102 (182)
1389   0AD9 01 5C 01                LD      BC, PSG_ENV_SAV     ; BC point on PSG save  ' 10    |
1390   0ADC C3 40 0B                JP      psg_env_write0      ;                       ' 10    |
1391   0ADF             
1392   0ADF             com_psg_env_w1                          ; 18                    ' 80
1393   0ADF                         wait10                      ; sync                  ' 10    |
1393   0ADF C3 E2 0A    >            JP      .go
1394   0AE2 21 11 7F                LD      HL, PSGPORT         ; HL point on PSG port  ' 10    | 40 (120)
1395   0AE5 01 5C 01                LD      BC, PSG_ENV_SAV     ; BC point on PSG save  ' 10    |
1396   0AE8 C3 33 0B                JP      psg_env_write1      ;                       ' 10    |
1397   0AEB             
1398   0AEB             com_psg_env_w2                          ; 18                    ' 80
1399   0AEB                         wait154                     ; sync                  ' 154   |
1399   0AEB 3E 09       >            LD      A, w            ; 7-2
1399   0AED 3D          >            DEC     A               ; 4
1399   0AEE 20 FD       >            JR      NZ, .loop       ; 12
1399   0AF0 00          >            NOP
1399   0AF1 00          >            NOP
1400   0AF2 21 11 7F                LD      HL, PSGPORT         ; HL point on PSG port  ' 10    | 174 (254)
1401   0AF5 01 5C 01                LD      BC, PSG_ENV_SAV     ; BC point on PSG save  ' 10    |
1402   0AF8             
1403   0AF8                         sampleOutput                ;                       ' 36    | (36)
1403   0AF8 D9          >            EXX                     ;                           ' 4     | 4
1403   0AF9 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
1403   0AFA 03          >            INC     BC              ; increment read address    ' 6     |
1403   0AFB CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
1403   0AFD 12          >            LD      (DE), A         ; play sample               ' 7     |
1403   0AFE D9          >            EXX                     ;                           ' 4     | (36)
1404   0AFF             
1405   0AFF                         wait12                      ; sync                  ' 12    |
1405   0AFF 18 00       >            JR      .go
1406   0B01 C3 26 0B                JP      psg_env_write2      ;                       ' 10    | 22 (58)
1407   0B04             
1408   0B04             com_psg_env_w3                          ; 18                    ' 80
1409   0B04                         wait110                     ; sync                  ' 110   |
1409   0B04 3E 06       >            LD      A, w            ; 7-2
1409   0B06 3D          >            DEC     A               ; 4
1409   0B07 20 FD       >            JR      NZ, .loop       ; 12
1409   0B09 18 00       >            JR      .go
1410   0B0B 21 11 7F                LD      HL, PSGPORT         ; HL point on PSG port  ' 10    | 130 (210)
1411   0B0E 01 5C 01                LD      BC, PSG_ENV_SAV     ; BC point on PSG save  ' 10    |
1412   0B11             
1413   0B11             psg_env_write3
1414   0B11 1A                      LD      A, (DE)             ; A = PSG data          ' 7     |
1415   0B12 07                      RLCA                        ;                       ' 4     |
1416   0B13 07                      RLCA                        ;                       ' 4     |
1417   0B14 07                      RLCA                        ;                       ' 4     |
1418   0B15 E6 03                   AND     $3                  ; A = channel number    ' 7     | 41 (254-3)
1419   0B17 C6 5C                   ADD    (PSG_ENV_SAV & $FF)  ; add offset            ' 7     |
1420   0B19 4F                      LD      C, A                ; BC point on save      ' 4     |
1421   0B1A                         wait4                       ; sync                  ' 4     |
1421   0B1A 00          >            NOP
1422   0B1B             
1423   0B1B                         sampleOutput                ;                       ' 36    | (36-3)
1423   0B1B D9          >            EXX                     ;                           ' 4     | 4
1423   0B1C 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
1423   0B1D 03          >            INC     BC              ; increment read address    ' 6     |
1423   0B1E CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
1423   0B20 12          >            LD      (DE), A         ; play sample               ' 7     |
1423   0B21 D9          >            EXX                     ;                           ' 4     | (36)
1424   0B22             
1425   0B22 1A                      LD      A, (DE)             ; A = PSG data          ' 7     |
1426   0B23 1C                      INC     E                   ; next data             ' 4     | 25 (58)
1427   0B24 77                      LD      (HL), A             ; write to PSG          ' 7     |
1428   0B25 02                      LD      (BC), A             ; write to save         ' 7     |
1429   0B26             
1430   0B26             psg_env_write2                          ;                       ' 58
1431   0B26 1A                      LD      A, (DE)             ; A = PSG data          ' 7     |
1432   0B27 07                      RLCA                        ;                       ' 4     |
1433   0B28 07                      RLCA                        ;                       ' 4     |
1434   0B29 07                      RLCA                        ;                       ' 4     |
1435   0B2A E6 03                   AND     $3                  ; A = channel number    ' 7     |
1436   0B2C C6 5C                   ADD    (PSG_ENV_SAV & $FF)  ; add offset            ' 7     | 62 (120)
1437   0B2E 4F                      LD      C, A                ; BC point on save      ' 4     |
1438   0B2F 1A                      LD      A, (DE)             ; A = PSG data          ' 7     |
1439   0B30 1C                      INC     E                   ; next data             ' 4     |
1440   0B31 77                      LD      (HL), A             ; write to PSG          ' 7     |
1441   0B32 02                      LD      (BC), A             ; write to save         ' 7     |
1442   0B33             
1443   0B33             psg_env_write1
1444   0B33 1A                      LD      A, (DE)             ; A = PSG data          ' 7     |
1445   0B34 07                      RLCA                        ;                       ' 4     |
1446   0B35 07                      RLCA                        ;                       ' 4     |
1447   0B36 07                      RLCA                        ;                       ' 4     |
1448   0B37 E6 03                   AND     $3                  ; A = channel number    ' 7     |
1449   0B39 C6 5C                   ADD    (PSG_ENV_SAV & $FF)  ; add offset            ' 7     | 62 (182)
1450   0B3B 4F                      LD      C, A                ; BC point on save      ' 4     |
1451   0B3C 1A                      LD      A, (DE)             ; A = PSG data          ' 7     |
1452   0B3D 1C                      INC     E                   ; next data             ' 4     |
1453   0B3E 77                      LD      (HL), A             ; write to PSG          ' 7     |
1454   0B3F 02                      LD      (BC), A             ; write to save         ' 7     |
1455   0B40             
1456   0B40             psg_env_write0
1457   0B40 1A                      LD      A, (DE)             ; A = PSG data          ' 7     |
1458   0B41 07                      RLCA                        ;                       ' 4     |
1459   0B42 07                      RLCA                        ;                       ' 4     |
1460   0B43 07                      RLCA                        ;                       ' 4     |
1461   0B44 E6 03                   AND     $3                  ; A = channel number    ' 7     |
1462   0B46 C6 5C                   ADD    (PSG_ENV_SAV & $FF)  ; add offset            ' 7     | 62 (244)
1463   0B48 4F                      LD      C, A                ; BC point on save      ' 4     |
1464   0B49 1A                      LD      A, (DE)             ; A = PSG data          ' 7     |
1465   0B4A 1C                      INC     E                   ; next data             ' 4     |
1466   0B4B 77                      LD      (HL), A             ; write to PSG          ' 7     |
1467   0B4C 02                      LD      (BC), A             ; write to save         ' 7     |
1468   0B4D             
1469   0B4D C3 3C 0A                JP      execute_xgm         ;                       ' 10    | (254)
1470   0B50             
1471   0B50             
1472   0B50             ; YM port0 command
1473   0B50             ; ----------------
1474   0B50             
1475   0B50             com_ym_port0_w0                         ; 20                    ' 80
1476   0B50                         wait36                      ; sync                  ' 36    |
1476   0B50 ED 4F       >            LD      R, A
1476   0B52 ED 4F       >            LD      R, A
1476   0B54 ED 4F       >            LD      R, A
1476   0B56 ED 4F       >            LD      R, A
1477   0B58 21 00 40                LD      HL, YMPORT0         ; HL point on YM port0  ' 10    | 66 (146)
1478   0B5B 01 01 40                LD      BC, YMPORT1         ; BC point on YM port1  ' 10    |
1479   0B5E C3 50 0D                JP      ym_port_write0      ;                       ' 10    |
1480   0B61             
1481   0B61             com_ym_port0_w1                         ; 21                    ' 80
1482   0B61 21 00 40                LD      HL, YMPORT0         ; HL point on YM port0  ' 10    |
1483   0B64 01 01 40                LD      BC, YMPORT1         ; BC point on YM port1  ' 10    | 30 (110)
1484   0B67 C3 4A 0D                JP      ym_port_write1      ;                       ' 10    |
1485   0B6A             
1486   0B6A             com_ym_port0_w2                         ; 22                    ' 80
1487   0B6A                         wait52                      ; sync                  ' 52    |
1487   0B6A 3E 02       >            LD      A, w            ; 7-2
1487   0B6C 3D          >            DEC     A               ; 4
1487   0B6D 20 FD       >            JR      NZ, .loop       ; 12
1487   0B6F ED 4F       >            LD      R, A
1487   0B71 ED 4F       >            LD      R, A
1488   0B73 21 00 40                LD      HL, YMPORT0         ; HL point on YM port0  ' 10    | 82 (162)
1489   0B76 01 01 40                LD      BC, YMPORT1         ; BC point on YM port1  ' 10    |
1490   0B79 C3 47 0E                JP      ym_port_write2      ;                       ' 10    |
1491   0B7C             
1492   0B7C             com_ym_port0_w3                         ; 23                    ' 80
1493   0B7C 21 00 40                LD      HL, YMPORT0         ; HL point on YM port0  ' 10    |
1494   0B7F 44 4D                   LD      BC, HL              ; BC point on YM port0  ' 10    |
1495   0B81 03                      INC     BC                  ; BC point on YM port1  ' 6     | 36 (116)
1496   0B82 C3 26 0D                JP      com_ym_port_w3      ; execute               ' 10    |
1497   0B85             
1498   0B85             com_ym_port0_w4                         ; 24                    ' 80
1499   0B85                         wait144                     ; sync                  ' 144   |
1499   0B85 3E 08       >            LD      A, w            ; 7-2
1499   0B87 3D          >            DEC     A               ; 4
1499   0B88 20 FD       >            JR      NZ, .loop       ; 12
1499   0B8A F6 00       >            OR      $0
1499   0B8C F6 00       >            OR      $0
1500   0B8E 21 00 40                LD      HL, YMPORT0         ; HL point on YM port0  ' 10    | 178 (254+4)
1501   0B91 01 01 40                LD      BC, YMPORT1         ; BC point on YM port1  ' 10    |
1502   0B94 D9                      EXX                         ;                       ' 4     |
1503   0B95 C3 25 0E                JP      ym_port_write4      ;                       ' 10    |
1504   0B98             
1505   0B98             com_ym_port0_w5                         ; 25                    ' 80
1506   0B98                         wait52                      ; sync                  ' 52    |
1506   0B98 3E 02       >            LD      A, w            ; 7-2
1506   0B9A 3D          >            DEC     A               ; 4
1506   0B9B 20 FD       >            JR      NZ, .loop       ; 12
1506   0B9D ED 4F       >            LD      R, A
1506   0B9F ED 4F       >            LD      R, A
1507   0BA1 21 00 40                LD      HL, YMPORT0         ; HL point on YM port0  ' 10    | 82 (162)
1508   0BA4 01 01 40                LD      BC, YMPORT1         ; BC point on YM port1  ' 10    |
1509   0BA7 C3 12 0E                JP      ym_port_write5      ;                       ' 10    |
1510   0BAA             
1511   0BAA             com_ym_port0_w6                         ; 26                    ' 80
1512   0BAA 21 00 40                LD      HL, YMPORT0         ; HL point on YM port0  ' 10    |
1513   0BAD 44 4D                   LD      BC, HL              ; BC point on YM port0  ' 10    |
1514   0BAF 03                      INC     BC                  ; BC point on YM port1  ' 6     | 36 (116)
1515   0BB0 C3 2F 0D                JP      com_ym_port_w6      ; execute               ' 10    |
1516   0BB3             
1517   0BB3             com_ym_port0_w7                         ; 27                    ' 80
1518   0BB3                         wait144                     ; sync                  ' 144   |
1518   0BB3 3E 08       >            LD      A, w            ; 7-2
1518   0BB5 3D          >            DEC     A               ; 4
1518   0BB6 20 FD       >            JR      NZ, .loop       ; 12
1518   0BB8 F6 00       >            OR      $0
1518   0BBA F6 00       >            OR      $0
1519   0BBC 21 00 40                LD      HL, YMPORT0         ; HL point on YM port0  ' 10    | 178 (254+4)
1520   0BBF 01 01 40                LD      BC, YMPORT1         ; BC point on YM port1  ' 10    |
1521   0BC2 D9                      EXX                         ;                       ' 4     |
1522   0BC3 C3 F0 0D                JP      ym_port_write7      ;                       ' 10    |
1523   0BC6             
1524   0BC6             com_ym_port0_w8                         ; 28                    ' 80
1525   0BC6                         wait52                      ; sync                  ' 52    |
1525   0BC6 3E 02       >            LD      A, w            ; 7-2
1525   0BC8 3D          >            DEC     A               ; 4
1525   0BC9 20 FD       >            JR      NZ, .loop       ; 12
1525   0BCB ED 4F       >            LD      R, A
1525   0BCD ED 4F       >            LD      R, A
1526   0BCF 21 00 40                LD      HL, YMPORT0         ; HL point on YM port0  ' 10    | 82 (162)
1527   0BD2 01 01 40                LD      BC, YMPORT1         ; BC point on YM port1  ' 10    |
1528   0BD5 C3 DD 0D                JP      ym_port_write8      ;                       ' 10    |
1529   0BD8             
1530   0BD8             com_ym_port0_w9                         ; 29                    ' 80
1531   0BD8 21 00 40                LD      HL, YMPORT0         ; HL point on YM port0  ' 10    |
1532   0BDB 44 4D                   LD      BC, HL              ; BC point on YM port0  ' 10    |
1533   0BDD 03                      INC     BC                  ; BC point on YM port1  ' 6     | 36 (116)
1534   0BDE C3 38 0D                JP      com_ym_port_w9      ; execute               ' 10    |
1535   0BE1             
1536   0BE1             com_ym_port0_wA                         ; 2A                    ' 80
1537   0BE1                         wait144                     ; sync                  ' 144   |
1537   0BE1 3E 08       >            LD      A, w            ; 7-2
1537   0BE3 3D          >            DEC     A               ; 4
1537   0BE4 20 FD       >            JR      NZ, .loop       ; 12
1537   0BE6 F6 00       >            OR      $0
1537   0BE8 F6 00       >            OR      $0
1538   0BEA 21 00 40                LD      HL, YMPORT0         ; HL point on YM port0  ' 10    | 178 (254+4)
1539   0BED 01 01 40                LD      BC, YMPORT1         ; BC point on YM port1  ' 10    |
1540   0BF0 D9                      EXX                         ;                       ' 4     |
1541   0BF1 C3 BB 0D                JP      ym_port_writeA      ;                       ' 10    |
1542   0BF4             
1543   0BF4             com_ym_port0_wB                         ; 2B                    ' 80
1544   0BF4                         wait52                      ; sync                  ' 52    |
1544   0BF4 3E 02       >            LD      A, w            ; 7-2
1544   0BF6 3D          >            DEC     A               ; 4
1544   0BF7 20 FD       >            JR      NZ, .loop       ; 12
1544   0BF9 ED 4F       >            LD      R, A
1544   0BFB ED 4F       >            LD      R, A
1545   0BFD 21 00 40                LD      HL, YMPORT0         ; HL point on YM port0  ' 10    | 82 (162)
1546   0C00 01 01 40                LD      BC, YMPORT1         ; BC point on YM port1  ' 10    |
1547   0C03 C3 A8 0D                JP      ym_port_writeB      ;                       ' 10    |
1548   0C06             
1549   0C06             com_ym_port0_wC                         ; 2C                    ' 80
1550   0C06 21 00 40                LD      HL, YMPORT0         ; HL point on YM port0  ' 10    |
1551   0C09 44 4D                   LD      BC, HL              ; BC point on YM port0  ' 10    |
1552   0C0B 03                      INC     BC                  ; BC point on YM port1  ' 6     | 36 (116)
1553   0C0C C3 41 0D                JP      com_ym_port_wC      ; execute               ' 10    |
1554   0C0F             
1555   0C0F             com_ym_port0_wD                         ; 2D                    ' 80
1556   0C0F                         wait144                     ; sync                  ' 144   |
1556   0C0F 3E 08       >            LD      A, w            ; 7-2
1556   0C11 3D          >            DEC     A               ; 4
1556   0C12 20 FD       >            JR      NZ, .loop       ; 12
1556   0C14 F6 00       >            OR      $0
1556   0C16 F6 00       >            OR      $0
1557   0C18 21 00 40                LD      HL, YMPORT0         ; HL point on YM port0  ' 10    | 174 (254)
1558   0C1B 01 01 40                LD      BC, YMPORT1         ; BC point on YM port1  ' 10    |
1559   0C1E C3 85 0D                JP      ym_port_writeD      ;                       ' 10    |
1560   0C21             
1561   0C21             com_ym_port0_wE                         ; 2E                    ' 80
1562   0C21                         wait36                      ; sync                  ' 36    |
1562   0C21 ED 4F       >            LD      R, A
1562   0C23 ED 4F       >            LD      R, A
1562   0C25 ED 4F       >            LD      R, A
1562   0C27 ED 4F       >            LD      R, A
1563   0C29 21 00 40                LD      HL, YMPORT0         ; HL point on YM port0  ' 10    | 66 (146)
1564   0C2C 01 01 40                LD      BC, YMPORT1         ; BC point on YM port1  ' 10    |
1565   0C2F C3 6F 0D                JP      ym_port_writeE      ;                       ' 10    |
1566   0C32             
1567   0C32             com_ym_port0_wF                         ; 2F                    ' 80
1568   0C32 21 00 40                LD      HL, YMPORT0         ; HL point on YM port0  ' 10    |
1569   0C35 01 01 40                LD      BC, YMPORT1         ; BC point on YM port1  ' 10    | 30 (110)
1570   0C38 C3 69 0D                JP      ym_port_writeF      ;                       ' 10    |
1571   0C3B             
1572   0C3B             
1573   0C3B             ; YM port2 command
1574   0C3B             ; ----------------
1575   0C3B             
1576   0C3B             com_ym_port2_w0                         ; 30                    ' 80
1577   0C3B                         wait36                      ; sync                  ' 36    |
1577   0C3B ED 4F       >            LD      R, A
1577   0C3D ED 4F       >            LD      R, A
1577   0C3F ED 4F       >            LD      R, A
1577   0C41 ED 4F       >            LD      R, A
1578   0C43 21 02 40                LD      HL, YMPORT2         ; HL point on YM port2  ' 10    | 66 (146)
1579   0C46 01 03 40                LD      BC, YMPORT3         ; BC point on YM port3  ' 10    |
1580   0C49 C3 50 0D                JP      ym_port_write0      ;                       ' 10    |
1581   0C4C             
1582   0C4C             com_ym_port2_w1                         ; 31                    ' 80
1583   0C4C 21 02 40                LD      HL, YMPORT2         ; HL point on YM port2  ' 10    |
1584   0C4F 01 03 40                LD      BC, YMPORT3         ; BC point on YM port3  ' 10    | 30 (110)
1585   0C52 C3 4A 0D                JP      ym_port_write1      ;                       ' 10    |
1586   0C55             
1587   0C55             com_ym_port2_w2                         ; 32                    ' 80
1588   0C55                         wait52                      ; sync                  ' 52    |
1588   0C55 3E 02       >            LD      A, w            ; 7-2
1588   0C57 3D          >            DEC     A               ; 4
1588   0C58 20 FD       >            JR      NZ, .loop       ; 12
1588   0C5A ED 4F       >            LD      R, A
1588   0C5C ED 4F       >            LD      R, A
1589   0C5E 21 02 40                LD      HL, YMPORT2         ; HL point on YM port2  ' 10    | 82 (162)
1590   0C61 01 03 40                LD      BC, YMPORT3         ; BC point on YM port3  ' 10    |
1591   0C64 C3 47 0E                JP      ym_port_write2      ;                       ' 10    |
1592   0C67             
1593   0C67             com_ym_port2_w3                         ; 33                    ' 80
1594   0C67 21 02 40                LD      HL, YMPORT2         ; HL point on YM port2  ' 10    |
1595   0C6A 44 4D                   LD      BC, HL              ; BC point on YM port2  ' 10    |
1596   0C6C 03                      INC     BC                  ; BC point on YM port3  ' 6     | 36 (116)
1597   0C6D C3 26 0D                JP      com_ym_port_w3      ; execute               ' 10    |
1598   0C70             
1599   0C70             com_ym_port2_w4                         ; 34                    ' 80
1600   0C70                         wait144                     ; sync                  ' 144   |
1600   0C70 3E 08       >            LD      A, w            ; 7-2
1600   0C72 3D          >            DEC     A               ; 4
1600   0C73 20 FD       >            JR      NZ, .loop       ; 12
1600   0C75 F6 00       >            OR      $0
1600   0C77 F6 00       >            OR      $0
1601   0C79 21 02 40                LD      HL, YMPORT2         ; HL point on YM port0  ' 10    | 178 (254+4)
1602   0C7C 01 03 40                LD      BC, YMPORT3         ; BC point on YM port3  ' 10    |
1603   0C7F D9                      EXX                         ;                       ' 4     |
1604   0C80 C3 25 0E                JP      ym_port_write4      ;                       ' 10    |
1605   0C83             
1606   0C83             com_ym_port2_w5                         ; 35                    ' 80
1607   0C83                         wait52                      ; sync                  ' 52    |
1607   0C83 3E 02       >            LD      A, w            ; 7-2
1607   0C85 3D          >            DEC     A               ; 4
1607   0C86 20 FD       >            JR      NZ, .loop       ; 12
1607   0C88 ED 4F       >            LD      R, A
1607   0C8A ED 4F       >            LD      R, A
1608   0C8C 21 02 40                LD      HL, YMPORT2         ; HL point on YM port2  ' 10    | 82 (162)
1609   0C8F 01 03 40                LD      BC, YMPORT3         ; BC point on YM port3  ' 10    |
1610   0C92 C3 12 0E                JP      ym_port_write5      ;                       ' 10    |
1611   0C95             
1612   0C95             com_ym_port2_w6                         ; 36                    ' 80
1613   0C95 21 02 40                LD      HL, YMPORT2         ; HL point on YM port2  ' 10    |
1614   0C98 44 4D                   LD      BC, HL              ; BC point on YM port2  ' 10    |
1615   0C9A 03                      INC     BC                  ; BC point on YM port3  ' 6     | 36 (116)
1616   0C9B C3 2F 0D                JP      com_ym_port_w6      ; execute               ' 10    |
1617   0C9E             
1618   0C9E             com_ym_port2_w7                         ; 37                    ' 80
1619   0C9E                         wait144                     ; sync                  ' 144   |
1619   0C9E 3E 08       >            LD      A, w            ; 7-2
1619   0CA0 3D          >            DEC     A               ; 4
1619   0CA1 20 FD       >            JR      NZ, .loop       ; 12
1619   0CA3 F6 00       >            OR      $0
1619   0CA5 F6 00       >            OR      $0
1620   0CA7 21 02 40                LD      HL, YMPORT2         ; HL point on YM port0  ' 10    | 178 (254+4)
1621   0CAA 01 03 40                LD      BC, YMPORT3         ; BC point on YM port3  ' 10    |
1622   0CAD D9                      EXX                         ;                       ' 4     |
1623   0CAE C3 F0 0D                JP      ym_port_write7      ;                       ' 10    |
1624   0CB1             
1625   0CB1             com_ym_port2_w8                         ; 38                    ' 80
1626   0CB1                         wait52                      ; sync                  ' 52    |
1626   0CB1 3E 02       >            LD      A, w            ; 7-2
1626   0CB3 3D          >            DEC     A               ; 4
1626   0CB4 20 FD       >            JR      NZ, .loop       ; 12
1626   0CB6 ED 4F       >            LD      R, A
1626   0CB8 ED 4F       >            LD      R, A
1627   0CBA 21 02 40                LD      HL, YMPORT2         ; HL point on YM port2  ' 10    | 82 (162)
1628   0CBD 01 03 40                LD      BC, YMPORT3         ; BC point on YM port3  ' 10    |
1629   0CC0 C3 DD 0D                JP      ym_port_write8      ;                       ' 10    |
1630   0CC3             
1631   0CC3             com_ym_port2_w9                         ; 39                    ' 80
1632   0CC3 21 02 40                LD      HL, YMPORT2         ; HL point on YM port2  ' 10    |
1633   0CC6 44 4D                   LD      BC, HL              ; BC point on YM port2  ' 10    |
1634   0CC8 03                      INC     BC                  ; BC point on YM port3  ' 6     | 36 (116)
1635   0CC9 C3 38 0D                JP      com_ym_port_w9      ; execute               ' 10    |
1636   0CCC             
1637   0CCC             com_ym_port2_wA                         ; 3A                    ' 80
1638   0CCC                         wait144                     ; sync                  ' 144   |
1638   0CCC 3E 08       >            LD      A, w            ; 7-2
1638   0CCE 3D          >            DEC     A               ; 4
1638   0CCF 20 FD       >            JR      NZ, .loop       ; 12
1638   0CD1 F6 00       >            OR      $0
1638   0CD3 F6 00       >            OR      $0
1639   0CD5 21 02 40                LD      HL, YMPORT2         ; HL point on YM port0  ' 10    | 178 (254+4)
1640   0CD8 01 03 40                LD      BC, YMPORT3         ; BC point on YM port3  ' 10    |
1641   0CDB D9                      EXX                         ;                       ' 4     |
1642   0CDC C3 BB 0D                JP      ym_port_writeA      ;                       ' 10    |
1643   0CDF             
1644   0CDF             com_ym_port2_wB                         ; 3B                    ' 80
1645   0CDF                         wait52                      ; sync                  ' 52    |
1645   0CDF 3E 02       >            LD      A, w            ; 7-2
1645   0CE1 3D          >            DEC     A               ; 4
1645   0CE2 20 FD       >            JR      NZ, .loop       ; 12
1645   0CE4 ED 4F       >            LD      R, A
1645   0CE6 ED 4F       >            LD      R, A
1646   0CE8 21 02 40                LD      HL, YMPORT2         ; HL point on YM port2  ' 10    | 82 (162)
1647   0CEB 01 03 40                LD      BC, YMPORT3         ; BC point on YM port3  ' 10    |
1648   0CEE C3 A8 0D                JP      ym_port_writeB      ;                       ' 10    |
1649   0CF1             
1650   0CF1             com_ym_port2_wC                         ; 3C                    ' 80
1651   0CF1 21 02 40                LD      HL, YMPORT2         ; HL point on YM port2  ' 10    |
1652   0CF4 44 4D                   LD      BC, HL              ; BC point on YM port2  ' 10    |
1653   0CF6 03                      INC     BC                  ; BC point on YM port3  ' 6     | 36 (116)
1654   0CF7 C3 41 0D                JP      com_ym_port_wC      ; execute               ' 10    |
1655   0CFA             
1656   0CFA             com_ym_port2_wD                         ; 3D                    ' 80
1657   0CFA                         wait144                     ; sync                  ' 144   |
1657   0CFA 3E 08       >            LD      A, w            ; 7-2
1657   0CFC 3D          >            DEC     A               ; 4
1657   0CFD 20 FD       >            JR      NZ, .loop       ; 12
1657   0CFF F6 00       >            OR      $0
1657   0D01 F6 00       >            OR      $0
1658   0D03 21 02 40                LD      HL, YMPORT2         ; HL point on YM port2  ' 10    | 174 (254)
1659   0D06 01 03 40                LD      BC, YMPORT3         ; BC point on YM port3  ' 10    |
1660   0D09 C3 85 0D                JP      ym_port_writeD      ;                       ' 10    |
1661   0D0C             
1662   0D0C             com_ym_port2_wE                         ; 3E                    ' 80
1663   0D0C                         wait36                      ; sync                  ' 36    |
1663   0D0C ED 4F       >            LD      R, A
1663   0D0E ED 4F       >            LD      R, A
1663   0D10 ED 4F       >            LD      R, A
1663   0D12 ED 4F       >            LD      R, A
1664   0D14 21 02 40                LD      HL, YMPORT2         ; HL point on YM port2  ' 10    | 66 (146)
1665   0D17 01 03 40                LD      BC, YMPORT3         ; BC point on YM port3  ' 10    |
1666   0D1A C3 6F 0D                JP      ym_port_writeE      ;                       ' 10    |
1667   0D1D             
1668   0D1D             com_ym_port2_wF                         ; 3F                    ' 80
1669   0D1D 21 02 40                LD      HL, YMPORT2         ; HL point on YM port2  ' 10    |
1670   0D20 01 03 40                LD      BC, YMPORT3         ; BC point on YM port3  ' 10    | 30 (110)
1671   0D23 C3 69 0D                JP      ym_port_writeF      ;                       ' 10    |
1672   0D26             
1673   0D26             
1674   0D26             com_ym_port_w3                          ;                       ' 116
1675   0D26 1A                      LD      A, (DE)             ; A = YM reg num        ' 7     |
1676   0D27 77                      LD      (HL), A             ; write reg num to YM   ' 7     |
1677   0D28 1C                      INC     E                   ; next data             ' 4     |
1678   0D29 1A                      LD      A, (DE)             ; A = YM reg data       ' 7     | 36 (152)
1679   0D2A 1C                      INC     E                   ; next data             ' 4     |
1680   0D2B 02                      LD      (BC), A             ; write data to YM      ' 7     |
1681   0D2C C3 47 0E                JP      ym_port_write2      ;                       ' 10    | (162)
1682   0D2F             
1683   0D2F             com_ym_port_w6                          ;                       ' 116
1684   0D2F 1A                      LD      A, (DE)             ; A = YM reg num        ' 7     |
1685   0D30 77                      LD      (HL), A             ; write reg num to YM   ' 7     |
1686   0D31 1C                      INC     E                   ; next data             ' 4     |
1687   0D32 1A                      LD      A, (DE)             ; A = YM reg data       ' 7     | 36 (152)
1688   0D33 1C                      INC     E                   ; next data             ' 4     |
1689   0D34 02                      LD      (BC), A             ; write data to YM      ' 7     |
1690   0D35 C3 12 0E                JP      ym_port_write5      ;                       ' 10    | (162)
1691   0D38             
1692   0D38             com_ym_port_w9                          ;                       ' 116
1693   0D38 1A                      LD      A, (DE)             ; A = YM reg num        ' 7     |
1694   0D39 77                      LD      (HL), A             ; write reg num to YM   ' 7     |
1695   0D3A 1C                      INC     E                   ; next data             ' 4     |
1696   0D3B 1A                      LD      A, (DE)             ; A = YM reg data       ' 7     | 36 (152)
1697   0D3C 1C                      INC     E                   ; next data             ' 4     |
1698   0D3D 02                      LD      (BC), A             ; write data to YM      ' 7     |
1699   0D3E C3 DD 0D                JP      ym_port_write8      ;                       ' 10    | (162)
1700   0D41             
1701   0D41             com_ym_port_wC                          ;                       ' 116
1702   0D41 1A                      LD      A, (DE)             ; A = YM reg num        ' 7     |
1703   0D42 77                      LD      (HL), A             ; write reg num to YM   ' 7     |
1704   0D43 1C                      INC     E                   ; next data             ' 4     |
1705   0D44 1A                      LD      A, (DE)             ; A = YM reg data       ' 7     | 36 (152)
1706   0D45 1C                      INC     E                   ; next data             ' 4     |
1707   0D46 02                      LD      (BC), A             ; write data to YM      ' 7     |
1708   0D47 C3 A8 0D                JP      ym_port_writeB      ;                       ' 10    | (162)
1709   0D4A             
1710   0D4A             
1711   0D4A             ym_port_write1                          ;                       ' 110
1712   0D4A 1A                      LD      A, (DE)             ; A = YM reg num        ' 7     |
1713   0D4B 77                      LD      (HL), A             ; write reg num to YM   ' 7     |
1714   0D4C 1C                      INC     E                   ; next data             ' 4     |
1715   0D4D 1A                      LD      A, (DE)             ; A = YM reg data       ' 7     | 36 (146)
1716   0D4E 1C                      INC     E                   ; next data             ' 4     |
1717   0D4F 02                      LD      (BC), A             ; write data to YM      ' 7     |
1718   0D50             
1719   0D50             ym_port_write0
1720   0D50 1A                      LD      A, (DE)             ; A = YM reg num        ' 7     |
1721   0D51                         waitYMReady                 ; wait YM to be ready   ' 30    |
1721   0D51 D9          >            EXX                     ;                           ' 4     | (4)
1721   0D52 CB 7E       >            BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
1721   0D54 C2 52 0D    >            JP      NZ, .wait       ; wait while busy           ' 10    |
1721   0D57 D9          >            EXX                     ;                           ' 4     | (30)
1722   0D58 77                      LD      (HL), A             ; write reg num to YM   ' 7     | 66 (212)
1723   0D59 1C                      INC     E                   ; next data             ' 4     |
1724   0D5A 1A                      LD      A, (DE)             ; A = YM reg data       ' 7     |
1725   0D5B 1C                      INC     E                   ; next data             ' 4     |
1726   0D5C 02                      LD      (BC), A             ; write to YM           ' 7     |
1727   0D5D             
1728   0D5D D9                      EXX                         ; switch to HL' (port0) ' 4     |
1729   0D5E             .wait                                   ;                       '       |
1730   0D5E CB 7E                   BIT     7, (HL)             ; test YM ready bit     ' 12    |
1731   0D60 C2 5E 0D                JP      NZ, .wait           ; wait while busy       ' 10    | 40 (252)
1732   0D63                                                     ;                       '       |
1733   0D63 36 2A                   LD      (HL), $2A           ; restore DAC write     ' 10    |
1734   0D65 D9                      EXX                         ; switch back           ' 4     |
1735   0D66             
1736   0D66 C3 3C 0A                JP      execute_xgm         ; +8 cycles here        ' 10    | (254+8)
1737   0D69             
1738   0D69             ym_port_writeF                          ;                       ' 110
1739   0D69 1A                      LD      A, (DE)             ; A = YM reg num        ' 7     |
1740   0D6A 77                      LD      (HL), A             ; write reg num to YM   ' 7     |
1741   0D6B 1C                      INC     E                   ; next data             ' 4     |
1742   0D6C 1A                      LD      A, (DE)             ; A = YM reg data       ' 7     | 36 (146)
1743   0D6D 1C                      INC     E                   ; next data             ' 4     |
1744   0D6E 02                      LD      (BC), A             ; write data to YM      ' 7     |
1745   0D6F             
1746   0D6F             ym_port_writeE
1747   0D6F 1A                      LD      A, (DE)             ; A = YM reg num        ' 7     |
1748   0D70                         waitYMReady                 ; wait YM to be ready   ' 30    |
1748   0D70 D9          >            EXX                     ;                           ' 4     | (4)
1748   0D71 CB 7E       >            BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
1748   0D73 C2 71 0D    >            JP      NZ, .wait       ; wait while busy           ' 10    |
1748   0D76 D9          >            EXX                     ;                           ' 4     | (30)
1749   0D77 77                      LD      (HL), A             ; write reg num to YM   ' 7     | 66 (212)
1750   0D78 1C                      INC     E                   ; next data             ' 4     |
1751   0D79 1A                      LD      A, (DE)             ; A = YM reg data       ' 7     |
1752   0D7A 1C                      INC     E                   ; next data             ' 4     |
1753   0D7B 02                      LD      (BC), A             ; write to YM           ' 7     |
1754   0D7C             
1755   0D7C                         wait12                      ; sync                  ' 12    |
1755   0D7C 18 00       >            JR      .go
1756   0D7E                         waitYMReady                 ; wait YM to be ready   ' 30    | 42 (254)
1756   0D7E D9          >            EXX                     ;                           ' 4     | (4)
1756   0D7F CB 7E       >            BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
1756   0D81 C2 7F 0D    >            JP      NZ, .wait       ; wait while busy           ' 10    |
1756   0D84 D9          >            EXX                     ;                           ' 4     | (30)
1757   0D85             
1758   0D85             ym_port_writeD
1759   0D85                         sampleOutputSafe            ;                       ' 46    | (46)
1759   0D85 D9          >            EXX                     ;                           ' 4     | 4
1759   0D86 36 2A       >            LD      (HL), $2A       ; prepare DAC write         ' 10    |
1759   0D88 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
1759   0D89 03          >            INC     BC              ; increment read address    ' 6     | 38 (42)
1759   0D8A CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     |
1759   0D8C 12          >            LD      (DE), A         ; play sample               ' 7     |
1759   0D8D D9          >            EXX                     ;                           ' 4     | (46)
1760   0D8E             
1761   0D8E 1A                      LD      A, (DE)             ; A = YM reg num        ' 7     |
1762   0D8F                         waitYMReady                 ; wait YM to be ready   ' 30    |
1762   0D8F D9          >            EXX                     ;                           ' 4     | (4)
1762   0D90 CB 7E       >            BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
1762   0D92 C2 90 0D    >            JP      NZ, .wait       ; wait while busy           ' 10    |
1762   0D95 D9          >            EXX                     ;                           ' 4     | (30)
1763   0D96 77                      LD      (HL), A             ; write reg num to YM   ' 7     | 66 (112)
1764   0D97 1C                      INC     E                   ; next data             ' 4     |
1765   0D98 1A                      LD      A, (DE)             ; A = YM reg data       ' 7     |
1766   0D99 1C                      INC     E                   ; next data             ' 4     |
1767   0D9A 02                      LD      (BC), A             ; write to YM           ' 7     |
1768   0D9B             
1769   0D9B             ;ym_port_writeC
1770   0D9B 1A                      LD      A, (DE)             ; A = YM reg num        ' 7     |
1771   0D9C                         waitYMReady                 ; wait YM to be ready   ' 30    |
1771   0D9C D9          >            EXX                     ;                           ' 4     | (4)
1771   0D9D CB 7E       >            BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
1771   0D9F C2 9D 0D    >            JP      NZ, .wait       ; wait while busy           ' 10    |
1771   0DA2 D9          >            EXX                     ;                           ' 4     | (30)
1772   0DA3 77                      LD      (HL), A             ; write reg num to YM   ' 7     | 66 (178)
1773   0DA4 1C                      INC     E                   ; next data             ' 4     |
1774   0DA5 1A                      LD      A, (DE)             ; A = YM reg data       ' 7     |
1775   0DA6 1C                      INC     E                   ; next data             ' 4     |
1776   0DA7 02                      LD      (BC), A             ; write to YM           ' 7     |
1777   0DA8             
1778   0DA8             ym_port_writeB
1779   0DA8 1A                      LD      A, (DE)             ; A = YM reg num        ' 7     |
1780   0DA9                         waitYMReady                 ; wait YM to be ready   ' 30    |
1780   0DA9 D9          >            EXX                     ;                           ' 4     | (4)
1780   0DAA CB 7E       >            BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
1780   0DAC C2 AA 0D    >            JP      NZ, .wait       ; wait while busy           ' 10    |
1780   0DAF D9          >            EXX                     ;                           ' 4     | (30)
1781   0DB0 77                      LD      (HL), A             ; write reg num to YM   ' 7     | 66 (244)
1782   0DB1 1C                      INC     E                   ; next data             ' 4     |
1783   0DB2 1A                      LD      A, (DE)             ; A = YM reg data       ' 7     |
1784   0DB3 1C                      INC     E                   ; next data             ' 4     |
1785   0DB4 02                      LD      (BC), A             ; write to YM           ' 7     |
1786   0DB5             
1787   0DB5 D9                      EXX                         ; switch to HL' (port0) ' 4     | (248)
1788   0DB6             .wait                                   ;                       '       |
1789   0DB6 CB 7E                   BIT     7, (HL)             ; test YM ready bit     ' 12    |
1790   0DB8 C2 B6 0D                JP      NZ, .wait           ; wait while busy       ' 10    | 22 (258+14)
1791   0DBB             
1792   0DBB             ym_port_writeA                          ;                       ' 4
1793   0DBB 36 2A                   LD      (HL), $2A           ; restore DAC write     ' 10    |
1794   0DBD 0A                      LD      A, (BC)             ;                       ' 7     |
1795   0DBE 03                      INC     BC                  ; play sample           ' 6     | 42 (46)
1796   0DBF CB 90                   RES     2, B                ;                       ' 8     |
1797   0DC1 12                      LD      (DE), A             ;                       ' 7     |
1798   0DC2 D9                      EXX                         ;                       ' 4     |
1799   0DC3             
1800   0DC3 1A                      LD      A, (DE)             ; A = YM reg num        ' 7     |
1801   0DC4                         waitYMReady                 ; wait YM to be ready   ' 30    |
1801   0DC4 D9          >            EXX                     ;                           ' 4     | (4)
1801   0DC5 CB 7E       >            BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
1801   0DC7 C2 C5 0D    >            JP      NZ, .wait       ; wait while busy           ' 10    |
1801   0DCA D9          >            EXX                     ;                           ' 4     | (30)
1802   0DCB 77                      LD      (HL), A             ; write reg num to YM   ' 7     | 66 (112)
1803   0DCC 1C                      INC     E                   ; next data             ' 4     |
1804   0DCD 1A                      LD      A, (DE)             ; A = YM reg data       ' 7     |
1805   0DCE 1C                      INC     E                   ; next data             ' 4     |
1806   0DCF 02                      LD      (BC), A             ; write to YM           ' 7     |
1807   0DD0             
1808   0DD0             ;ym_port_write9
1809   0DD0 1A                      LD      A, (DE)             ; A = YM reg num        ' 7     |
1810   0DD1                         waitYMReady                 ; wait YM to be ready   ' 30    |
1810   0DD1 D9          >            EXX                     ;                           ' 4     | (4)
1810   0DD2 CB 7E       >            BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
1810   0DD4 C2 D2 0D    >            JP      NZ, .wait       ; wait while busy           ' 10    |
1810   0DD7 D9          >            EXX                     ;                           ' 4     | (30)
1811   0DD8 77                      LD      (HL), A             ; write reg num to YM   ' 7     | 66 (178)
1812   0DD9 1C                      INC     E                   ; next data             ' 4     |
1813   0DDA 1A                      LD      A, (DE)             ; A = YM reg data       ' 7     |
1814   0DDB 1C                      INC     E                   ; next data             ' 4     |
1815   0DDC 02                      LD      (BC), A             ; write to YM           ' 7     |
1816   0DDD             
1817   0DDD             ym_port_write8
1818   0DDD 1A                      LD      A, (DE)             ; A = YM reg num        ' 7     |
1819   0DDE                         waitYMReady                 ; wait YM to be ready   ' 30    |
1819   0DDE D9          >            EXX                     ;                           ' 4     | (4)
1819   0DDF CB 7E       >            BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
1819   0DE1 C2 DF 0D    >            JP      NZ, .wait       ; wait while busy           ' 10    |
1819   0DE4 D9          >            EXX                     ;                           ' 4     | (30)
1820   0DE5 77                      LD      (HL), A             ; write reg num to YM   ' 7     | 66 (244)
1821   0DE6 1C                      INC     E                   ; next data             ' 4     |
1822   0DE7 1A                      LD      A, (DE)             ; A = YM reg data       ' 7     |
1823   0DE8 1C                      INC     E                   ; next data             ' 4     |
1824   0DE9 02                      LD      (BC), A             ; write to YM           ' 7     |
1825   0DEA             
1826   0DEA D9                      EXX                         ; switch to HL' (port0) ' 4     | (248)
1827   0DEB             .wait                                   ;                       '       |
1828   0DEB CB 7E                   BIT     7, (HL)             ; test YM ready bit     ' 12    |
1829   0DED C2 EB 0D                JP      NZ, .wait           ; wait while busy       ' 10    | 22 (258+14)
1830   0DF0             
1831   0DF0             ym_port_write7                          ;                       ' 4
1832   0DF0 36 2A                   LD      (HL), $2A           ; restore DAC write     ' 10    |
1833   0DF2 0A                      LD      A, (BC)             ;                       ' 7     |
1834   0DF3 03                      INC     BC                  ; play sample           ' 6     | 42 (46)
1835   0DF4 CB 90                   RES     2, B                ;                       ' 8     |
1836   0DF6 12                      LD      (DE), A             ;                       ' 7     |
1837   0DF7 D9                      EXX                         ;                       ' 4     |
1838   0DF8             
1839   0DF8 1A                      LD      A, (DE)             ; A = YM reg num        ' 7     |
1840   0DF9                         waitYMReady                 ; wait YM to be ready   ' 30    |
1840   0DF9 D9          >            EXX                     ;                           ' 4     | (4)
1840   0DFA CB 7E       >            BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
1840   0DFC C2 FA 0D    >            JP      NZ, .wait       ; wait while busy           ' 10    |
1840   0DFF D9          >            EXX                     ;                           ' 4     | (30)
1841   0E00 77                      LD      (HL), A             ; write reg num to YM   ' 7     | 66 (112)
1842   0E01 1C                      INC     E                   ; next data             ' 4     |
1843   0E02 1A                      LD      A, (DE)             ; A = YM reg data       ' 7     |
1844   0E03 1C                      INC     E                   ; next data             ' 4     |
1845   0E04 02                      LD      (BC), A             ; write to YM           ' 7     |
1846   0E05             
1847   0E05             ;ym_port_write6
1848   0E05 1A                      LD      A, (DE)             ; A = YM reg num        ' 7     |
1849   0E06                         waitYMReady                 ; wait YM to be ready   ' 30    |
1849   0E06 D9          >            EXX                     ;                           ' 4     | (4)
1849   0E07 CB 7E       >            BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
1849   0E09 C2 07 0E    >            JP      NZ, .wait       ; wait while busy           ' 10    |
1849   0E0C D9          >            EXX                     ;                           ' 4     | (30)
1850   0E0D 77                      LD      (HL), A             ; write reg num to YM   ' 7     | 66 (178)
1851   0E0E 1C                      INC     E                   ; next data             ' 4     |
1852   0E0F 1A                      LD      A, (DE)             ; A = YM reg data       ' 7     |
1853   0E10 1C                      INC     E                   ; next data             ' 4     |
1854   0E11 02                      LD      (BC), A             ; write to YM           ' 7     |
1855   0E12             
1856   0E12             ym_port_write5
1857   0E12 1A                      LD      A, (DE)             ; A = YM reg num        ' 7     |
1858   0E13                         waitYMReady                 ; wait YM to be ready   ' 30    |
1858   0E13 D9          >            EXX                     ;                           ' 4     | (4)
1858   0E14 CB 7E       >            BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
1858   0E16 C2 14 0E    >            JP      NZ, .wait       ; wait while busy           ' 10    |
1858   0E19 D9          >            EXX                     ;                           ' 4     | (30)
1859   0E1A 77                      LD      (HL), A             ; write reg num to YM   ' 7     | 66 (244)
1860   0E1B 1C                      INC     E                   ; next data             ' 4     |
1861   0E1C 1A                      LD      A, (DE)             ; A = YM reg data       ' 7     |
1862   0E1D 1C                      INC     E                   ; next data             ' 4     |
1863   0E1E 02                      LD      (BC), A             ; write to YM           ' 7     |
1864   0E1F             
1865   0E1F D9                      EXX                         ; switch to HL' (port0) ' 4     | (248)
1866   0E20             .wait                                   ;                       '       |
1867   0E20 CB 7E                   BIT     7, (HL)             ; test YM ready bit     ' 12    |
1868   0E22 C2 20 0E                JP      NZ, .wait           ; wait while busy       ' 10    | 22 (258+14)
1869   0E25             
1870   0E25             ym_port_write4                          ;                       ' 4
1871   0E25 36 2A                   LD      (HL), $2A           ; restore DAC write     ' 10    |
1872   0E27 0A                      LD      A, (BC)             ;                       ' 7     |
1873   0E28 03                      INC     BC                  ; play sample           ' 6     | 42 (46)
1874   0E29 CB 90                   RES     2, B                ;                       ' 8     |
1875   0E2B 12                      LD      (DE), A             ;                       ' 7     |
1876   0E2C D9                      EXX                         ;                       ' 4     |
1877   0E2D             
1878   0E2D 1A                      LD      A, (DE)             ; A = YM reg num        ' 7     |
1879   0E2E                         waitYMReady                 ; wait YM to be ready   ' 30    |
1879   0E2E D9          >            EXX                     ;                           ' 4     | (4)
1879   0E2F CB 7E       >            BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
1879   0E31 C2 2F 0E    >            JP      NZ, .wait       ; wait while busy           ' 10    |
1879   0E34 D9          >            EXX                     ;                           ' 4     | (30)
1880   0E35 77                      LD      (HL), A             ; write reg num to YM   ' 7     | 66 (112)
1881   0E36 1C                      INC     E                   ; next data             ' 4     |
1882   0E37 1A                      LD      A, (DE)             ; A = YM reg data       ' 7     |
1883   0E38 1C                      INC     E                   ; next data             ' 4     |
1884   0E39 02                      LD      (BC), A             ; write to YM           ' 7     |
1885   0E3A             
1886   0E3A             ;ym_port_write3
1887   0E3A 1A                      LD      A, (DE)             ; A = YM reg num        ' 7     |
1888   0E3B                         waitYMReady                 ; wait YM to be ready   ' 30    |
1888   0E3B D9          >            EXX                     ;                           ' 4     | (4)
1888   0E3C CB 7E       >            BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
1888   0E3E C2 3C 0E    >            JP      NZ, .wait       ; wait while busy           ' 10    |
1888   0E41 D9          >            EXX                     ;                           ' 4     | (30)
1889   0E42 77                      LD      (HL), A             ; write reg num to YM   ' 7     | 66 (178)
1890   0E43 1C                      INC     E                   ; next data             ' 4     |
1891   0E44 1A                      LD      A, (DE)             ; A = YM reg data       ' 7     |
1892   0E45 1C                      INC     E                   ; next data             ' 4     |
1893   0E46 02                      LD      (BC), A             ; write to YM           ' 7     |
1894   0E47             
1895   0E47             ym_port_write2
1896   0E47 1A                      LD      A, (DE)             ; A = YM reg num        ' 7     |
1897   0E48                         waitYMReady                 ; wait YM to be ready   ' 30    |
1897   0E48 D9          >            EXX                     ;                           ' 4     | (4)
1897   0E49 CB 7E       >            BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
1897   0E4B C2 49 0E    >            JP      NZ, .wait       ; wait while busy           ' 10    |
1897   0E4E D9          >            EXX                     ;                           ' 4     | (30)
1898   0E4F 77                      LD      (HL), A             ; write reg num to YM   ' 7     | 66 (244)
1899   0E50 1C                      INC     E                   ; next data             ' 4     |
1900   0E51 1A                      LD      A, (DE)             ; A = YM reg data       ' 7     |
1901   0E52 1C                      INC     E                   ; next data             ' 4     |
1902   0E53 02                      LD      (BC), A             ; write to YM           ' 7     |
1903   0E54             
1904   0E54 D9                      EXX                         ; switch to HL' (port0) ' 4     | (248)
1905   0E55             .wait                                   ;                       '       |
1906   0E55 CB 7E                   BIT     7, (HL)             ; test YM ready bit     ' 12    |
1907   0E57 C2 55 0E                JP      NZ, .wait           ; wait while busy       ' 10    | 22 (258+14)
1908   0E5A             
1909   0E5A 36 2A                   LD      (HL), $2A           ; restore DAC write     ' 10    |
1910   0E5C 0A                      LD      A, (BC)             ;                       ' 7     |
1911   0E5D 03                      INC     BC                  ; play sample           ' 6     | 42 (46)
1912   0E5E CB 90                   RES     2, B                ;                       ' 8     |
1913   0E60 12                      LD      (DE), A             ;                       ' 7     |
1914   0E61 D9                      EXX                         ;                       ' 4     |
1915   0E62             
1916   0E62                         wait24                      ; sync                  ' 24    | 54 (100)
1916   0E62 18 00       >            JR      .go
1916   0E64 18 00       >            JR      .go
1917   0E66                         waitYMReady                 ; wait YM to be ready   ' 30    |
1917   0E66 D9          >            EXX                     ;                           ' 4     | (4)
1917   0E67 CB 7E       >            BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
1917   0E69 C2 67 0E    >            JP      NZ, .wait       ; wait while busy           ' 10    |
1917   0E6C D9          >            EXX                     ;                           ' 4     | (30)
1918   0E6D             
1919   0E6D C3 4A 0D                JP      ym_port_write1      ; execute next          ' 10    | (110)
1920   0E70             
1921   0E70             
1922   0E70             ; YM KEY command
1923   0E70             ; --------------
1924   0E70             
1925   0E70             com_ym_key_w0                           ; 40                    ' 80
1926   0E70                         wait44                      ; sync                  ' 44    |
1926   0E70 3E 02       >            LD      A, w            ; 7-2
1926   0E72 3D          >            DEC     A               ; 4
1926   0E73 20 FD       >            JR      NZ, .loop       ; 12
1926   0E75 C3 78 0E    >            JP      .go
1927   0E78 21 00 40                LD      HL, YMPORT0         ; HL point on YM port0  ' 10    |
1928   0E7B 01 01 40                LD      BC, YMPORT1         ; BC point on YM port1  ' 10    | 84 (164)
1929   0E7E 36 28                   LD      (HL), $28           ; set reg num to YM     ' 10    |
1930   0E80 C3 EE 0E                JP      ym_key_write0       ;                       ' 10    |
1931   0E83             
1932   0E83             com_ym_key_w1                           ; 41                    ' 80
1933   0E83                         wait4                       ; sync                  ' 4     |
1933   0E83 00          >            NOP
1934   0E84 21 00 40                LD      HL, YMPORT0         ; HL point on YM port0  ' 10    |
1935   0E87 01 01 40                LD      BC, YMPORT1         ; BC point on YM port1  ' 10    | 44 (124)
1936   0E8A 36 28                   LD      (HL), $28           ; set reg num to YM     ' 10    |
1937   0E8C C3 E6 0E                JP      ym_key_write1       ;                       ' 10    |
1938   0E8F             
1939   0E8F             com_ym_key_w2                           ; 43                    ' 80
1940   0E8F                         wait134                     ; sync                  ' 134   |
1940   0E8F 3E 08       >            LD      A, w            ; 7-2
1940   0E91 3D          >            DEC     A               ; 4
1940   0E92 20 FD       >            JR      NZ, .loop       ; 12
1940   0E94 00          >            NOP
1941   0E95 21 00 40                LD      HL, YMPORT0         ; HL point on YM port0  ' 10    |
1942   0E98 01 01 40                LD      BC, YMPORT1         ; BC point on YM port1  ' 10    |
1943   0E9B 36 28                   LD      (HL), $28           ; set reg num to YM     ' 10    | 174 (254)
1944   0E9D C3 21 0F                JP      ym_key_write2       ;                       ' 10    |
1945   0EA0             
1946   0EA0             com_ym_key_w3                           ; 44                    ' 80
1947   0EA0                         wait64                      ; sync                  ' 64    |
1947   0EA0 3E 03       >            LD      A, w            ; 7-2
1947   0EA2 3D          >            DEC     A               ; 4
1947   0EA3 20 FD       >            JR      NZ, .loop       ; 12
1947   0EA5 F6 00       >            OR      $0
1947   0EA7 F6 00       >            OR      $0
1948   0EA9 21 00 40                LD      HL, YMPORT0         ; HL point on YM port0  ' 10    |
1949   0EAC 01 01 40                LD      BC, YMPORT1         ; BC point on YM port1  ' 10    |
1950   0EAF 36 28                   LD      (HL), $28           ; set reg num to YM     ' 10    | 104 (184)
1951   0EB1 C3 12 0F                JP      ym_key_write3       ;                       ' 10    |
1952   0EB4             
1953   0EB4             com_ym_key_w4                           ; 45                    ' 80
1954   0EB4                         wait24                      ; sync                  ' 24    |
1954   0EB4 18 00       >            JR      .go
1954   0EB6 18 00       >            JR      .go
1955   0EB8 21 00 40                LD      HL, YMPORT0         ; HL point on YM port0  ' 10    |
1956   0EBB 01 01 40                LD      BC, YMPORT1         ; BC point on YM port1  ' 10    |
1957   0EBE 36 28                   LD      (HL), $28           ; set reg num to YM     ' 10    | 64 (144)
1958   0EC0 C3 0A 0F                JP      ym_key_write4       ;                       ' 10    |
1959   0EC3             
1960   0EC3             com_ym_key_w5                           ; 46                    ' 80
1961   0EC3                         wait154                     ; sync                  ' 174   |
1961   0EC3 3E 09       >            LD      A, w            ; 7-2
1961   0EC5 3D          >            DEC     A               ; 4
1961   0EC6 20 FD       >            JR      NZ, .loop       ; 12
1961   0EC8 00          >            NOP
1961   0EC9 00          >            NOP
1962   0ECA 21 00 40                LD      HL, YMPORT0         ; HL point on YM port0  ' 10    | 174 (254)
1963   0ECD 01 01 40                LD      BC, YMPORT1         ; BC point on YM port1  ' 10    |
1964   0ED0             
1965   0ED0                         sampleOutputSafe            ;                       ' 46    | (46)
1965   0ED0 D9          >            EXX                     ;                           ' 4     | 4
1965   0ED1 36 2A       >            LD      (HL), $2A       ; prepare DAC write         ' 10    |
1965   0ED3 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
1965   0ED4 03          >            INC     BC              ; increment read address    ' 6     | 38 (42)
1965   0ED5 CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     |
1965   0ED7 12          >            LD      (DE), A         ; play sample               ' 7     |
1965   0ED8 D9          >            EXX                     ;                           ' 4     | (46)
1966   0ED9             
1967   0ED9                         wait16                      ; sync                  ' 16    |
1967   0ED9 18 00       >            JR      .go
1967   0EDB 00          >            NOP
1968   0EDC                         waitYMReadyFast             ; wait YM to be ready   ' 22    |
1968   0EDC CB 7E       >            BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
1968   0EDE C2 DC 0E    >            JP      NZ, .wait       ; wait while busy           ' 10    |
1969   0EE1 36 28                   LD      (HL), $28           ; set reg num to YM     ' 10    | 58 (104)
1970   0EE3 C3 02 0F                JP      ym_key_write5       ;                       ' 10    |
1971   0EE6             
1972   0EE6             
1973   0EE6             ym_key_write1                           ;                       ' 124
1974   0EE6 1A                      LD      A, (DE)             ; A = YM key data       ' 7     |
1975   0EE7 1C                      INC     E                   ; next data             ' 4     |
1976   0EE8                         waitYMReadyFast             ; wait YM to be ready   ' 22    | 40 (164)
1976   0EE8 CB 7E       >            BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
1976   0EEA C2 E8 0E    >            JP      NZ, .wait       ; wait while busy           ' 10    |
1977   0EED 02                      LD      (BC), A             ; write to YM           ' 7     |
1978   0EEE             
1979   0EEE             ym_key_write0                           ;                       ' 164
1980   0EEE 1A                      LD      A, (DE)             ; A = YM key data       ' 7     |
1981   0EEF 1C                      INC     E                   ; next data             ' 4     |
1982   0EF0                         waitYMReadyFast             ; wait YM to be ready   ' 22    | 40 (204)
1982   0EF0 CB 7E       >            BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
1982   0EF2 C2 F0 0E    >            JP      NZ, .wait       ; wait while busy           ' 10    |
1983   0EF5 02                      LD      (BC), A             ; write to YM           ' 7     |
1984   0EF6             
1985   0EF6                         wait8                       ; sync                  ' 8     |
1985   0EF6 00          >            NOP
1985   0EF7 00          >            NOP
1986   0EF8                         waitYMReadyFast             ; wait YM to be ready   ' 22    | 40 (244)
1986   0EF8 CB 7E       >            BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
1986   0EFA C2 F8 0E    >            JP      NZ, .wait       ; wait while busy           ' 10    |
1987   0EFD 36 2A                   LD      (HL), $2A           ; restore DAC write     ' 10    |
1988   0EFF             
1989   0EFF C3 3C 0A                JP      execute_xgm         ;                       ' 10    | (254)
1990   0F02             
1991   0F02             ym_key_write5                           ;                       ' 104
1992   0F02 1A                      LD      A, (DE)             ; A = YM key data       ' 7     |
1993   0F03 1C                      INC     E                   ; next data             ' 4     |
1994   0F04                         waitYMReadyFast             ; wait YM to be ready   ' 22    | 40 (144)
1994   0F04 CB 7E       >            BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
1994   0F06 C2 04 0F    >            JP      NZ, .wait       ; wait while busy           ' 10    |
1995   0F09 02                      LD      (BC), A             ; write to YM           ' 7     |
1996   0F0A             
1997   0F0A             ym_key_write4                           ;                       ' 144
1998   0F0A 1A                      LD      A, (DE)             ; A = YM key data       ' 7     |
1999   0F0B 1C                      INC     E                   ; next data             ' 4     |
2000   0F0C                         waitYMReadyFast             ; wait YM to be ready   ' 22    | 40 (184)
2000   0F0C CB 7E       >            BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
2000   0F0E C2 0C 0F    >            JP      NZ, .wait       ; wait while busy           ' 10    |
2001   0F11 02                      LD      (BC), A             ; write to YM           ' 7     |
2002   0F12             
2003   0F12             ym_key_write3                           ;                       ' 184
2004   0F12 1A                      LD      A, (DE)             ; A = YM key data       ' 7     |
2005   0F13 1C                      INC     E                   ; next data             ' 4     |
2006   0F14                         waitYMReadyFast             ; wait YM to be ready   ' 22    | 40 (224)
2006   0F14 CB 7E       >            BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
2006   0F16 C2 14 0F    >            JP      NZ, .wait       ; wait while busy           ' 10    |
2007   0F19 02                      LD      (BC), A             ; write to YM           ' 7     |
2008   0F1A             
2009   0F1A                         wait8                       ; sync                  ' 8     |
2009   0F1A 00          >            NOP
2009   0F1B 00          >            NOP
2010   0F1C                         waitYMReadyFast             ; wait YM to be ready   ' 22    | 30 (254)
2010   0F1C CB 7E       >            BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
2010   0F1E C2 1C 0F    >            JP      NZ, .wait       ; wait while busy           ' 10    |
2011   0F21             
2012   0F21             ym_key_write2
2013   0F21                         sampleOutputSafe            ;                       ' 46    | (46)
2013   0F21 D9          >            EXX                     ;                           ' 4     | 4
2013   0F22 36 2A       >            LD      (HL), $2A       ; prepare DAC write         ' 10    |
2013   0F24 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
2013   0F25 03          >            INC     BC              ; increment read address    ' 6     | 38 (42)
2013   0F26 CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     |
2013   0F28 12          >            LD      (DE), A         ; play sample               ' 7     |
2013   0F29 D9          >            EXX                     ;                           ' 4     | (46)
2014   0F2A             
2015   0F2A                         wait8                       ; sync                  ' 8     |
2015   0F2A 00          >            NOP
2015   0F2B 00          >            NOP
2016   0F2C                         waitYMReadyFast             ; wait YM to be ready   ' 22    | 40 (86)
2016   0F2C CB 7E       >            BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
2016   0F2E C2 2C 0F    >            JP      NZ, .wait       ; wait while busy           ' 10    |
2017   0F31 36 28                   LD      (HL), $28           ; restore write to key  ' 10    |
2018   0F33             
2019   0F33 1A                      LD      A, (DE)             ; A = YM key data       ' 7     |
2020   0F34 13                      INC     DE                  ; next data             ' 6     |
2021   0F35                         waitYMReadyFast             ; wait YM to be ready   ' 22    | 40 (126)
2021   0F35 CB 7E       >            BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
2021   0F37 C2 35 0F    >            JP      NZ, .wait       ; wait while busy           ' 10    |
2022   0F3A 02                      LD      (BC), A             ; write to YM           ' 7     |
2023   0F3B             
2024   0F3B             .write1
2025   0F3B 1A                      LD      A, (DE)             ; A = YM key data       ' 7     |
2026   0F3C 1C                      INC     E                   ; next data             ' 4     |
2027   0F3D                         waitYMReadyFast             ; wait YM to be ready   ' 22    | 40 (166)
2027   0F3D CB 7E       >            BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
2027   0F3F C2 3D 0F    >            JP      NZ, .wait       ; wait while busy           ' 10    |
2028   0F42 02                      LD      (BC), A             ; write to YM           ' 7     |
2029   0F43             
2030   0F43             .write0
2031   0F43 1A                      LD      A, (DE)             ; A = YM key data       ' 7     |
2032   0F44 1C                      INC     E                   ; next data             ' 4     |
2033   0F45                         waitYMReadyFast             ; wait YM to be ready   ' 22    | 40 (206)
2033   0F45 CB 7E       >            BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
2033   0F47 C2 45 0F    >            JP      NZ, .wait       ; wait while busy           ' 10    |
2034   0F4A 02                      LD      (BC), A             ; write to YM           ' 7     |
2035   0F4B             
2036   0F4B                         wait7                       ; sync                  ' 7     |
2036   0F4B F6 00       >            OR      $0
2037   0F4D                         waitYMReadyFast             ; wait YM to be ready   ' 22    | 39 (245)
2037   0F4D CB 7E       >            BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
2037   0F4F C2 4D 0F    >            JP      NZ, .wait       ; wait while busy           ' 10    |
2038   0F52 36 2A                   LD      (HL), $2A           ; restore DAC write     ' 10    |
2039   0F54             
2040   0F54 C3 3C 0A                JP      execute_xgm         ;                       ' 10    | (254+1)
2041   0F57             
2042   0F57             
2043   0F57             ; PCM command
2044   0F57             ; -----------
2045   0F57             
2046   0F57             com_pcm_p0_ch0                          ; 50                    ' 80
2047   0F57 0E 00                   LD      C, 0                ; C = prio              ' 7     |
2048   0F59 C3 A7 0F                JP      com_pcm_ch0         ; execute PCM com       ' 10    | 17 (97)
2049   0F5C             
2050   0F5C             com_pcm_p1_ch0                          ; 54                    ' 80
2051   0F5C 0E 01                   LD      C, 1                ; C = prio              ' 7     |
2052   0F5E C3 A7 0F                JP      com_pcm_ch0         ; execute PCM com       ' 10    | 17 (97)
2053   0F61             
2054   0F61             com_pcm_p2_ch0                          ; 58                    ' 80
2055   0F61 0E 02                   LD      C, 2                ; C = prio              ' 7     |
2056   0F63 C3 A7 0F                JP      com_pcm_ch0         ; execute PCM com       ' 10    | 17 (97)
2057   0F66             
2058   0F66             com_pcm_p3_ch0                          ; 5C                    ' 80
2059   0F66 0E 03                   LD      C, 3                ; C = prio              ' 7     |
2060   0F68 C3 A7 0F                JP      com_pcm_ch0         ; execute PCM com       ' 10    | 17 (97)
2061   0F6B             
2062   0F6B             com_pcm_p0_ch1                          ; 51                    ' 80
2063   0F6B 0E 00                   LD      C, 0                ; C = prio              ' 7     |
2064   0F6D C3 D6 0F                JP      com_pcm_ch1         ; execute PCM com       ' 10    | 17 (97)
2065   0F70             
2066   0F70             com_pcm_p1_ch1                          ; 55                    ' 80
2067   0F70 0E 01                   LD      C, 1                ; C = prio              ' 7     |
2068   0F72 C3 D6 0F                JP      com_pcm_ch1         ; execute PCM com       ' 10    | 17 (97)
2069   0F75             
2070   0F75             com_pcm_p2_ch1                          ; 59                    ' 80
2071   0F75 0E 02                   LD      C, 2                ; C = prio              ' 7     |
2072   0F77 C3 D6 0F                JP      com_pcm_ch1         ; execute PCM com       ' 10    | (119)
2073   0F7A             
2074   0F7A             com_pcm_p3_ch1                          ; 5D                    ' 80
2075   0F7A 0E 03                   LD      C, 3                ; C = prio              ' 7     |
2076   0F7C C3 D6 0F                JP      com_pcm_ch1         ; execute PCM com       ' 10    | (119)
2077   0F7F             
2078   0F7F             com_pcm_p0_ch2                          ; 52                    ' 80
2079   0F7F 0E 00                   LD      C, 0                ; C = prio              ' 7     |
2080   0F81 C3 05 10                JP      com_pcm_ch2         ; execute PCM com       ' 10    | (119)
2081   0F84             
2082   0F84             com_pcm_p1_ch2                          ; 56                    ' 80
2083   0F84 0E 01                   LD      C, 1                ; C = prio              ' 7     |
2084   0F86 C3 05 10                JP      com_pcm_ch2         ; execute PCM com       ' 10    | (119)
2085   0F89             
2086   0F89             com_pcm_p2_ch2                          ; 5A                    ' 80
2087   0F89 0E 02                   LD      C, 2                ; C = prio              ' 7     |
2088   0F8B C3 05 10                JP      com_pcm_ch2         ; execute PCM com       ' 10    | (119)
2089   0F8E             
2090   0F8E             com_pcm_p3_ch2                          ; 5E                    ' 80
2091   0F8E 0E 03                   LD      C, 3                ; C = prio              ' 7     |
2092   0F90 C3 05 10                JP      com_pcm_ch2         ; execute PCM com       ' 10    | (119)
2093   0F93             
2094   0F93             com_pcm_p0_ch3                          ; 53                    ' 80
2095   0F93 0E 00                   LD      C, 0                ; C = prio              ' 7     |
2096   0F95 C3 34 10                JP      com_pcm_ch3         ; execute PCM com       ' 10    | (119)
2097   0F98             
2098   0F98             com_pcm_p1_ch3                          ; 57                    ' 80
2099   0F98 0E 01                   LD      C, 1                ; C = prio              ' 7     |
2100   0F9A C3 34 10                JP      com_pcm_ch3         ; execute PCM com       ' 10    | (119)
2101   0F9D             
2102   0F9D             com_pcm_p2_ch3                          ; 5B                    ' 80
2103   0F9D 0E 02                   LD      C, 2                ; C = prio              ' 7     |
2104   0F9F C3 34 10                JP      com_pcm_ch3         ; execute PCM com       ' 10    | (119)
2105   0FA2             
2106   0FA2             com_pcm_p3_ch3                          ; 5F                    ' 80
2107   0FA2 0E 03                   LD      C, 3                ; C = prio              ' 7     |
2108   0FA4 C3 34 10                JP      com_pcm_ch3         ; execute PCM com       ' 10    | (119)
2109   0FA7             
2110   0FA7             
2111   0FA7             com_pcm_ch0                             ;                       ' 97
2112   0FA7                         handlePCMCommandXGM 0       ; handle command        ' 142   |
2112   0FA7 21 14 01    >            LD      HL, PCM_PRIO+(ch*8)     ; HL point on PCM info      ' 10    |
2112   0FAA 79          >            LD      A, C                    ; A = new prio              ' 4     |
2112   0FAB BE          >            CP      (HL)                    ; compare new and old prio  ' 7     | (31)
2112   0FAC D2 BC 0F    >            JP      NC, .play_new           ; >= old prio --> play new  ' 10    |
2112   0FAF 1C          >            INC     E                       ; next XGM command          ' 4     |
2112   0FB0 3E 05       >            LD      A, w            ; 7-2
2112   0FB2 3D          >            DEC     A               ; 4
2112   0FB3 20 FD       >            JR      NZ, .loop       ; 12
2112   0FB5 00          >            NOP
2112   0FB6 00          >            NOP
2112   0FB7 F6 00       >            OR      $0
2112   0FB9 C3 D2 0F    >            JP      .end                    ; done                      ' 10    |
2112   0FBC 1A          >            LD      A, (DE)                 ; A = PCM id (max = $3F)    ' 7     |
2112   0FBD 1C          >            INC     E                       ; next XGM command          ' 4     |
2112   0FBE B7          >            OR      A                       ; not a stop PCM command ?  ' 4     | 27 (58)
2112   0FBF 20 02       >            JR      NZ, .PCM_play           ; go set new prio           ' 7/12  |
2112   0FC1 0E 00       >            LD      C, 0                    ; reset prio for stop       ' 7     | +2
2112   0FC3 71          >            LD      (HL), C                 ; set new prio              ' 7     | (65)
2112   0FC4 26 1C       >            LD      H, (ID_TABLE>>8)        ;                           ' 7     |
2112   0FC6 87          >            ADD     A                       ;                           ' 4     |
2112   0FC7 87          >            ADD     A                       ;                           ' 4     | 25 (90)
2112   0FC8 6F          >            LD      L, A                    ; HL point on new PCM addr  ' 4     |
2112   0FC9 F9          >            LD      SP, HL                  ; set SP to new PCM addr    ' 6     |
2112   0FCA E1          >            POP     HL                      ; copy params               ' 10    |
2112   0FCB 22 16 01    >            LD      (PCM_ADDR+(ch*8)),HL    ;                           ' 16    |
2112   0FCE E1          >            POP     HL                      ;                           ' 10    | 52 (142)
2112   0FCF 22 18 01    >            LD      (PCM_LEN+(ch*8)),HL     ;                           ' 16    |
2113   0FD2                         wait4                       ; sync                  ' 4     | 156 (254-1)
2113   0FD2 00          >            NOP
2114   0FD3 C3 3C 0A                JP      execute_xgm         ;                       ' 10    |
2115   0FD6             
2116   0FD6             com_pcm_ch1                             ;                       ' 97
2117   0FD6                         handlePCMCommandXGM 1       ; handle command        ' 142   |
2117   0FD6 21 1C 01    >            LD      HL, PCM_PRIO+(ch*8)     ; HL point on PCM info      ' 10    |
2117   0FD9 79          >            LD      A, C                    ; A = new prio              ' 4     |
2117   0FDA BE          >            CP      (HL)                    ; compare new and old prio  ' 7     | (31)
2117   0FDB D2 EB 0F    >            JP      NC, .play_new           ; >= old prio --> play new  ' 10    |
2117   0FDE 1C          >            INC     E                       ; next XGM command          ' 4     |
2117   0FDF 3E 05       >            LD      A, w            ; 7-2
2117   0FE1 3D          >            DEC     A               ; 4
2117   0FE2 20 FD       >            JR      NZ, .loop       ; 12
2117   0FE4 00          >            NOP
2117   0FE5 00          >            NOP
2117   0FE6 F6 00       >            OR      $0
2117   0FE8 C3 01 10    >            JP      .end                    ; done                      ' 10    |
2117   0FEB 1A          >            LD      A, (DE)                 ; A = PCM id (max = $3F)    ' 7     |
2117   0FEC 1C          >            INC     E                       ; next XGM command          ' 4     |
2117   0FED B7          >            OR      A                       ; not a stop PCM command ?  ' 4     | 27 (58)
2117   0FEE 20 02       >            JR      NZ, .PCM_play           ; go set new prio           ' 7/12  |
2117   0FF0 0E 00       >            LD      C, 0                    ; reset prio for stop       ' 7     | +2
2117   0FF2 71          >            LD      (HL), C                 ; set new prio              ' 7     | (65)
2117   0FF3 26 1C       >            LD      H, (ID_TABLE>>8)        ;                           ' 7     |
2117   0FF5 87          >            ADD     A                       ;                           ' 4     |
2117   0FF6 87          >            ADD     A                       ;                           ' 4     | 25 (90)
2117   0FF7 6F          >            LD      L, A                    ; HL point on new PCM addr  ' 4     |
2117   0FF8 F9          >            LD      SP, HL                  ; set SP to new PCM addr    ' 6     |
2117   0FF9 E1          >            POP     HL                      ; copy params               ' 10    |
2117   0FFA 22 1E 01    >            LD      (PCM_ADDR+(ch*8)),HL    ;                           ' 16    |
2117   0FFD E1          >            POP     HL                      ;                           ' 10    | 52 (142)
2117   0FFE 22 20 01    >            LD      (PCM_LEN+(ch*8)),HL     ;                           ' 16    |
2118   1001                         wait4                       ; sync                  ' 4     | 156 (254-1)
2118   1001 00          >            NOP
2119   1002 C3 3C 0A                JP      execute_xgm         ;                       ' 10    |
2120   1005             
2121   1005             com_pcm_ch2                             ;                       ' 97
2122   1005                         handlePCMCommandXGM 2       ; handle command        ' 142   |
2122   1005 21 24 01    >            LD      HL, PCM_PRIO+(ch*8)     ; HL point on PCM info      ' 10    |
2122   1008 79          >            LD      A, C                    ; A = new prio              ' 4     |
2122   1009 BE          >            CP      (HL)                    ; compare new and old prio  ' 7     | (31)
2122   100A D2 1A 10    >            JP      NC, .play_new           ; >= old prio --> play new  ' 10    |
2122   100D 1C          >            INC     E                       ; next XGM command          ' 4     |
2122   100E 3E 05       >            LD      A, w            ; 7-2
2122   1010 3D          >            DEC     A               ; 4
2122   1011 20 FD       >            JR      NZ, .loop       ; 12
2122   1013 00          >            NOP
2122   1014 00          >            NOP
2122   1015 F6 00       >            OR      $0
2122   1017 C3 30 10    >            JP      .end                    ; done                      ' 10    |
2122   101A 1A          >            LD      A, (DE)                 ; A = PCM id (max = $3F)    ' 7     |
2122   101B 1C          >            INC     E                       ; next XGM command          ' 4     |
2122   101C B7          >            OR      A                       ; not a stop PCM command ?  ' 4     | 27 (58)
2122   101D 20 02       >            JR      NZ, .PCM_play           ; go set new prio           ' 7/12  |
2122   101F 0E 00       >            LD      C, 0                    ; reset prio for stop       ' 7     | +2
2122   1021 71          >            LD      (HL), C                 ; set new prio              ' 7     | (65)
2122   1022 26 1C       >            LD      H, (ID_TABLE>>8)        ;                           ' 7     |
2122   1024 87          >            ADD     A                       ;                           ' 4     |
2122   1025 87          >            ADD     A                       ;                           ' 4     | 25 (90)
2122   1026 6F          >            LD      L, A                    ; HL point on new PCM addr  ' 4     |
2122   1027 F9          >            LD      SP, HL                  ; set SP to new PCM addr    ' 6     |
2122   1028 E1          >            POP     HL                      ; copy params               ' 10    |
2122   1029 22 26 01    >            LD      (PCM_ADDR+(ch*8)),HL    ;                           ' 16    |
2122   102C E1          >            POP     HL                      ;                           ' 10    | 52 (142)
2122   102D 22 28 01    >            LD      (PCM_LEN+(ch*8)),HL     ;                           ' 16    |
2123   1030                         wait4                       ; sync                  ' 4     | 156 (254-1)
2123   1030 00          >            NOP
2124   1031 C3 3C 0A                JP      execute_xgm         ;                       ' 10    |
2125   1034             
2126   1034             com_pcm_ch3                             ;                       ' 97
2127   1034                         handlePCMCommandXGM 3       ; handle command        ' 142   |
2127   1034 21 2C 01    >            LD      HL, PCM_PRIO+(ch*8)     ; HL point on PCM info      ' 10    |
2127   1037 79          >            LD      A, C                    ; A = new prio              ' 4     |
2127   1038 BE          >            CP      (HL)                    ; compare new and old prio  ' 7     | (31)
2127   1039 D2 49 10    >            JP      NC, .play_new           ; >= old prio --> play new  ' 10    |
2127   103C 1C          >            INC     E                       ; next XGM command          ' 4     |
2127   103D 3E 05       >            LD      A, w            ; 7-2
2127   103F 3D          >            DEC     A               ; 4
2127   1040 20 FD       >            JR      NZ, .loop       ; 12
2127   1042 00          >            NOP
2127   1043 00          >            NOP
2127   1044 F6 00       >            OR      $0
2127   1046 C3 5F 10    >            JP      .end                    ; done                      ' 10    |
2127   1049 1A          >            LD      A, (DE)                 ; A = PCM id (max = $3F)    ' 7     |
2127   104A 1C          >            INC     E                       ; next XGM command          ' 4     |
2127   104B B7          >            OR      A                       ; not a stop PCM command ?  ' 4     | 27 (58)
2127   104C 20 02       >            JR      NZ, .PCM_play           ; go set new prio           ' 7/12  |
2127   104E 0E 00       >            LD      C, 0                    ; reset prio for stop       ' 7     | +2
2127   1050 71          >            LD      (HL), C                 ; set new prio              ' 7     | (65)
2127   1051 26 1C       >            LD      H, (ID_TABLE>>8)        ;                           ' 7     |
2127   1053 87          >            ADD     A                       ;                           ' 4     |
2127   1054 87          >            ADD     A                       ;                           ' 4     | 25 (90)
2127   1055 6F          >            LD      L, A                    ; HL point on new PCM addr  ' 4     |
2127   1056 F9          >            LD      SP, HL                  ; set SP to new PCM addr    ' 6     |
2127   1057 E1          >            POP     HL                      ; copy params               ' 10    |
2127   1058 22 2E 01    >            LD      (PCM_ADDR+(ch*8)),HL    ;                           ' 16    |
2127   105B E1          >            POP     HL                      ;                           ' 10    | 52 (142)
2127   105C 22 30 01    >            LD      (PCM_LEN+(ch*8)),HL     ;                           ' 16    |
2128   105F                         wait4                       ; sync                  ' 4     | 156 (254-1)
2128   105F 00          >            NOP
2129   1060 C3 3C 0A                JP      execute_xgm         ;                       ' 10    |
2130   1063             
2131   1063             
2132   1063             
2133   1063             ; STATE command
2134   1063             ; -------------
2135   1063             
2136   1063             com_state_w0                            ; 60                    ' 80
2137   1063                         wait114                     ; sync                  ' 114   |
2137   1063 3E 07       >            LD      A, w            ; 7-2
2137   1065 3D          >            DEC     A               ; 4
2137   1066 20 FD       >            JR      NZ, .loop       ; 12
2138   1068 26 01                   LD      H, (YM_RR_SAV >> 8) ; H point on YM save H  ' 7     | 131 (211)
2139   106A C3 AF 11                JP      state_w0            ; execute               ' 10    |
2140   106D             
2141   106D             com_state_w1                            ; 61                    ' 80
2142   106D                         wait81                      ; sync                  ' 81    |
2142   106D 3E 04       >            LD      A, w            ; 7-2
2142   106F 3D          >            DEC     A               ; 4
2142   1070 20 FD       >            JR      NZ, .loop       ; 12
2142   1072 00          >            NOP
2142   1073 00          >            NOP
2142   1074 F6 00       >            OR      $0
2143   1076 26 01                   LD      H, (YM_RR_SAV >> 8) ; H point on YM save H  ' 7     | 98 (178)
2144   1078 C3 A9 11                JP      state_w1            ; execute               ' 10    |
2145   107B             
2146   107B             com_state_w2                            ; 62                    ' 80
2147   107B                         wait48                      ; sync                  ' 48    |
2147   107B ED 4F       >            LD      R, A
2147   107D ED 4F       >            LD      R, A
2147   107F ED 4F       >            LD      R, A
2147   1081 ED 4F       >            LD      R, A
2147   1083 18 00       >            JR      .go
2148   1085 26 01                   LD      H, (YM_RR_SAV >> 8) ; H point on YM save H  ' 7     | 65 (145)
2149   1087 C3 A3 11                JP      state_w2            ; execute               ' 10    |
2150   108A             
2151   108A             com_state_w3                            ; 63                    ' 80
2152   108A                         wait15                      ; sync                  ' 15    |
2152   108A 00          >            NOP
2152   108B 00          >            NOP
2152   108C F6 00       >            OR      $0
2153   108E 26 01                   LD      H, (YM_RR_SAV >> 8) ; H point on YM save H  ' 7     | 32 (112)
2154   1090 C3 9D 11                JP      state_w3            ; execute               ' 10    |
2155   1093             
2156   1093             com_state_w4                            ; 64                    ' 80
2157   1093                         wait174                     ; sync                  ' 174   | (254)
2157   1093 3E 0A       >            LD      A, w            ; 7-2
2157   1095 3D          >            DEC     A               ; 4
2157   1096 20 FD       >            JR      NZ, .loop       ; 12
2157   1098 18 00       >            JR      .go
2158   109A                         sampleOutput                ; sample output         ' 36    | (36)
2158   109A D9          >            EXX                     ;                           ' 4     | 4
2158   109B 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
2158   109C 03          >            INC     BC              ; increment read address    ' 6     |
2158   109D CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
2158   109F 12          >            LD      (DE), A         ; play sample               ' 7     |
2158   10A0 D9          >            EXX                     ;                           ' 4     | (36)
2159   10A1             
2160   10A1                         wait26                      ; sync                  ' 26    |
2160   10A1 ED 4F       >            LD      R, A
2160   10A3 ED 4F       >            LD      R, A
2160   10A5 00          >            NOP
2160   10A6 00          >            NOP
2161   10A7 26 01                   LD      H, (YM_RR_SAV >> 8) ; H point on YM save H  ' 7     | 43 (79)
2162   10A9 C3 97 11                JP      state_w4            ; execute               ' 10    |
2163   10AC             
2164   10AC             com_state_w5                            ; 65                    ' 80
2165   10AC                         wait157                     ; sync                  ' 157   |
2165   10AC 3E 09       >            LD      A, w            ; 7-2
2165   10AE 3D          >            DEC     A               ; 4
2165   10AF 20 FD       >            JR      NZ, .loop       ; 12
2165   10B1 F6 00       >            OR      $0
2165   10B3 00          >            NOP
2166   10B4 26 01                   LD      H, (YM_RR_SAV >> 8) ; H point on YM save H  ' 7     | 174 (254)
2167   10B6 C3 87 11                JP      state_w5            ; execute               ' 10    |
2168   10B9             
2169   10B9             com_state_w6                            ; 66                    ' 80
2170   10B9                         wait124                     ; sync                  ' 124   |
2170   10B9 3E 07       >            LD      A, w            ; 7-2
2170   10BB 3D          >            DEC     A               ; 4
2170   10BC 20 FD       >            JR      NZ, .loop       ; 12
2170   10BE C3 C1 10    >            JP      .go
2171   10C1 26 01                   LD      H, (YM_RR_SAV >> 8) ; H point on YM save H  ' 7     | 141 (221)
2172   10C3 C3 81 11                JP      state_w6            ; execute               ' 10    |
2173   10C6             
2174   10C6             com_state_w7                            ; 67                    ' 80
2175   10C6                         wait91                      ; sync                  ' 91    |
2175   10C6 3E 05       >            LD      A, w            ; 7-2
2175   10C8 3D          >            DEC     A               ; 4
2175   10C9 20 FD       >            JR      NZ, .loop       ; 12
2175   10CB ED 4F       >            LD      R, A
2176   10CD 26 01                   LD      H, (YM_RR_SAV >> 8) ; H point on YM save H  ' 7     | 108 (188)
2177   10CF C3 7B 11                JP      state_w7            ; execute               ' 10    |
2178   10D2             
2179   10D2             com_state_w8                            ; 68                    ' 80
2180   10D2                         wait58                      ; sync                  ' 58    |
2180   10D2 3E 03       >            LD      A, w            ; 7-2
2180   10D4 3D          >            DEC     A               ; 4
2180   10D5 20 FD       >            JR      NZ, .loop       ; 12
2180   10D7 00          >            NOP
2180   10D8 00          >            NOP
2181   10D9 26 01                   LD      H, (YM_RR_SAV >> 8) ; H point on YM save H  ' 7     | 75 (155)
2182   10DB C3 75 11                JP      state_w8            ; execute               ' 10    |
2183   10DE             
2184   10DE             com_state_w9                            ; 69                    ' 80
2185   10DE                         wait25                      ; sync                  ' 25    |
2185   10DE 18 00       >            JR      .go
2185   10E0 ED 4F       >            LD      R, A
2185   10E2 00          >            NOP
2186   10E3 26 01                   LD      H, (YM_RR_SAV >> 8) ; H point on YM save H  ' 7     | 42 (122)
2187   10E5 C3 6F 11                JP      state_w9            ; execute               ' 10    |
2188   10E8             
2189   10E8             com_state_wA                            ; 6A                    ' 80
2190   10E8                         wait174                     ; sync                  ' 174   | (254)
2190   10E8 3E 0A       >            LD      A, w            ; 7-2
2190   10EA 3D          >            DEC     A               ; 4
2190   10EB 20 FD       >            JR      NZ, .loop       ; 12
2190   10ED 18 00       >            JR      .go
2191   10EF                         sampleOutput                ; sample output         ' 36    | (36)
2191   10EF D9          >            EXX                     ;                           ' 4     | 4
2191   10F0 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
2191   10F1 03          >            INC     BC              ; increment read address    ' 6     |
2191   10F2 CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
2191   10F4 12          >            LD      (DE), A         ; play sample               ' 7     |
2191   10F5 D9          >            EXX                     ;                           ' 4     | (36)
2192   10F6             
2193   10F6                         wait36                      ; sync                  ' 36    |
2193   10F6 ED 4F       >            LD      R, A
2193   10F8 ED 4F       >            LD      R, A
2193   10FA ED 4F       >            LD      R, A
2193   10FC ED 4F       >            LD      R, A
2194   10FE 26 01                   LD      H, (YM_RR_SAV >> 8) ; H point on YM save H  ' 7     | 53 (89)
2195   1100 C3 69 11                JP      state_wA            ; execute               ' 10    |
2196   1103             
2197   1103             com_state_wB                            ; 6B                    ' 80
2198   1103                         wait157                     ; sync                  ' 157   |
2198   1103 3E 09       >            LD      A, w            ; 7-2
2198   1105 3D          >            DEC     A               ; 4
2198   1106 20 FD       >            JR      NZ, .loop       ; 12
2198   1108 F6 00       >            OR      $0
2198   110A 00          >            NOP
2199   110B 26 01                   LD      H, (YM_RR_SAV >> 8) ; H point on YM save H  ' 7     | 174 (254)
2200   110D C3 57 11                JP      state_wB            ; execute               ' 10    |
2201   1110             
2202   1110             com_state_wC                            ; 6C                    ' 80
2203   1110                         wait124                     ; sync                  ' 124   |
2203   1110 3E 07       >            LD      A, w            ; 7-2
2203   1112 3D          >            DEC     A               ; 4
2203   1113 20 FD       >            JR      NZ, .loop       ; 12
2203   1115 C3 18 11    >            JP      .go
2204   1118 26 01                   LD      H, (YM_RR_SAV >> 8) ; H point on YM save H  ' 7     | 141 (221)
2205   111A C3 51 11                JP      state_wC            ; execute               ' 10    |
2206   111D             
2207   111D             com_state_wD                            ; 6D                    ' 80
2208   111D                         wait91                      ; sync                  ' 91    |
2208   111D 3E 05       >            LD      A, w            ; 7-2
2208   111F 3D          >            DEC     A               ; 4
2208   1120 20 FD       >            JR      NZ, .loop       ; 12
2208   1122 ED 4F       >            LD      R, A
2209   1124 26 01                   LD      H, (YM_RR_SAV >> 8) ; H point on YM save H  ' 7     | 108 (188)
2210   1126 C3 4B 11                JP      state_wD            ; execute               ' 10    |
2211   1129             
2212   1129             com_state_wE                            ; 6E                    ' 80
2213   1129                         wait58                      ; sync                  ' 58    |
2213   1129 3E 03       >            LD      A, w            ; 7-2
2213   112B 3D          >            DEC     A               ; 4
2213   112C 20 FD       >            JR      NZ, .loop       ; 12
2213   112E 00          >            NOP
2213   112F 00          >            NOP
2214   1130 26 01                   LD      H, (YM_RR_SAV >> 8) ; H point on YM save H  ' 7     | 75 (155)
2215   1132 C3 45 11                JP      state_wE            ; execute               ' 10    |
2216   1135             
2217   1135             com_state_wF                            ; 6F                    ' 80
2218   1135                         wait35                      ; sync                  ' 35    |
2218   1135 18 00       >            JR      .go
2218   1137 ED 4F       >            LD      R, A
2218   1139 F6 00       >            OR      $0
2218   113B F6 00       >            OR      $0
2219   113D 26 01                   LD      H, (YM_RR_SAV >> 8) ; H point on YM save H  ' 7     | 42 (122)
2220   113F             
2221   113F             state_wF                                ;                       ' 122
2222   113F 1A                      LD      A, (DE)             ; A = state register    ' 7     |
2223   1140 1C                      INC     E                   ; next data             ' 4     |
2224   1141 6F                      LD      L, A                ; HL point on save      ' 4     | 33 (155)
2225   1142 1A                      LD      A, (DE)             ; A = state value       ' 7     |
2226   1143 1C                      INC     E                   ; next data             ' 4     |
2227   1144 77                      LD      (HL), A             ; write to save         ' 7     |
2228   1145             
2229   1145             state_wE
2230   1145 1A                      LD      A, (DE)             ; A = state register    ' 7     |
2231   1146 1C                      INC     E                   ; next data             ' 4     |
2232   1147 6F                      LD      L, A                ; HL point on save      ' 4     | 33 (188)
2233   1148 1A                      LD      A, (DE)             ; A = state value       ' 7     |
2234   1149 1C                      INC     E                   ; next data             ' 4     |
2235   114A 77                      LD      (HL), A             ; write to save         ' 7     |
2236   114B             
2237   114B             state_wD
2238   114B 1A                      LD      A, (DE)             ; A = state register    ' 7     |
2239   114C 1C                      INC     E                   ; next data             ' 4     |
2240   114D 6F                      LD      L, A                ; HL point on save      ' 4     | 33 (221)
2241   114E 1A                      LD      A, (DE)             ; A = state value       ' 7     |
2242   114F 1C                      INC     E                   ; next data             ' 4     |
2243   1150 77                      LD      (HL), A             ; write to save         ' 7     |
2244   1151             
2245   1151             state_wC
2246   1151 1A                      LD      A, (DE)             ; A = state register    ' 7     |
2247   1152 1C                      INC     E                   ; next data             ' 4     |
2248   1153 6F                      LD      L, A                ; HL point on save      ' 4     | 33 (254)
2249   1154 1A                      LD      A, (DE)             ; A = state value       ' 7     |
2250   1155 1C                      INC     E                   ; next data             ' 4     |
2251   1156 77                      LD      (HL), A             ; write to save         ' 7     |
2252   1157             
2253   1157             state_wB
2254   1157                         sampleOutput                ; sample output         ' 36    |
2254   1157 D9          >            EXX                     ;                           ' 4     | 4
2254   1158 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
2254   1159 03          >            INC     BC              ; increment read address    ' 6     |
2254   115A CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
2254   115C 12          >            LD      (DE), A         ; play sample               ' 7     |
2254   115D D9          >            EXX                     ;                           ' 4     | (36)
2255   115E                         wait20                      ; wait                  ' 20    | (56)
2255   115E F6 00       >            OR      $0
2255   1160 00          >            NOP
2255   1161 ED 4F       >            LD      R, A
2256   1163             
2257   1163 1A                      LD      A, (DE)             ; A = state register    ' 7     |
2258   1164 1C                      INC     E                   ; next data             ' 4     |
2259   1165 6F                      LD      L, A                ; HL point on save      ' 4     | 33 (89)
2260   1166 1A                      LD      A, (DE)             ; A = state value       ' 7     |
2261   1167 1C                      INC     E                   ; next data             ' 4     |
2262   1168 77                      LD      (HL), A             ; write to save         ' 7     |
2263   1169             
2264   1169             state_wA
2265   1169 1A                      LD      A, (DE)             ; A = state register    ' 7     |
2266   116A 1C                      INC     E                   ; next data             ' 4     |
2267   116B 6F                      LD      L, A                ; HL point on save      ' 4     | 33 (122)
2268   116C 1A                      LD      A, (DE)             ; A = state value       ' 7     |
2269   116D 1C                      INC     E                   ; next data             ' 4     |
2270   116E 77                      LD      (HL), A             ; write to save         ' 7     |
2271   116F             
2272   116F             state_w9
2273   116F 1A                      LD      A, (DE)             ; A = state register    ' 7     |
2274   1170 1C                      INC     E                   ; next data             ' 4     |
2275   1171 6F                      LD      L, A                ; HL point on save      ' 4     | 33 (155)
2276   1172 1A                      LD      A, (DE)             ; A = state value       ' 7     |
2277   1173 1C                      INC     E                   ; next data             ' 4     |
2278   1174 77                      LD      (HL), A             ; write to save         ' 7     |
2279   1175             
2280   1175             state_w8
2281   1175 1A                      LD      A, (DE)             ; A = state register    ' 7     |
2282   1176 1C                      INC     E                   ; next data             ' 4     |
2283   1177 6F                      LD      L, A                ; HL point on save      ' 4     | 33 (188)
2284   1178 1A                      LD      A, (DE)             ; A = state value       ' 7     |
2285   1179 1C                      INC     E                   ; next data             ' 4     |
2286   117A 77                      LD      (HL), A             ; write to save         ' 7     |
2287   117B             
2288   117B             state_w7
2289   117B 1A                      LD      A, (DE)             ; A = state register    ' 7     |
2290   117C 1C                      INC     E                   ; next data             ' 4     |
2291   117D 6F                      LD      L, A                ; HL point on save      ' 4     | 33 (221)
2292   117E 1A                      LD      A, (DE)             ; A = state value       ' 7     |
2293   117F 1C                      INC     E                   ; next data             ' 4     |
2294   1180 77                      LD      (HL), A             ; write to save         ' 7     |
2295   1181             
2296   1181             state_w6
2297   1181 1A                      LD      A, (DE)             ; A = state register    ' 7     |
2298   1182 1C                      INC     E                   ; next data             ' 4     |
2299   1183 6F                      LD      L, A                ; HL point on save      ' 4     | 33 (254)
2300   1184 1A                      LD      A, (DE)             ; A = state value       ' 7     |
2301   1185 1C                      INC     E                   ; next data             ' 4     |
2302   1186 77                      LD      (HL), A             ; write to save         ' 7     |
2303   1187             
2304   1187             state_w5
2305   1187                         sampleOutput                ; sample output         ' 36    |
2305   1187 D9          >            EXX                     ;                           ' 4     | 4
2305   1188 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
2305   1189 03          >            INC     BC              ; increment read address    ' 6     |
2305   118A CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
2305   118C 12          >            LD      (DE), A         ; play sample               ' 7     |
2305   118D D9          >            EXX                     ;                           ' 4     | (36)
2306   118E                         wait10                      ; wait                  ' 10    | (46)
2306   118E C3 91 11    >            JP      .go
2307   1191             
2308   1191 1A                      LD      A, (DE)             ; A = state register    ' 7     |
2309   1192 1C                      INC     E                   ; next data             ' 4     |
2310   1193 6F                      LD      L, A                ; HL point on save      ' 4     | 33 (79)
2311   1194 1A                      LD      A, (DE)             ; A = state value       ' 7     |
2312   1195 1C                      INC     E                   ; next data             ' 4     |
2313   1196 77                      LD      (HL), A             ; write to save         ' 7     |
2314   1197             
2315   1197             state_w4
2316   1197 1A                      LD      A, (DE)             ; A = state register    ' 7     |
2317   1198 1C                      INC     E                   ; next data             ' 4     |
2318   1199 6F                      LD      L, A                ; HL point on save      ' 4     | 33 (112)
2319   119A 1A                      LD      A, (DE)             ; A = state value       ' 7     |
2320   119B 1C                      INC     E                   ; next data             ' 4     |
2321   119C 77                      LD      (HL), A             ; write to save         ' 7     |
2322   119D             
2323   119D             state_w3
2324   119D 1A                      LD      A, (DE)             ; A = state register    ' 7     |
2325   119E 1C                      INC     E                   ; next data             ' 4     |
2326   119F 6F                      LD      L, A                ; HL point on save      ' 4     | 33 (145)
2327   11A0 1A                      LD      A, (DE)             ; A = state value       ' 7     |
2328   11A1 1C                      INC     E                   ; next data             ' 4     |
2329   11A2 77                      LD      (HL), A             ; write to save         ' 7     |
2330   11A3             
2331   11A3             state_w2
2332   11A3 1A                      LD      A, (DE)             ; A = state register    ' 7     |
2333   11A4 1C                      INC     E                   ; next data             ' 4     |
2334   11A5 6F                      LD      L, A                ; HL point on save      ' 4     | 33 (178)
2335   11A6 1A                      LD      A, (DE)             ; A = state value       ' 7     |
2336   11A7 1C                      INC     E                   ; next data             ' 4     |
2337   11A8 77                      LD      (HL), A             ; write to save         ' 7     |
2338   11A9             
2339   11A9             state_w1
2340   11A9 1A                      LD      A, (DE)             ; A = state register    ' 7     |
2341   11AA 1C                      INC     E                   ; next data             ' 4     |
2342   11AB 6F                      LD      L, A                ; HL point on save      ' 4     | 33 (211)
2343   11AC 1A                      LD      A, (DE)             ; A = state value       ' 7     |
2344   11AD 1C                      INC     E                   ; next data             ' 4     |
2345   11AE 77                      LD      (HL), A             ; write to save         ' 7     |
2346   11AF             
2347   11AF             state_w0
2348   11AF 1A                      LD      A, (DE)             ; A = state register    ' 7     |
2349   11B0 1C                      INC     E                   ; next data             ' 4     |
2350   11B1 6F                      LD      L, A                ; HL point on save      ' 4     | 33 (244)
2351   11B2 1A                      LD      A, (DE)             ; A = state value       ' 7     |
2352   11B3 1C                      INC     E                   ; next data             ' 4     |
2353   11B4 77                      LD      (HL), A             ; write to save         ' 7     |
2354   11B5             
2355   11B5 C3 3C 0A                JP      execute_xgm         ;                       ' 10    | (254)
2356   11B8             
2357   11B8             
2358   11B8             ; NULL command
2359   11B8             ; ------------
2360   11B8             
2361   11B8             com_null                                ; 01-0F / 60-7C         ' 80
2362   11B8                         wait164                     ; sync                  ' 164   |
2362   11B8 3E 09       >            LD      A, w            ; 7-2
2362   11BA 3D          >            DEC     A               ; 4
2362   11BB 20 FD       >            JR      NZ, .loop       ; 12
2362   11BD ED 4F       >            LD      R, A
2362   11BF ED 4F       >            LD      R, A
2363   11C1 C3 3C 0A                JP      execute_xgm         ;                       ' 10    | 174 (254)
2364   11C4             
2365   11C4             
2366   11C4             ; EXTRA FRAME command
2367   11C4             ; -------------------
2368   11C4             
2369   11C4             com_extra_frm                           ; 7D                            ' 80
2370   11C4             
2371   11C4 3E 01                   LD      A, $1               ;                               ' 7     |
2372   11C6 32 12 01                LD      (MODIFYING_F), A    ; we are modifying variable     ' 13    | 20 (100)
2373   11C9             
2374   11C9 3A 13 01                LD      A, (PENDING_FRM)    ;                               ' 13    |
2375   11CC 3C                      INC     A                   ; force process 1 more frame    ' 4     | 30 (130)
2376   11CD 32 13 01                LD      (PENDING_FRM), A    ;                               ' 13    |
2377   11D0             
2378   11D0 AF                      XOR     A                   ;                               ' 4     |
2379   11D1 32 12 01                LD      (MODIFYING_F), A    ; no more modifying variable    ' 13    | 17 (147)
2380   11D4             
2381   11D4 21 94 01                LD      HL, ELAPSED         ;                               ' 10    | 10 (157)
2382   11D7             
2383   11D7 7E                      LD      A, (HL)             ;                               ' 7     |
2384   11D8 D6 01                   SUB     A, #1               ;                               ' 7     |
2385   11DA 77                      LD      (HL), A             ;                               ' 7     |
2386   11DB 2C                      INC     L                   ;                               ' 4     |
2387   11DC 7E                      LD      A, (HL)             ;                               ' 7     |
2388   11DD DE 00                   SBC     A, #0               ; fix elapsed frame (24 bit)    ' 7     | 71 (228)
2389   11DF 77                      LD      (HL), A             ;                               ' 7     |
2390   11E0 2C                      INC     L                   ;                               ' 4     |
2391   11E1 7E                      LD      A, (HL)             ;                               ' 7     |
2392   11E2 DE 00                   SBC     A, #0               ;                               ' 7     |
2393   11E4 77                      LD      (HL), A             ;                               ' 7     |
2394   11E5             
2395   11E5                         wait16                      ; sync                          ' 16    | 26 (254)
2395   11E5 18 00       >            JR      .go
2395   11E7 00          >            NOP
2396   11E8 C3 3C 0A                JP      execute_xgm         ;                               ' 10    |
2397   11EB             
2398   11EB             
2399   11EB             ; LOOP command
2400   11EB             ; ------------
2401   11EB             
2402   11EB             com_loop                                ; 7E                        ' 80
2403   11EB             
2404   11EB 3A 3C 01                LD      A, (REM_LOOP)       ; A = remaining loop        ' 13    |
2405   11EE 3D                      DEC     A                   ; 0 mean infinite loop      ' 4     |
2406   11EF 32 3C 01                LD      (REM_LOOP), A       ; A = remaining loop        ' 13    | 40 (120)
2407   11F2 C2 0C 12                JP      NZ, .continue       ;                           ' 10    |
2408   11F5             
2409   11F5 21 00 01                LD      HL, COMMAND         ; HL = COMMAND              ' 10    | 25 (145)
2410   11F8 CB E6                   SET     XGM_PAUSE_SFT, (HL) ; request pause/end XGM     ' 15    |
2411   11FA             
2412   11FA 21 02 01                LD      HL, STATUS          ; HL = STATUS               ' 10    | 25 (170)
2413   11FD CB B6                   RES     XGM_PLAY_SFT, (HL)  ; clear play status         ' 15    |
2414   11FF             
2415   11FF 1C                      INC     E                   ; next param                ' 4     |
2416   1200 1C                      INC     E                   ;                           ' 4     | 12 (182)
2417   1201 1C                      INC     E                   ;                           ' 4     |
2418   1202             
2419   1202                         wait62                      ; sync                      ' 62    |
2419   1202 3E 03       >            LD      A, w            ; 7-2
2419   1204 3D          >            DEC     A               ; 4
2419   1205 20 FD       >            JR      NZ, .loop       ; 12
2419   1207 18 00       >            JR      .go
2420   1209 C3 3C 0A                JP      execute_xgm         ;                           ' 10    | 72 (254)
2421   120C             
2422   120C             .continue
2423   120C 1A                      LD      A, (DE)             ; A = loop addr b7-b0       ' 7     |
2424   120D 6F                      LD      L, A                ; L = loop addr b7-b0       ' 4     |
2425   120E 1C                      INC     E                   ; next param                ' 4     |
2426   120F 1A                      LD      A, (DE)             ; A = loop addr b15-b8      ' 7     | 30 (150)
2427   1210 67                      LD      H, A                ; HL = loop addr b15-b0     ' 4     |
2428   1211 1C                      INC     E                   ; next param                ' 4     |
2429   1212             
2430   1212 ED 4B 04 01             LD      BC, (XGM_ARG_A+0)   ; BC = XGM base addr (ML)   ' 20    |
2431   1216 09                      ADD     HL, BC              ; HL = XGM base addr + loop ' 11    | 47 (197)
2432   1217 22 34 01                LD      (XGM_ADDR+0), HL    ; set new XGM addr (ML)     ' 16    |
2433   121A             
2434   121A 1A                      LD      A, (DE)             ; A = loop addr b23-b16     ' 7     |
2435   121B 21 06 01                LD      HL, XGM_ARG_A+2     ; HL point XGM base adr H   ' 10    |
2436   121E 8E                      ADC     (HL)                ; A = XGM base addr + loop  ' 7     | 41 (238)
2437   121F 1C                      INC     E                   ; next param                ' 4     |
2438   1220 32 36 01                LD      (XGM_ADDR+2), A     ; set new XGM addr (H)      ' 13    |
2439   1223             
2440   1223 AF                      XOR     A                   ; force end frame fter loop ' 4     |
2441   1224 12                      LD      (DE), A             ; after loop taken          ' 7     | 11 (249)
2442   1225             
2443   1225 C3 3C 0A                JP      execute_xgm         ; +5 cycles delay here..    ' 10    | (254+5)
2444   1228             
2445   1228             
2446   1228             ; END XGM command
2447   1228             ; ---------------
2448   1228             
2449   1228             com_end                                 ; 7F                        ' 80
2450   1228 21 00 01                LD      HL, COMMAND         ; HL = COMMAND              ' 10    | 25 (105)
2451   122B CB E6                   SET     XGM_PAUSE_SFT, (HL) ; request pause/end XGM     ' 15    |
2452   122D             
2453   122D 21 02 01                LD      HL, STATUS          ; HL = STATUS               ' 10    | 25 (130)
2454   1230 CB B6                   RES     XGM_PLAY_SFT, (HL)  ; clear play status         ' 15    |
2455   1232             
2456   1232                         wait114                     ; sync                      ' 114   |
2456   1232 3E 07       >            LD      A, w            ; 7-2
2456   1234 3D          >            DEC     A               ; 4
2456   1235 20 FD       >            JR      NZ, .loop       ; 12
2457   1237 C3 3C 0A                JP      execute_xgm         ;                           ' 10    | 124 (254)
2458   123A             
2459   123A             
2460   123A             ; $BC+X+Y+Z
2461   123A             do_xgm_again                            ;                           ' 135
2462   123A 2D                      DEC     L                   ; HL point on MODIFYING_F   ' 4     |
2463   123B 36 00                   LD      (HL), $0            ; no more modifying         ' 10    | 14 (149)
2464   123D             
2465   123D                         wait95                      ; sync                      ' 95    |
2465   123D 3E 05       >            LD      A, w            ; 7-2
2465   123F 3D          >            DEC     A               ; 4
2465   1240 20 FD       >            JR      NZ, .loop       ; 12
2465   1242 ED 4F       >            LD      R, A
2465   1244 00          >            NOP
2466   1245 C3 AF 02                JP      main_loop           ; restart loop (prep xgm)   ' 10    | 105 (254)
2467   1248             
2468   1248             
2469   1248             
2470   1248             xgm_stopped
2471   1248 36 00                   LD      (HL), $0            ; clear PENDING_FRM         ' xx
2472   124A C3 5A 12                JP      xgm_stopped_cont    ; continue                  ' xx
2473   124D             
2474   124D             
2475   124D             ; $BC+X+Y+Z
2476   124D             xgm_done                                ;                               ' 90
2477   124D             
2478   124D             ;    LD  A, (VCOUNTER)
2479   124D             ;    LD  (DEBUG_8), A
2480   124D             
2481   124D 21 12 01                LD      HL, MODIFYING_F     ;                               ' 10    |
2482   1250 36 01                   LD      (HL), $1            ; we are modifying variable     ' 10    | 24 (114)
2483   1252 2C                      INC     L                   ; HL point on PENDING_FRM       ' 4     |
2484   1253             
2485   1253 35                      DEC     (HL)                ; still have frame to process ? ' 11    |
2486   1254 FA 48 12                JP      M, xgm_stopped      ; for safety on 68k clear       ' xx
2487   1257 C2 3A 12                JP      NZ, do_xgm_again    ; do XGM process again          ' 10    | 21 (135)
2488   125A             
2489   125A             xgm_stopped_cont
2490   125A 2D                      DEC     L                   ; HL point on MODIFYING_F       ' 4     |
2491   125B 36 00                   LD      (HL), $0            ; no more modifying variable    ' 10    | 14 (149)
2492   125D             
2493   125D             
2494   125D             ;    LD  A, (VCOUNTER)
2495   125D             ;    LD  (DEBUG_9), A
2496   125D             
2497   125D             ; execute external command
2498   125D             ; ------------------------
2499   125D             
2500   125D             ; $BC+X+Y+Z
2501   125D             external_com                            ;                           ' 149
2502   125D 31 00 16                LD      SP, STACK           ; restore stack             ' 10    |
2503   1260 21 00 01                LD      HL, COMMAND         ; HL point on COMMAND       ' 10    | 20 (159)
2504   1263             
2505   1263             .chk_xgm_play
2506   1263 CB 76                   BIT     XGM_PLAY_SFT, (HL)  ; play XGM command ?        ' 12    |
2507   1265 CA 90 12                JP      Z, .chk_xgm_resume  ;                           ' 10    | 22 (181)
2508   1268             
2509   1268 CB B6                   RES     XGM_PLAY_SFT, (HL)  ; clear command             ' 15    |
2510   126A 2C                      INC     L                   ;                           ' 4     |
2511   126B 2C                      INC     L                   ; HL point on status        ' 4     | 38 (219)
2512   126C CB F6                   SET     XGM_PLAY_SFT, (HL)  ; set play status           ' 15    |
2513   126E             
2514   126E 2A 04 01                LD      HL, (XGM_ARG_A)     ; set new XGM address       ' 16    |
2515   1271 22 34 01                LD      (XGM_ADDR), HL      ;                           ' 16    | 58 (277)
2516   1274 3A 06 01                LD      A, (XGM_ARG_A+2)    ;                           ' 13    |
2517   1277 32 36 01                LD      (XGM_ADDR+2),A      ;                           ' 13    |
2518   127A             
2519   127A 3A 10 01                LD      A, (LOOP_ARG)       ; set remaining loop        ' 13    |
2520   127D 32 3C 01                LD      (REM_LOOP),A        ;                           ' 13    | 26 (303)
2521   1280             
2522   1280 21 00 00                LD      HL, #0000           ; clear elapsed frame       ' 10    |
2523   1283 22 94 01                LD      (ELAPSED), HL       ; (24 bit counter)          ' 16    |
2524   1286 AF                      XOR     A                   ;                           ' 4     | 43 (346)
2525   1287 32 96 01                LD      (ELAPSED+2), A      ;                           ' 13    |
2526   128A             
2527   128A 21 00 01                LD      HL, COMMAND         ; restore HL                ' 10    |
2528   128D C3 22 13                JP      external_com_pcm    ; do PCM commands           ' 10    | 20 (254+112)
2529   1290                                                     ; +112 cycles here, ignore
2530   1290             
2531   1290             .chk_xgm_resume
2532   1290 CB 6E                   BIT     XGM_RESUME_SFT, (HL)    ; play XGM command ?    ' 12    |
2533   1292 CA B1 12                JP      Z, .chk_xgm_stop        ;                       ' 10    | 22 (203)
2534   1295             
2535   1295 CB AE                   RES     XGM_RESUME_SFT, (HL)    ; clear command         ' 15    |
2536   1297 2C                      INC     L                       ;                       ' 4     |
2537   1298 2C                      INC     L                       ; HL point on status    ' 4     | 38 (241)
2538   1299 CB F6                   SET     XGM_PLAY_SFT, (HL)      ; set play status       ' 15    |
2539   129B             
2540   129B 11 44 01                LD      DE, YM_RR_SAV       ; DE point on save state    ' 10    |
2541   129E 31 00 16                LD      SP, STACK           ; set STACK                 ' 10    | 20 (254+7)
2542   12A1                                                     ; +7 cycles here, ignore
2543   12A1             
2544   12A1 CD F7 14                CALL    loadState           ; load state                ' 140+  | (140)
2545   12A4             
2546   12A4                         wait94                      ; sync                      ' 94    |
2546   12A4 3E 05       >            LD      A, w            ; 7-2
2546   12A6 3D          >            DEC     A               ; 4
2546   12A7 20 FD       >            JR      NZ, .loop       ; 12
2546   12A9 18 00       >            JR      .go
2547   12AB 21 00 01                LD      HL, COMMAND         ; restore HL                ' 10    | 114 (254)
2548   12AE C3 22 13                JP      external_com_pcm    ; do PCM commands           ' 10    |
2549   12B1             
2550   12B1             .chk_xgm_stop
2551   12B1 CB 66                   BIT     XGM_PAUSE_SFT, (HL) ; pause/end XGM command ?   ' 12    |
2552   12B3 CA 1B 13                JP      Z, .chk_pcm0_pre    ;                           ' 10    | 22 (225)
2553   12B6             
2554   12B6 CB A6                   RES     XGM_PAUSE_SFT, (HL) ; clear command             ' 15    |
2555   12B8 2C                      INC     L                   ;                           ' 4     |
2556   12B9 2C                      INC     L                   ; HL point on status        ' 4     | 38 (263)
2557   12BA CB B6                   RES     XGM_PLAY_SFT, (HL)  ; clear play status         ' 15    |
2558   12BC             
2559   12BC 11 64 01                LD      DE, YM_RR_OFF       ; DE point on off state     ' 10    |
2560   12BF 31 00 16                LD      SP, STACK           ; set STACK                 ' 10    | 20 (254+29)
2561   12C2                                                     ; +29 cycles here, ignore
2562   12C2             
2563   12C2 CD F7 14                CALL    loadState           ; stop music                ' 140+  | (140)
2564   12C5             
2565   12C5 21 00 40                LD      HL, YMPORT0         ; HL point on YM port0      ' 10    |
2566   12C8 01 01 40                LD      BC, YMPORT1         ; BC point on YM port1      ' 10    | 20 (160)
2567   12CB             
2568   12CB 36 28                   LD      (HL), $28           ; set reg num to YM         ' 10    |
2569   12CD                         waitYMReadyFast             ; wait YM to be ready       ' 22    | 32 (192)
2569   12CD CB 7E       >            BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
2569   12CF C2 CD 12    >            JP      NZ, .wait       ; wait while busy           ' 10    |
2570   12D2             
2571   12D2 AF                      XOR     A                   ; A = $00                   ' 4     |
2572   12D3 02                      LD      (BC), A             ; key off - all channel     ' 7     |
2573   12D4 3C                      INC     A                   ; A = $01                   ' 4     | 37 (229)
2574   12D5                         waitYMReadyFast             ; wait YM to be ready       ' 22    |
2574   12D5 CB 7E       >            BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
2574   12D7 C2 D5 12    >            JP      NZ, .wait       ; wait while busy           ' 10    |
2575   12DA             
2576   12DA 02                      LD      (BC), A             ; key off - all channel     ' 7     |
2577   12DB                         waitYMReadyFast             ; wait YM to be ready       ' 22    | 29 (254+4)
2577   12DB CB 7E       >            BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
2577   12DD C2 DB 12    >            JP      NZ, .wait       ; wait while busy           ' 10    |
2578   12E0             
2579   12E0                         sampleOutputSafe            ; *** sample output ****    ' 46    | (46+4)
2579   12E0 D9          >            EXX                     ;                           ' 4     | 4
2579   12E1 36 2A       >            LD      (HL), $2A       ; prepare DAC write         ' 10    |
2579   12E3 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
2579   12E4 03          >            INC     BC              ; increment read address    ' 6     | 38 (42)
2579   12E5 CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     |
2579   12E7 12          >            LD      (DE), A         ; play sample               ' 7     |
2579   12E8 D9          >            EXX                     ;                           ' 4     | (46)
2580   12E9             
2581   12E9                         waitYMReadyFast             ; wait YM to be ready       ' 22    |
2581   12E9 CB 7E       >            BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
2581   12EB C2 E9 12    >            JP      NZ, .wait       ; wait while busy           ' 10    |
2582   12EE 36 28                   LD      (HL), $28           ; set reg num to YM         ' 10    |
2583   12F0 3E 02                   LD      A, $02              ; A = $02                   ' 7     | 61 (111)
2584   12F2                         waitYMReadyFast             ; wait YM to be ready       ' 22    |
2584   12F2 CB 7E       >            BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
2584   12F4 C2 F2 12    >            JP      NZ, .wait       ; wait while busy           ' 10    |
2585   12F7             
2586   12F7 02                      LD      (BC), A             ; key off - all channel     ' 7     |
2587   12F8 C6 02                   ADD     $2                  ; A = $04                   ' 7     | 36 (147)
2588   12FA                         waitYMReadyFast             ; wait YM to be ready       ' 22    |
2588   12FA CB 7E       >            BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
2588   12FC C2 FA 12    >            JP      NZ, .wait       ; wait while busy           ' 10    |
2589   12FF             
2590   12FF 02                      LD      (BC), A             ; key off - all channel     ' 7     |
2591   1300 3C                      INC     A                   ; A = $05                   ' 4     | 33 (180)
2592   1301                         waitYMReadyFast             ; wait YM to be ready       ' 22    |
2592   1301 CB 7E       >            BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
2592   1303 C2 01 13    >            JP      NZ, .wait       ; wait while busy           ' 10    |
2593   1306             
2594   1306 02                      LD      (BC), A             ; key off - all channel     ' 7     |
2595   1307 3C                      INC     A                   ; A = $06                   ' 4     | 33 (213)
2596   1308                         waitYMReadyFast             ; wait YM to be ready       ' 22    |
2596   1308 CB 7E       >            BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
2596   130A C2 08 13    >            JP      NZ, .wait       ; wait while busy           ' 10    |
2597   130D             
2598   130D 02                      LD      (BC), A             ; key off - all channel     ' 7     |
2599   130E                         waitYMReadyFast             ; wait YM to be ready       ' 22    | 39 (252)
2599   130E CB 7E       >            BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
2599   1310 C2 0E 13    >            JP      NZ, .wait       ; wait while busy           ' 10    |
2600   1313 36 2A                   LD      (HL), $2A           ; restore DAC write         ' 10    |
2601   1315             
2602   1315 21 00 01                LD      HL, COMMAND         ; restore HL                ' 10    |
2603   1318 C3 22 13                JP      external_com_pcm    ; continue                  ' 10    | 20 (254+18)
2604   131B                                                     ; +18 cycles here, ignore
2605   131B             
2606   131B             .chk_pcm0_pre                           ;                           ' 225
2607   131B 21 00 01                LD      HL, COMMAND         ; restore HL                ' 10    |
2608   131E                         wait19                      ; sync                      ' 19    | 29 (254)
2608   131E 18 00       >            JR      .go
2608   1320 F6 00       >            OR      $0
2609   1322             
2610   1322             ; $BD+X+Y+Z
2611   1322             external_com_pcm
2612   1322                         sampleOutput                ; *** sample output ****    ' 36    | (36)
2612   1322 D9          >            EXX                     ;                           ' 4     | 4
2612   1323 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
2612   1324 03          >            INC     BC              ; increment read address    ' 6     |
2612   1325 CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
2612   1327 12          >            LD      (DE), A         ; play sample               ' 7     |
2612   1328 D9          >            EXX                     ;                           ' 4     | (36)
2613   1329             
2614   1329             .chk_pcm0
2615   1329 CB 46                   BIT     CH0_SFT, (HL)       ; play PCM0 command ?       ' 12    |
2616   132B CA 70 13                JP      Z, .chk_pcm1        ;                           ' 10    | 22 (58)
2617   132E             
2618   132E CB 86                   RES     CH0_SFT, (HL)       ; clear command             ' 15    | (73)
2619   1330             
2620   1330                         handlePCMCommand 0          ; handle play PCM command   ' 157   | 167 (240)
2620   1330 ED 4B 08 01 >            LD      BC, (PCM_ARG_P+(ch*2))  ; C = SFX prio, B = SFX id  ' 20    |
2620   1334 21 14 01    >            LD      HL, PCM_PRIO+(ch*8)     ; HL point on PCM info      ' 10    | (30)
2620   1337 79          >            LD      A, C                    ; A = new prio              ' 4     |
2620   1338 BE          >            CP      (HL)                    ; compare to old prio       ' 7     | 21 (51)
2620   1339 D2 48 13    >            JP      NC, .play_new           ; >= old prio --> play new  ' 10    |
2620   133C 3E 05       >            LD      A, w            ; 7-2
2620   133E 3D          >            DEC     A               ; 4
2620   133F 20 FD       >            JR      NZ, .loop       ; 12
2620   1341 F6 00       >            OR      $0
2620   1343 F6 00       >            OR      $0
2620   1345 C3 5D 13    >            JP      .end                    ;                           ' 10    | 106 (157)
2620   1348 78          >            LD      A, B                    ; A = SFX id                ' 4     |
2620   1349 B7          >            OR      A                       ; not a stop PCM command ?  ' 4     | 18 (69)
2620   134A 20 02       >            JR      NZ, .PCM_play           ; go set new prio           ' 7/12  |
2620   134C 0E 00       >            LD      C, 0                    ; reset prio for stop       ' 7     | +2
2620   134E 71          >            LD      (HL), C                 ; set new prio              ' 7     | (76)
2620   134F 26 07       >            LD      H, (ID_TABLE>>10)       ;                           ' 7     |
2620   1351 6F          >            LD      L, A                    ;                           ' 4     |
2620   1352 29          >            ADD     HL, HL                  ;                           ' 6     |
2620   1353 29          >            ADD     HL, HL                  ; HL point on new PCM addr  ' 6     | 29 (105)
2620   1354 F9          >            LD      SP, HL                  ; set SP to new PCM addr    ' 6     |
2620   1355 E1          >            POP     HL                      ; copy params               ' 10    |
2620   1356 22 16 01    >            LD      (PCM_ADDR+(ch*8)),HL    ;                           ' 16    |
2620   1359 E1          >            POP     HL                      ;                           ' 10    | 52 (157)
2620   135A 22 18 01    >            LD      (PCM_LEN+(ch*8)),HL     ;                           ' 16    |
2621   135D 21 00 01                LD      HL, COMMAND         ; restore HL                ' 10    |
2622   1360             
2623   1360                         wait14                      ; sync                      ' 14    | (254)
2623   1360 F6 00       >            OR      $0
2623   1362 F6 00       >            OR      $0
2624   1364             
2625   1364                         sampleOutput                ; *** sample output ****    ' 36    | (36)
2625   1364 D9          >            EXX                     ;                           ' 4     | 4
2625   1365 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
2625   1366 03          >            INC     BC              ; increment read address    ' 6     |
2625   1367 CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
2625   1369 12          >            LD      (DE), A         ; play sample               ' 7     |
2625   136A D9          >            EXX                     ;                           ' 4     | (36)
2626   136B             
2627   136B                         wait22                      ; sync                      ' 22    | (58)
2627   136B ED 4F       >            LD      R, A
2627   136D ED 4F       >            LD      R, A
2627   136F 00          >            NOP
2628   1370             
2629   1370             .chk_pcm1
2630   1370 CB 4E                   BIT     CH1_SFT, (HL)       ; play PCM1 command ?       ' 12    |
2631   1372 CA B6 13                JP      Z, .chk_pcm2        ;                           ' 10    | 22 (80)
2632   1375             
2633   1375 CB 8E                   RES     CH1_SFT, (HL)       ; clear command             ' 15    | (95)
2634   1377             
2635   1377                         handlePCMCommand 1          ; handle play PCM command   ' 157   | (254-2)
2635   1377 ED 4B 0A 01 >            LD      BC, (PCM_ARG_P+(ch*2))  ; C = SFX prio, B = SFX id  ' 20    |
2635   137B 21 1C 01    >            LD      HL, PCM_PRIO+(ch*8)     ; HL point on PCM info      ' 10    | (30)
2635   137E 79          >            LD      A, C                    ; A = new prio              ' 4     |
2635   137F BE          >            CP      (HL)                    ; compare to old prio       ' 7     | 21 (51)
2635   1380 D2 8F 13    >            JP      NC, .play_new           ; >= old prio --> play new  ' 10    |
2635   1383 3E 05       >            LD      A, w            ; 7-2
2635   1385 3D          >            DEC     A               ; 4
2635   1386 20 FD       >            JR      NZ, .loop       ; 12
2635   1388 F6 00       >            OR      $0
2635   138A F6 00       >            OR      $0
2635   138C C3 A4 13    >            JP      .end                    ;                           ' 10    | 106 (157)
2635   138F 78          >            LD      A, B                    ; A = SFX id                ' 4     |
2635   1390 B7          >            OR      A                       ; not a stop PCM command ?  ' 4     | 18 (69)
2635   1391 20 02       >            JR      NZ, .PCM_play           ; go set new prio           ' 7/12  |
2635   1393 0E 00       >            LD      C, 0                    ; reset prio for stop       ' 7     | +2
2635   1395 71          >            LD      (HL), C                 ; set new prio              ' 7     | (76)
2635   1396 26 07       >            LD      H, (ID_TABLE>>10)       ;                           ' 7     |
2635   1398 6F          >            LD      L, A                    ;                           ' 4     |
2635   1399 29          >            ADD     HL, HL                  ;                           ' 6     |
2635   139A 29          >            ADD     HL, HL                  ; HL point on new PCM addr  ' 6     | 29 (105)
2635   139B F9          >            LD      SP, HL                  ; set SP to new PCM addr    ' 6     |
2635   139C E1          >            POP     HL                      ; copy params               ' 10    |
2635   139D 22 1E 01    >            LD      (PCM_ADDR+(ch*8)),HL    ;                           ' 16    |
2635   13A0 E1          >            POP     HL                      ;                           ' 10    | 52 (157)
2635   13A1 22 20 01    >            LD      (PCM_LEN+(ch*8)),HL     ;                           ' 16    |
2636   13A4             
2637   13A4                         sampleOutput                ; *** sample output ****    ' 36    | (36-2)
2637   13A4 D9          >            EXX                     ;                           ' 4     | 4
2637   13A5 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
2637   13A6 03          >            INC     BC              ; increment read address    ' 6     |
2637   13A7 CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
2637   13A9 12          >            LD      (DE), A         ; play sample               ' 7     |
2637   13AA D9          >            EXX                     ;                           ' 4     | (36)
2638   13AB             
2639   13AB                         wait36                      ; sync                      ' 36    | 46 (80)
2639   13AB ED 4F       >            LD      R, A
2639   13AD ED 4F       >            LD      R, A
2639   13AF ED 4F       >            LD      R, A
2639   13B1 ED 4F       >            LD      R, A
2640   13B3 21 00 01                LD      HL, COMMAND         ; restore HL                ' 10    |
2641   13B6             
2642   13B6             .chk_pcm2
2643   13B6 CB 56                   BIT     CH2_SFT, (HL)       ; play PCM2 command ?       ' 12    |
2644   13B8 CA FC 13                JP      Z, .chk_pcm3        ;                           ' 10    | 22 (102)
2645   13BB             
2646   13BB CB 96                   RES     CH2_SFT, (HL)       ; clear command             ' 15    | (117)
2647   13BD             
2648   13BD                         handlePCMCommand 2          ; handle play PCM command   ' 157   | (254+20)
2648   13BD ED 4B 0C 01 >            LD      BC, (PCM_ARG_P+(ch*2))  ; C = SFX prio, B = SFX id  ' 20    |
2648   13C1 21 24 01    >            LD      HL, PCM_PRIO+(ch*8)     ; HL point on PCM info      ' 10    | (30)
2648   13C4 79          >            LD      A, C                    ; A = new prio              ' 4     |
2648   13C5 BE          >            CP      (HL)                    ; compare to old prio       ' 7     | 21 (51)
2648   13C6 D2 D5 13    >            JP      NC, .play_new           ; >= old prio --> play new  ' 10    |
2648   13C9 3E 05       >            LD      A, w            ; 7-2
2648   13CB 3D          >            DEC     A               ; 4
2648   13CC 20 FD       >            JR      NZ, .loop       ; 12
2648   13CE F6 00       >            OR      $0
2648   13D0 F6 00       >            OR      $0
2648   13D2 C3 EA 13    >            JP      .end                    ;                           ' 10    | 106 (157)
2648   13D5 78          >            LD      A, B                    ; A = SFX id                ' 4     |
2648   13D6 B7          >            OR      A                       ; not a stop PCM command ?  ' 4     | 18 (69)
2648   13D7 20 02       >            JR      NZ, .PCM_play           ; go set new prio           ' 7/12  |
2648   13D9 0E 00       >            LD      C, 0                    ; reset prio for stop       ' 7     | +2
2648   13DB 71          >            LD      (HL), C                 ; set new prio              ' 7     | (76)
2648   13DC 26 07       >            LD      H, (ID_TABLE>>10)       ;                           ' 7     |
2648   13DE 6F          >            LD      L, A                    ;                           ' 4     |
2648   13DF 29          >            ADD     HL, HL                  ;                           ' 6     |
2648   13E0 29          >            ADD     HL, HL                  ; HL point on new PCM addr  ' 6     | 29 (105)
2648   13E1 F9          >            LD      SP, HL                  ; set SP to new PCM addr    ' 6     |
2648   13E2 E1          >            POP     HL                      ; copy params               ' 10    |
2648   13E3 22 26 01    >            LD      (PCM_ADDR+(ch*8)),HL    ;                           ' 16    |
2648   13E6 E1          >            POP     HL                      ;                           ' 10    | 52 (157)
2648   13E7 22 28 01    >            LD      (PCM_LEN+(ch*8)),HL     ;                           ' 16    |
2649   13EA             
2650   13EA                         sampleOutput                ; *** sample output ****    ' 36    | (36+20)
2650   13EA D9          >            EXX                     ;                           ' 4     | 4
2650   13EB 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
2650   13EC 03          >            INC     BC              ; increment read address    ' 6     |
2650   13ED CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
2650   13EF 12          >            LD      (DE), A         ; play sample               ' 7     |
2650   13F0 D9          >            EXX                     ;                           ' 4     | (36)
2651   13F1             
2652   13F1                         wait36                      ; sync                      ' 36    | 46 (102)
2652   13F1 ED 4F       >            LD      R, A
2652   13F3 ED 4F       >            LD      R, A
2652   13F5 ED 4F       >            LD      R, A
2652   13F7 ED 4F       >            LD      R, A
2653   13F9 21 00 01                LD      HL, COMMAND         ; restore HL                ' 10    |
2654   13FC             
2655   13FC             .chk_pcm3
2656   13FC CB 5E                   BIT     CH3_SFT, (HL)       ; play PCM3 command ?       ' 12    |
2657   13FE CA 3E 14                JP      Z, ext_com_done     ;                           ' 10    | 22 (124)
2658   1401             
2659   1401 CB 9E                   RES     CH3_SFT, (HL)       ; clear command             ' 15    | (139)
2660   1403             
2661   1403                         handlePCMCommand 3          ; handle play PCM command   ' 157   | (254+42)
2661   1403 ED 4B 0E 01 >            LD      BC, (PCM_ARG_P+(ch*2))  ; C = SFX prio, B = SFX id  ' 20    |
2661   1407 21 2C 01    >            LD      HL, PCM_PRIO+(ch*8)     ; HL point on PCM info      ' 10    | (30)
2661   140A 79          >            LD      A, C                    ; A = new prio              ' 4     |
2661   140B BE          >            CP      (HL)                    ; compare to old prio       ' 7     | 21 (51)
2661   140C D2 1B 14    >            JP      NC, .play_new           ; >= old prio --> play new  ' 10    |
2661   140F 3E 05       >            LD      A, w            ; 7-2
2661   1411 3D          >            DEC     A               ; 4
2661   1412 20 FD       >            JR      NZ, .loop       ; 12
2661   1414 F6 00       >            OR      $0
2661   1416 F6 00       >            OR      $0
2661   1418 C3 30 14    >            JP      .end                    ;                           ' 10    | 106 (157)
2661   141B 78          >            LD      A, B                    ; A = SFX id                ' 4     |
2661   141C B7          >            OR      A                       ; not a stop PCM command ?  ' 4     | 18 (69)
2661   141D 20 02       >            JR      NZ, .PCM_play           ; go set new prio           ' 7/12  |
2661   141F 0E 00       >            LD      C, 0                    ; reset prio for stop       ' 7     | +2
2661   1421 71          >            LD      (HL), C                 ; set new prio              ' 7     | (76)
2661   1422 26 07       >            LD      H, (ID_TABLE>>10)       ;                           ' 7     |
2661   1424 6F          >            LD      L, A                    ;                           ' 4     |
2661   1425 29          >            ADD     HL, HL                  ;                           ' 6     |
2661   1426 29          >            ADD     HL, HL                  ; HL point on new PCM addr  ' 6     | 29 (105)
2661   1427 F9          >            LD      SP, HL                  ; set SP to new PCM addr    ' 6     |
2661   1428 E1          >            POP     HL                      ; copy params               ' 10    |
2661   1429 22 2E 01    >            LD      (PCM_ADDR+(ch*8)),HL    ;                           ' 16    |
2661   142C E1          >            POP     HL                      ;                           ' 10    | 52 (157)
2661   142D 22 30 01    >            LD      (PCM_LEN+(ch*8)),HL     ;                           ' 16    |
2662   1430             
2663   1430                         sampleOutput                ; *** sample output ****    ' 36    | (36+42)
2663   1430 D9          >            EXX                     ;                           ' 4     | 4
2663   1431 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
2663   1432 03          >            INC     BC              ; increment read address    ' 6     |
2663   1433 CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
2663   1435 12          >            LD      (DE), A         ; play sample               ' 7     |
2663   1436 D9          >            EXX                     ;                           ' 4     | (36)
2664   1437             
2665   1437                         wait46                      ; sync                      ' 46    | (124)
2665   1437 3E 02       >            LD      A, w            ; 7-2
2665   1439 3D          >            DEC     A               ; 4
2665   143A 20 FD       >            JR      NZ, .loop       ; 12
2665   143C 18 00       >            JR      .go
2666   143E             
2667   143E             ; $BD+X+Y+Z
2668   143E             ext_com_done                                ;                           ' 124
2669   143E 01 02 01                LD      BC, STATUS              ; BC point on STATUS        ' 10    |
2670   1441 0A                      LD      A, (BC)                 ; A = STATUS                ' 7     | 24 (148)
2671   1442 E6 F0                   AND     $F0                     ; clear PCM play status     ' 7     |
2672   1444             
2673   1444 2A 00 1C                LD      HL, (ID_TABLE+0)        ; HL = null PCM addr        ' 16    |
2674   1447 ED 5B 16 01             LD      DE, (PCM_ADDR+(0*8))    ; DE = PCM ch0 addr         ' 20    |
2675   144B ED 52                   SBC     HL, DE                  ; HL == DE ?                ' 15    | 63 (211)
2676   144D 28 02                   JR      Z, .ch0_silent          ; ch0 is not playing        ' 12    |
2677   144F             
2678   144F F6 01                   OR      A, $01                  ; set play status for ch0   ' +2
2679   1451             
2680   1451             .ch0_silent
2681   1451 08                      EX      AF, AF'                 ; preserve AF               ' 4     |
2682   1452                         wait35                          ; sync                      ' 35    | 39 (254-4)
2682   1452 18 00       >            JR      .go
2682   1454 ED 4F       >            LD      R, A
2682   1456 F6 00       >            OR      $0
2682   1458 F6 00       >            OR      $0
2683   145A             
2684   145A             ; $BE+X+Y+Z
2685   145A                         sampleOutput                    ; sample output             ' 36-4  | (36)
2685   145A D9          >            EXX                     ;                           ' 4     | 4
2685   145B 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
2685   145C 03          >            INC     BC              ; increment read address    ' 6     |
2685   145D CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
2685   145F 12          >            LD      (DE), A         ; play sample               ' 7     |
2685   1460 D9          >            EXX                     ;                           ' 4     | (36)
2686   1461 08                      EX      AF, AF'                 ; restore AF                ' 4     |
2687   1462             
2688   1462 2A 00 1C                LD      HL, (ID_TABLE+0)        ; HL = null PCM addr        ' 16    |
2689   1465 ED 5B 1E 01             LD      DE, (PCM_ADDR+(1*8))    ; DE = PCM ch1 addr         ' 20    |
2690   1469 ED 52                   SBC     HL, DE                  ; HL == DE ?                ' 15    | 63 (99)
2691   146B 28 02                   JR      Z, .ch1_silent          ; ch1 is not playing        ' 12    |
2692   146D             
2693   146D F6 02                   OR      A, $02                  ; set play status for ch1   ' +2
2694   146F             
2695   146F             .ch1_silent
2696   146F 2A 00 1C                LD      HL, (ID_TABLE+0)        ; HL = null PCM addr        ' 16    |
2697   1472 ED 5B 26 01             LD      DE, (PCM_ADDR+(2*8))    ; DE = PCM ch2 addr         ' 20    |
2698   1476 ED 52                   SBC     HL, DE                  ; HL == DE ?                ' 15    | 63 (162)
2699   1478 28 02                   JR      Z, .ch2_silent          ; ch2 is not playing        ' 12    |
2700   147A             
2701   147A F6 04                   OR      A, $04                  ; set play status for ch2   ' +2
2702   147C             
2703   147C             .ch2_silent
2704   147C 2A 00 1C                LD      HL, (ID_TABLE+0)        ; HL = null PCM addr        ' 16    |
2705   147F ED 5B 2E 01             LD      DE, (PCM_ADDR+(3*8))    ; DE = PCM ch3 addr         ' 20    |
2706   1483 ED 52                   SBC     HL, DE                  ; HL == DE ?                ' 15    | 63 (225)
2707   1485 28 02                   JR      Z, .ch3_silent          ; ch3 is not playing        ' 12    |
2708   1487             
2709   1487 F6 08                   OR      A, $08                  ; set play status for ch3   ' +2
2710   1489             
2711   1489             .ch3_silent
2712   1489 02                      LD      (BC), A                 ; set new status            ' 7     | (229)
2713   148A             
2714   148A 3A 11 01                LD      A, (PROTECT_ARG)        ; get BUS protect state     ' 13    |
2715   148D B7                      OR      A                       ; no protecting ?           ' 4     | 27 (254+2)
2716   148E CA AF 02                JP      Z, main_loop            ; process next frame        ' 10    |
2717   1491                                                         ; +2 cycles here, ignore...
2718   1491             
2719   1491             ; frame done
2720   1491             ;
2721   1491             ; 1 frame of PCM sample (256 bytes) is ~287 lines.
2722   1491             ;
2723   1491             ; NTSC: we should be <= 0xE8 to respect frame time here and we need to update PCM buffer 0.9 time per frame
2724   1491             ; so we have a free PCM mix frame from time to time.
2725   1491             ; Median (X+Y+Z) should be < 0x2A (< 42) plus some lines from the free PCM mix
2726   1491             ;
2727   1491             ; PAL: we should be <= 0118 to respect frame time here but we need to update PCM buffer 1.1 time per frame
2728   1491             ; so we have a penalty PCM mix frame from time to time.
2729   1491             ; Median (X+Y+Z) should be < 0x5A (< 90) minus some lines for the extra PCM mix
2730   1491             ; -------------------------------------------------------------------------------------
2731   1491             
2732   1491             
2733   1491             ;    LD  A, (VCOUNTER)
2734   1491             ;    LD  (DEBUG_A), A
2735   1491             
2736   1491             ; BUS protection wait (to avoid BUS contention with DMA)
2737   1491             ;
2738   1491             ; $BF+X+Y+Z
2739   1491             
2740   1491             bus_protect_wait
2741   1491                         sampleOutput                ; *** sample output *** ' 36    | (36)
2741   1491 D9          >            EXX                     ;                           ' 4     | 4
2741   1492 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
2741   1493 03          >            INC     BC              ; increment read address    ' 6     |
2741   1494 CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
2741   1496 12          >            LD      (DE), A         ; play sample               ' 7     |
2741   1497 D9          >            EXX                     ;                           ' 4     | (36)
2742   1498             
2743   1498                         wait105                     ; sync                  ' 105   | (141)
2743   1498 3E 06       >            LD      A, w            ; 7-2
2743   149A 3D          >            DEC     A               ; 4
2743   149B 20 FD       >            JR      NZ, .loop       ; 12
2743   149D F6 00       >            OR      $0
2744   149F             
2745   149F 3A 11 01                LD      A, (PROTECT_ARG)    ; get BUS protect state ' 13    |
2746   14A2 B7                      OR      A                   ; no more protecting ?  ' 4     | 27 (168)
2747   14A3 CA B7 14                JP      Z, .continue        ; continue              ' 10    |
2748   14A6             
2749   14A6 2A 80 01                LD      HL, (IDLE_LOOP)     ;                       ' 16    |
2750   14A9 23                      INC     HL                  ; increment idle loop   ' 6     | 38 (206)
2751   14AA 22 80 01                LD      (IDLE_LOOP), HL     ;                       ' 16    |
2752   14AD             
2753   14AD 2A 82 01                LD      HL, (WAIT_LOOP)     ;                       ' 16    |
2754   14B0 23                      INC     HL                  ; increment wait loop   ' 6     | 38 (244)
2755   14B1 22 82 01                LD      (WAIT_LOOP), HL     ;                       ' 16    |
2756   14B4             
2757   14B4 C3 91 14                JP      bus_protect_wait    ; wait until bus is ok  ' 10    | (254)
2758   14B7             
2759   14B7             .continue                               ;                       ' 168
2760   14B7             
2761   14B7             ;    LD  A, (VCOUNTER)
2762   14B7             ;    LD  (DEBUG_B), A
2763   14B7             
2764   14B7                         wait76                      ; sync                  ' 76    |
2764   14B7 3E 04       >            LD      A, w            ; 7-2
2764   14B9 3D          >            DEC     A               ; 4
2764   14BA 20 FD       >            JR      NZ, .loop       ; 12
2764   14BC C3 BF 14    >            JP      .go
2765   14BF C3 AF 02                JP      main_loop           ; process next frame    ' 10    | 86 (254)
2766   14C2             
2767   14C2             
2768   14C2             
2769   14C2             ; ##############################  functions  ################################
2770   14C2             
2771   14C2                         INCLUDE "z80_fct.i80"   ; basic functions
0001+  14C2             ; ########################### function #############################
0002+  14C2             
0003+  14C2             ; initDAC
0004+  14C2             ; -----------
0005+  14C2             ; HL <-  YMPORT0
0006+  14C2             ; DE <-  $2A80
0007+  14C2             ;
0008+  14C2             ; prepare DAC for output
0009+  14C2             
0010+  14C2             initDAC
0011+  14C2 11 80 2B                LD      DE, $2B80
0012+  14C5 CD CF 14                CALL    writeYM0        ; enable DAC
0013+  14C8 11 80 2A                LD      DE, $2A80
0014+  14CB CD CF 14                CALL    writeYM0        ; DAC data to silent
0015+  14CE C9                      RET
0016+  14CF             
0017+  14CF             ; writeYM0 / writeYM1
0018+  14CF             ; -------------------
0019+  14CF             ; D   -> address
0020+  14CF             ; E   -> value
0021+  14CF             ; HL <-  YMPORT0 / YMPORT2
0022+  14CF             ;
0023+  14CF             ; write to YM2612 (safe)
0024+  14CF             ; 81 cycles
0025+  14CF             
0026+  14CF             writeYM0                            ;                           ' 17
0027+  14CF 21 00 40                LD      HL, YMPORT0     ; HL = YM port 0            ' 10    | (27)
0028+  14D2             
0029+  14D2             .wait
0030+  14D2 CB 7E                   BIT     7, (HL)         ; test YM not busy          ' 12    |
0031+  14D4 20 FC                   JR      NZ, .wait       ;                           ' 7     | 19 (46)
0032+  14D6             
0033+  14D6 2E 00                   LD      L, $0           ; HL = YM port 0            ' 7     |
0034+  14D8 72                      LD      (HL), D         ; write address             ' 7     |
0035+  14D9 2C                      INC     L               ; next port                 ' 4     | 25 (71)
0036+  14DA 73                      LD      (HL), E         ; write value               ' 7     |
0037+  14DB             
0038+  14DB C9                      RET                     ; end                       ' 10    | (81)
0039+  14DC             
0040+  14DC             
0041+  14DC             writeYM1                            ;                           ' 17
0042+  14DC 21 00 40                LD      HL, YMPORT0     ; HL = YM port 0            ' 10    | (27)
0043+  14DF             
0044+  14DF             .wait
0045+  14DF CB 7E                   BIT     7, (HL)         ; test YM not busy          ' 12    |
0046+  14E1 20 FC                   JR      NZ, .wait       ;                           ' 7     | 19 (46)
0047+  14E3             
0048+  14E3 2E 02                   LD      L, $2           ; HL = YM port 2            ' 7     |
0049+  14E5 72                      LD      (HL), D         ; write address             ' 7     | 25 (71)
0050+  14E6 2C                      INC     L               ; HL = YM port 3            ' 4     |
0051+  14E7 73                      LD      (HL), E         ; write value               ' 7     |
0052+  14E8             
0053+  14E8 C9                      RET                     ; end                       ' 10    | (81)
0054+  14E9             
0055+  14E9             
0056+  14E9             ; writeYM0Fast / writeYM1Fast
0057+  14E9             ; ---------------------------
0058+  14E9             ; D   -> address
0059+  14E9             ; E   -> value
0060+  14E9             ; HL <-  YMPORT0 / YMPORT2
0061+  14E9             ;
0062+  14E9             ; write to YM2612
0063+  14E9             ; 55 cycles
0064+  14E9             
0065+  14E9             writeYM0Fast                        ;                           ' 17
0066+  14E9             
0067+  14E9 21 00 40                LD      HL, YMPORT0     ; HL = YM port 0            ' 10    |
0068+  14EC 72                      LD      (HL), D         ; write address             ' 7     |
0069+  14ED 2C                      INC     L               ; next port                 ' 4     | 28 (45)
0070+  14EE 73                      LD      (HL), E         ; write value               ' 7     |
0071+  14EF             
0072+  14EF C9                      RET                     ; end                       ' 10    | (55)
0073+  14F0             
0074+  14F0             
0075+  14F0             writeYM1Fast                        ;                           ' 17
0076+  14F0             
0077+  14F0 21 02 40                LD      HL, YMPORT2     ; HL = YM port 2            ' 10    |
0078+  14F3 72                      LD      (HL), D         ; write address             ' 7     |
0079+  14F4 2C                      INC     L               ; next port                 ' 4     | 28 (45)
0080+  14F5 73                      LD      (HL), E         ; write value               ' 7     |
0081+  14F6             
0082+  14F6 C9                      RET                     ; end                       ' 10    | (55)
0083+  14F7             
2772   14F7             
2773   14F7             
2774   14F7             ; loadState
2775   14F7             ; ---------
2776   14F7             ;     ?       ->  HL  -> ?
2777   14F7             ;     ?       ->  BC  -> ?
2778   14F7             ; reg source  ->  DE  -> ?
2779   14F7             ;
2780   14F7             ; load the YM and PSG state
2781   14F7             ; = 8 samples + 140 cycles
2782   14F7             
2783   14F7             loadState
2784   14F7             
2785   14F7                         sampleOutput                ; *** sample output ****    ' 36    | (36)
2785   14F7 D9          >            EXX                     ;                           ' 4     | 4
2785   14F8 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
2785   14F9 03          >            INC     BC              ; increment read address    ' 6     |
2785   14FA CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     | 28 (32)
2785   14FC 12          >            LD      (DE), A         ; play sample               ' 7     |
2785   14FD D9          >            EXX                     ;                           ' 4     | (36)
2786   14FE             
2787   14FE 21 00 40                LD      HL, YMPORT0         ; HL point on YM port0      ' 10    |
2788   1501 01 01 40                LD      BC, YMPORT1         ; BC point on YM port1      ' 10    | 20 (56)
2789   1504             
2790   1504 CD 28 15                CALL    loadYMState         ; load YM state             ' 188+  | (244)
2791   1507             
2792   1507 21 02 40                LD      HL, YMPORT2         ; HL point on YM port2      ' 10    |
2793   150A 01 03 40                LD      BC, YMPORT3         ; BC point on YM port3      ' 10    | 20 (254+10)
2794   150D             
2795   150D                         sampleOutputSafe            ; *** sample output ****    ' 46    | (46+10)
2795   150D D9          >            EXX                     ;                           ' 4     | 4
2795   150E 36 2A       >            LD      (HL), $2A       ; prepare DAC write         ' 10    |
2795   1510 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
2795   1511 03          >            INC     BC              ; increment read address    ' 6     | 38 (42)
2795   1512 CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     |
2795   1514 12          >            LD      (DE), A         ; play sample               ' 7     |
2795   1515 D9          >            EXX                     ;                           ' 4     | (46)
2796   1516             
2797   1516 CD 28 15                CALL    loadYMState         ; load YM state             ' 188+  | (244)
2798   1519             
2799   1519 21 11 7F                LD      HL, PSGPORT         ; HL point on PSG           ' 10    | (254)
2800   151C             
2801   151C                         sampleOutputSafe            ; *** sample output ****    ' 46    | (46+10)
2801   151C D9          >            EXX                     ;                           ' 4     | 4
2801   151D 36 2A       >            LD      (HL), $2A       ; prepare DAC write         ' 10    |
2801   151F 0A          >            LD      A, (BC)         ; read sample from buffer   ' 7     |
2801   1520 03          >            INC     BC              ; increment read address    ' 6     | 38 (42)
2801   1521 CB 90       >            RES     2, B            ; read_address &= 0x03FF    ' 8     |
2801   1523 12          >            LD      (DE), A         ; play sample               ' 7     |
2801   1524 D9          >            EXX                     ;                           ' 4     | (46)
2802   1525             
2803   1525 C3 ED 15                JP      loadPSGState        ; load PSG state            ' 10+94 | (140)
2804   1528             
2805   1528             
2806   1528             ; loadYMState
2807   1528             ; -----------
2808   1528             ; YMPORT0/2   ->  HL
2809   1528             ; YMPORT1/3   ->  BC
2810   1528             ; reg source  ->  DE  -> ?
2811   1528             ;
2812   1528             ; load the YM RR state
2813   1528             ; = 4 samples (244 cycles)
2814   1528             
2815   1528             loadYMState                             ;                           ' 56
2816   1528             
2817   1528                         waitYMReady                 ; wait YM to be ready       ' 30    |
2817   1528 D9          >            EXX                     ;                           ' 4     | (4)
2817   1529 CB 7E       >            BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
2817   152B C2 29 15    >            JP      NZ, .wait       ; wait while busy           ' 10    |
2817   152E D9          >            EXX                     ;                           ' 4     | (30)
2818   152F 36 80                   LD      (HL), $80           ; set reg num to YM         ' 10    |
2819   1531 1A                      LD      A, (DE)             ; get saved value           ' 7     |
2820   1532 1C                      INC     E                   ; next                      ' 4     | 62 (118)
2821   1533                         wait4                       ; wait YM to be ready       ' 4     |
2821   1533 00          >            NOP
2822   1534 02                      LD      (BC), A             ; restore state             ' 7     |
2823   1535             
2824   1535                         waitYMReady                 ; wait YM to be ready       ' 30    |
2824   1535 D9          >            EXX                     ;                           ' 4     | (4)
2824   1536 CB 7E       >            BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
2824   1538 C2 36 15    >            JP      NZ, .wait       ; wait while busy           ' 10    |
2824   153B D9          >            EXX                     ;                           ' 4     | (30)
2825   153C 36 81                   LD      (HL), $81           ; set reg num to YM         ' 10    |
2826   153E 1A                      LD      A, (DE)             ; get saved value           ' 7     | 62 (180)
2827   153F 1C                      INC     E                   ; next                      ' 4     |
2828   1540                         wait4                       ; wait YM to be ready       ' 4     |
2828   1540 00          >            NOP
2829   1541 02                      LD      (BC), A             ; restore state             ' 7     |
2830   1542             
2831   1542                         waitYMReady                 ; wait YM to be ready       ' 30    |
2831   1542 D9          >            EXX                     ;                           ' 4     | (4)
2831   1543 CB 7E       >            BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
2831   1545 C2 43 15    >            JP      NZ, .wait       ; wait while busy           ' 10    |
2831   1548 D9          >            EXX                     ;                           ' 4     | (30)
2832   1549 36 82                   LD      (HL), $82           ; set reg num to YM         ' 10    |
2833   154B 1A                      LD      A, (DE)             ; get saved value           ' 7     | 62 (242)
2834   154C 1C                      INC     E                   ; next                      ' 4     |
2835   154D                         wait4                       ; wait YM to be ready       ' 4     |
2835   154D 00          >            NOP
2836   154E 02                      LD      (BC), A             ; restore state             ' 7     |
2837   154F             
2838   154F D9                      EXX                         ;                           ' 4     | (246)
2839   1550             
2840   1550             .wait1
2841   1550 CB 7E                   BIT     7, (HL)             ; test YM ready bit         ' 12    |
2842   1552 C2 50 15                JP      NZ, .wait1          ; wait while busy           ' 10    | 22 (254+14)
2843   1555             
2844   1555 36 2A                   LD      (HL), $2A           ;                           ' 10    |
2845   1557 0A                      LD      A, (BC)             ;                           ' 7     |
2846   1558 03                      INC     BC                  ; *** sample output ****    ' 6     | 38 (52)
2847   1559 CB 90                   RES     2, B                ;                           ' 8     |
2848   155B 12                      LD      (DE), A             ;                           ' 7     |
2849   155C             
2850   155C             .wait2
2851   155C CB 7E                   BIT     7, (HL)             ; test YM ready bit         ' 12    |
2852   155E C2 5C 15                JP      NZ, .wait2          ; wait while busy           ' 10    | 22 (74)
2853   1561             
2854   1561 D9                      EXX                         ;                           ' 4     | (78)
2855   1562             
2856   1562 36 84                   LD      (HL), $84           ; set reg num to YM         ' 10    |
2857   1564 1A                      LD      A, (DE)             ; get saved value           ' 7     |
2858   1565 1C                      INC     E                   ; next                      ' 4     | 32 (110)
2859   1566                         wait4                       ; wait YM to be ready       ' 4     |
2859   1566 00          >            NOP
2860   1567 02                      LD      (BC), A             ; restore state             ' 7     |
2861   1568             
2862   1568                         waitYMReady                 ; wait YM to be ready       ' 30    |
2862   1568 D9          >            EXX                     ;                           ' 4     | (4)
2862   1569 CB 7E       >            BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
2862   156B C2 69 15    >            JP      NZ, .wait       ; wait while busy           ' 10    |
2862   156E D9          >            EXX                     ;                           ' 4     | (30)
2863   156F 36 85                   LD      (HL), $85           ; set reg num to YM         ' 10    |
2864   1571 1A                      LD      A, (DE)             ; get saved value           ' 7     | 62 (172)
2865   1572 1C                      INC     E                   ; next                      ' 4     |
2866   1573                         wait4                       ; wait YM to be ready       ' 4     |
2866   1573 00          >            NOP
2867   1574 02                      LD      (BC), A             ; restore state             ' 7     |
2868   1575             
2869   1575                         waitYMReady                 ; wait YM to be ready       ' 30    |
2869   1575 D9          >            EXX                     ;                           ' 4     | (4)
2869   1576 CB 7E       >            BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
2869   1578 C2 76 15    >            JP      NZ, .wait       ; wait while busy           ' 10    |
2869   157B D9          >            EXX                     ;                           ' 4     | (30)
2870   157C 36 86                   LD      (HL), $86           ; set reg num to YM         ' 10    |
2871   157E 1A                      LD      A, (DE)             ; get saved value           ' 7     | 62 (234)
2872   157F 1C                      INC     E                   ; next                      ' 4     |
2873   1580                         wait4                       ; wait YM to be ready       ' 4     |
2873   1580 00          >            NOP
2874   1581 02                      LD      (BC), A             ; restore state             ' 7     |
2875   1582             
2876   1582 D9                      EXX                         ;                           ' 4     | (238)
2877   1583             
2878   1583             .wait3
2879   1583 CB 7E                   BIT     7, (HL)             ; test YM ready bit         ' 12    |
2880   1585 C2 83 15                JP      NZ, .wait3          ; wait while busy           ' 10    | 22 (254+6)
2881   1588             
2882   1588 36 2A                   LD      (HL), $2A           ;                           ' 10    |
2883   158A 0A                      LD      A, (BC)             ;                           ' 7     |
2884   158B 03                      INC     BC                  ; *** sample output ****    ' 6     | 38 (44)
2885   158C CB 90                   RES     2, B                ;                           ' 8     |
2886   158E 12                      LD      (DE), A             ;                           ' 7     |
2887   158F             
2888   158F             .wait4
2889   158F CB 7E                   BIT     7, (HL)             ; test YM ready bit         ' 12    |
2890   1591 C2 8F 15                JP      NZ, .wait4          ; wait while busy           ' 10    | 22 (66)
2891   1594             
2892   1594 D9                      EXX                         ;                           ' 4     | (78)
2893   1595                         wait8                       ; sync                      ' 8     |
2893   1595 00          >            NOP
2893   1596 00          >            NOP
2894   1597             
2895   1597 36 88                   LD      (HL), $88           ; set reg num to YM         ' 10    |
2896   1599 1A                      LD      A, (DE)             ; get saved value           ' 7     |
2897   159A 1C                      INC     E                   ; next                      ' 4     | 32 (110)
2898   159B                         wait4                       ; wait YM to be ready       ' 4     |
2898   159B 00          >            NOP
2899   159C 02                      LD      (BC), A             ; restore state             ' 7     |
2900   159D             
2901   159D                         waitYMReady                 ; wait YM to be ready       ' 30    |
2901   159D D9          >            EXX                     ;                           ' 4     | (4)
2901   159E CB 7E       >            BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
2901   15A0 C2 9E 15    >            JP      NZ, .wait       ; wait while busy           ' 10    |
2901   15A3 D9          >            EXX                     ;                           ' 4     | (30)
2902   15A4 36 89                   LD      (HL), $89           ; set reg num to YM         ' 10    |
2903   15A6 1A                      LD      A, (DE)             ; get saved value           ' 7     | 62 (172)
2904   15A7 1C                      INC     E                   ; next                      ' 4     |
2905   15A8                         wait4                       ; wait YM to be ready       ' 4     |
2905   15A8 00          >            NOP
2906   15A9 02                      LD      (BC), A             ; restore state             ' 7     |
2907   15AA             
2908   15AA                         waitYMReady                 ; wait YM to be ready       ' 30    |
2908   15AA D9          >            EXX                     ;                           ' 4     | (4)
2908   15AB CB 7E       >            BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
2908   15AD C2 AB 15    >            JP      NZ, .wait       ; wait while busy           ' 10    |
2908   15B0 D9          >            EXX                     ;                           ' 4     | (30)
2909   15B1 36 8A                   LD      (HL), $8A           ; set reg num to YM         ' 10    |
2910   15B3 1A                      LD      A, (DE)             ; get saved value           ' 7     | 62 (234)
2911   15B4 1C                      INC     E                   ; next                      ' 4     |
2912   15B5                         wait4                       ; wait YM to be ready       ' 4     |
2912   15B5 00          >            NOP
2913   15B6 02                      LD      (BC), A             ; restore state             ' 7     |
2914   15B7             
2915   15B7 D9                      EXX                         ;                           ' 4     | (238)
2916   15B8             
2917   15B8             .wait5
2918   15B8 CB 7E                   BIT     7, (HL)             ; test YM ready bit         ' 12    |
2919   15BA C2 B8 15                JP      NZ, .wait5          ; wait while busy           ' 10    | 22 (254+6)
2920   15BD             
2921   15BD 36 2A                   LD      (HL), $2A           ;                           ' 10    |
2922   15BF 0A                      LD      A, (BC)             ;                           ' 7     |
2923   15C0 03                      INC     BC                  ; *** sample output ****    ' 6     | 38 (44)
2924   15C1 CB 90                   RES     2, B                ;                           ' 8     |
2925   15C3 12                      LD      (DE), A             ;                           ' 7     |
2926   15C4             
2927   15C4             .wait6
2928   15C4 CB 7E                   BIT     7, (HL)             ; test YM ready bit         ' 12    |
2929   15C6 C2 C4 15                JP      NZ, .wait6          ; wait while busy           ' 10    | 22 (66)
2930   15C9             
2931   15C9 D9                      EXX                         ;                           ' 4     | (78)
2932   15CA                         wait8                       ; sync                      ' 8     |
2932   15CA 00          >            NOP
2932   15CB 00          >            NOP
2933   15CC             
2934   15CC 36 8C                   LD      (HL), $8C           ; set reg num to YM         ' 10    |
2935   15CE 1A                      LD      A, (DE)             ; get saved value           ' 7     |
2936   15CF 1C                      INC     E                   ; next                      ' 4     | 32 (110)
2937   15D0                         wait4                       ; wait YM to be ready       ' 4     |
2937   15D0 00          >            NOP
2938   15D1 02                      LD      (BC), A             ; restore state             ' 7     |
2939   15D2             
2940   15D2                         waitYMReady                 ; wait YM to be ready       ' 30    |
2940   15D2 D9          >            EXX                     ;                           ' 4     | (4)
2940   15D3 CB 7E       >            BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
2940   15D5 C2 D3 15    >            JP      NZ, .wait       ; wait while busy           ' 10    |
2940   15D8 D9          >            EXX                     ;                           ' 4     | (30)
2941   15D9 36 8D                   LD      (HL), $8D           ; set reg num to YM         ' 10    |
2942   15DB 1A                      LD      A, (DE)             ; get saved value           ' 7     | 62 (172)
2943   15DC 1C                      INC     E                   ; next                      ' 4     |
2944   15DD                         wait4                       ; wait YM to be ready       ' 4     |
2944   15DD 00          >            NOP
2945   15DE 02                      LD      (BC), A             ; restore state             ' 7     |
2946   15DF             
2947   15DF                         waitYMReady                 ; wait YM to be ready       ' 30    |
2947   15DF D9          >            EXX                     ;                           ' 4     | (4)
2947   15E0 CB 7E       >            BIT     7, (HL)         ; test YM ready bit         ' 12    | (22)
2947   15E2 C2 E0 15    >            JP      NZ, .wait       ; wait while busy           ' 10    |
2947   15E5 D9          >            EXX                     ;                           ' 4     | (30)
2948   15E6 36 8E                   LD      (HL), $8E           ; set reg num to YM         ' 10    |
2949   15E8 1A                      LD      A, (DE)             ; get saved value           ' 7     | 62 (234)
2950   15E9 1C                      INC     E                   ; next                      ' 4     |
2951   15EA                         wait4                       ; wait YM to be ready       ' 4     |
2951   15EA 00          >            NOP
2952   15EB 02                      LD      (BC), A             ; restore state             ' 7     |
2953   15EC             
2954   15EC C9                      RET                         ; done                      ' 10    | (244)
2955   15ED             
2956   15ED             
2957   15ED             ; loadPSGState
2958   15ED             ; ------------
2959   15ED             ; PSGPORT     ->  HL
2960   15ED             ; reg source  ->  DE  -> ?
2961   15ED             ;
2962   15ED             ; load the PSG env state
2963   15ED             ; 94 cycles
2964   15ED             
2965   15ED             loadPSGState
2966   15ED             
2967   15ED 1A                      LD      A, (DE)             ; get saved value           ' 7     |
2968   15EE 1C                      INC     E                   ; next                      ' 4     | (21)
2969   15EF 77                      LD      (HL), A             ; PSG restore channel 0 env ' 10    |
2970   15F0             
2971   15F0 1A                      LD      A, (DE)             ; get saved value           ' 7     |
2972   15F1 1C                      INC     E                   ; next                      ' 4     | 21 (42)
2973   15F2 77                      LD      (HL), A             ; PSG restore channel 1 env ' 10    |
2974   15F3             
2975   15F3 1A                      LD      A, (DE)             ; get saved value           ' 7     |
2976   15F4 1C                      INC     E                   ; next                      ' 4     | 21 (63)
2977   15F5 77                      LD      (HL), A             ; PSG restore channel 2 env ' 10    |
2978   15F6             
2979   15F6 1A                      LD      A, (DE)             ; get saved value           ' 7     |
2980   15F7 1C                      INC     E                   ; next                      ' 4     | 21 (84)
2981   15F8 77                      LD      (HL), A             ; PSG restore channel 3 env ' 10    |
2982   15F9             
2983   15F9 C9                      RET                         ; done                      ' 10    | (94)
2984   15FA             
2985   15FA             
2986   15FA             ; ##############################  jump table  ################################
2987   15FA             
2988   15FA 00                      BLOCK   $1600-$
2989   1600             
2990   1600 4C 0A                   DW      com_next_frame                                                                  ; 00
2991   1602             
2992   1602                         DW      com_null, com_null, com_null                                                    ; 01-03
2992   1602 B811B811B811
2993   1608                         DW      com_null, com_null, com_null, com_null                                          ; 04-07
2993   1608 B811B811B811B811
2994   1610                         DW      com_null, com_null, com_null, com_null                                          ; 08-0B
2994   1610 B811B811B811B811
2995   1618                         DW      com_null, com_null, com_null, com_null                                          ; 0C-0F
2995   1618 B811B811B811B811
2996   1620             
2997   1620                         DW      com_psg_tone_w0, com_psg_tone_w1, com_psg_tone_w2, com_psg_tone_w3              ; 10-13
2997   1620 4F0A5C0A6A0A770A
2998   1628                         DW      com_psg_tone_w4, com_psg_tone_w5, com_psg_tone_w6, com_psg_tone_w7              ; 14-17
2998   1628 870A930AA10AAB0A
2999   1630                         DW      com_psg_env_w0, com_psg_env_w1, com_psg_env_w2, com_psg_env_w3                  ; 18-1B
2999   1630 CC0ADF0AEB0A040B
3000   1638                         DW      com_null, com_null, com_null, com_null                                          ; 1C-1F
3000   1638 B811B811B811B811
3001   1640             
3002   1640                         DW      com_ym_port0_w0, com_ym_port0_w1, com_ym_port0_w2, com_ym_port0_w3              ; 20-23
3002   1640 500B610B6A0B7C0B
3003   1648                         DW      com_ym_port0_w4, com_ym_port0_w5, com_ym_port0_w6, com_ym_port0_w7              ; 24-27
3003   1648 850B980BAA0BB30B
3004   1650                         DW      com_ym_port0_w8, com_ym_port0_w9, com_ym_port0_wA, com_ym_port0_wB              ; 28-2B
3004   1650 C60BD80BE10BF40B
3005   1658                         DW      com_ym_port0_wC, com_ym_port0_wD, com_ym_port0_wE, com_ym_port0_wF              ; 2C-2F
3005   1658 060C0F0C210C320C
3006   1660             
3007   1660                         DW      com_ym_port2_w0, com_ym_port2_w1, com_ym_port2_w2, com_ym_port2_w3              ; 30-33
3007   1660 3B0C4C0C550C670C
3008   1668                         DW      com_ym_port2_w4, com_ym_port2_w5, com_ym_port2_w6, com_ym_port2_w7              ; 34-37
3008   1668 700C830C950C9E0C
3009   1670                         DW      com_ym_port2_w8, com_ym_port2_w9, com_ym_port2_wA, com_ym_port2_wB              ; 38-3B
3009   1670 B10CC30CCC0CDF0C
3010   1678                         DW      com_ym_port2_wC, com_ym_port2_wD, com_ym_port2_wE, com_ym_port2_wF              ; 3C-3F
3010   1678 F10CFA0C0C0D1D0D
3011   1680             
3012   1680                         DW      com_ym_key_w0, com_ym_key_w1, com_ym_key_w2, com_ym_key_w3                      ; 40-43
3012   1680 700E830E8F0EA00E
3013   1688                         DW      com_ym_key_w4, com_ym_key_w5, com_null, com_null                                ; 44-47
3013   1688 B40EC30EB811B811
3014   1690                         DW      com_null, com_null, com_null, com_null                                          ; 48-4B
3014   1690 B811B811B811B811
3015   1698                         DW      com_null, com_null, com_null, com_null                                          ; 4C-4F
3015   1698 B811B811B811B811
3016   16A0             
3017   16A0                         DW      com_pcm_p0_ch0, com_pcm_p0_ch1, com_pcm_p0_ch2, com_pcm_p0_ch3                  ; 50-53
3017   16A0 570F6B0F7F0F930F
3018   16A8                         DW      com_pcm_p1_ch0, com_pcm_p1_ch1, com_pcm_p1_ch2, com_pcm_p1_ch3                  ; 54-57
3018   16A8 5C0F700F840F980F
3019   16B0                         DW      com_pcm_p2_ch0, com_pcm_p2_ch1, com_pcm_p2_ch2, com_pcm_p2_ch3                  ; 58-5B
3019   16B0 610F750F890F9D0F
3020   16B8                         DW      com_pcm_p3_ch0, com_pcm_p3_ch1, com_pcm_p3_ch2, com_pcm_p3_ch3                  ; 5C-5F
3020   16B8 660F7A0F8E0FA20F
3021   16C0             
3022   16C0                         DW      com_state_w0, com_state_w1, com_state_w2, com_state_w3                          ; 60-63
3022   16C0 63106D107B108A10
3023   16C8                         DW      com_state_w4, com_state_w5, com_state_w6, com_state_w7                          ; 64-67
3023   16C8 9310AC10B910C610
3024   16D0                         DW      com_state_w8, com_state_w9, com_state_wA, com_state_wB                          ; 68-6B
3024   16D0 D210DE10E8100311
3025   16D8                         DW      com_state_wC, com_state_wD, com_state_wE, com_state_wF                          ; 6C-6F
3025   16D8 10111D1129113511
3026   16E0             
3027   16E0                         DW      com_null, com_null, com_null, com_null                                          ; 70-74
3027   16E0 B811B811B811B811
3028   16E8                         DW      com_null, com_null, com_null, com_null                                          ; 74-77
3028   16E8 B811B811B811B811
3029   16F0                         DW      com_null, com_null, com_null, com_null                                          ; 78-7B
3029   16F0 B811B811B811B811
3030   16F8 B8 11                   DW      com_null                                                                        ; 7C
3031   16FA             
3032   16FA C4 11                   DW      com_extra_frm                                                                   ; 7D
3033   16FC EB 11                   DW      com_loop                                                                        ; 7E
3034   16FE 28 12                   DW      com_end                                                                         ; 7F
3035   1700             
3036   1700             
3037   1700                         END
